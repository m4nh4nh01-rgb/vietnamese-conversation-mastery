<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnamese Conversation Mastery</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .scenario-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .scenario-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
        }
        .blank-input {
            border-bottom: 2px solid #e5e7eb;
            transition: border-color 0.2s;
        }
        .blank-input:focus {
            outline: none;
            border-bottom-color: #4f46e5;
        }
        .blank-input.correct {
            border-bottom-color: #10b981;
            background-color: #d1fae5;
        }
        .blank-input.incorrect {
            border-bottom-color: #ef4444;
            background-color: #fee2e2;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .progress-ring {
            transition: stroke-dashoffset 0.5s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== DATA STRUCTURES ====================
        
        // Spaced Repetition Algorithm (SM-2)
        class SpacedRepetition {
            static calculateNextReview(quality, repetitions, easeFactor, interval) {
                let newEaseFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (newEaseFactor < 1.3) newEaseFactor = 1.3;

                let newRepetitions = repetitions;
                let newInterval = interval;

                if (quality < 3) {
                    newRepetitions = 0;
                    newInterval = 1;
                } else {
                    newRepetitions += 1;
                    if (newRepetitions === 1) {
                        newInterval = 1;
                    } else if (newRepetitions === 2) {
                        newInterval = 6;
                    } else {
                        newInterval = Math.round(interval * newEaseFactor);
                    }
                }

                const nextReviewDate = new Date();
                nextReviewDate.setMinutes(nextReviewDate.getMinutes() + newInterval);

                return {
                    easeFactor: newEaseFactor,
                    repetitions: newRepetitions,
                    interval: newInterval,
                    nextReview: nextReviewDate.toISOString()
                };
            }
        }

        // Storage Manager
        class StorageManager {
            static KEYS = {
                PHRASES: 'viet_phrases',
                SIMULATIONS: 'viet_simulations',
                WEEKLY_STATS: 'viet_weekly_stats',
                SRS_QUEUE: 'viet_srs_queue'
            };

            static getPhrases() {
                const data = localStorage.getItem(this.KEYS.PHRASES);
                return data ? JSON.parse(data) : {};
            }

            static savePhraseProgress(phraseId, result) {
                const phrases = this.getPhrases();
                const existing = phrases[phraseId] || {
                    easeFactor: 2.5,
                    repetitions: 0,
                    interval: 0,
                    nextReview: new Date().toISOString(),
                    attempts: 0,
                    correct: 0
                };

                const quality = result.correct ? 5 : Math.floor((result.similarity || 0) * 5);
                const updated = SpacedRepetition.calculateNextReview(
                    quality,
                    existing.repetitions,
                    existing.easeFactor,
                    existing.interval
                );

                phrases[phraseId] = {
                    ...updated,
                    lastReview: new Date().toISOString(),
                    attempts: existing.attempts + 1,
                    correct: existing.correct + (result.correct ? 1 : 0),
                    phrase: result.phrase,
                    translation: result.translation,
                    scenario: result.scenario
                };

                localStorage.setItem(this.KEYS.PHRASES, JSON.stringify(phrases));
                return phrases[phraseId];
            }

            static saveSimulation(scenarioId, simulationData) {
                const simulations = JSON.parse(localStorage.getItem(this.KEYS.SIMULATIONS) || '{}');
                if (!simulations[scenarioId]) {
                    simulations[scenarioId] = [];
                }
                simulations[scenarioId].push({
                    ...simulationData,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem(this.KEYS.SIMULATIONS, JSON.stringify(simulations));
            }

            static getSimulations(scenarioId) {
                const simulations = JSON.parse(localStorage.getItem(this.KEYS.SIMULATIONS) || '{}');
                return simulations[scenarioId] || [];
            }

            static getWeakPhrases(limit = 10) {
                const phrases = this.getPhrases();
                const weak = Object.entries(phrases)
                    .filter(([_, data]) => {
                        const accuracy = data.attempts > 0 ? data.correct / data.attempts : 0;
                        return accuracy < 0.7 || data.repetitions < 2;
                    })
                    .sort((a, b) => {
                        const accA = a[1].attempts > 0 ? a[1].correct / a[1].attempts : 0;
                        const accB = b[1].attempts > 0 ? b[1].correct / b[1].attempts : 0;
                        return accA - accB;
                    })
                    .slice(0, limit);
                
                return weak.map(([id, data]) => ({ id, ...data }));
            }

            static getWeeklyStats() {
                const data = localStorage.getItem(this.KEYS.WEEKLY_STATS);
                if (!data) return this.initializeWeeklyStats();
                return JSON.parse(data);
            }

            static initializeWeeklyStats() {
                const stats = {
                    scenariosCompleted: 0,
                    avgResponseTime: 0,
                    politenessAccuracy: 0,
                    recoveryScore: 0,
                    weekStart: new Date().toISOString()
                };
                localStorage.setItem(this.KEYS.WEEKLY_STATS, JSON.stringify(stats));
                return stats;
            }

            static updateWeeklyStats(update) {
                const stats = this.getWeeklyStats();
                const updated = { ...stats, ...update };
                localStorage.setItem(this.KEYS.WEEKLY_STATS, JSON.stringify(updated));
                return updated;
            }

            static getSRSQueue() {
                const phrases = this.getPhrases();
                const now = new Date();
                const due = [];

                for (const [id, data] of Object.entries(phrases)) {
                    const nextReview = new Date(data.nextReview);
                    if (nextReview <= now) {
                        due.push({ id, ...data });
                    }
                }

                return due;
            }
        }

        // Scenarios Data
        const TRAVEL_SCENARIOS = [
            {
                id: 'reconnecting',
                title: 'Gáº·p láº¡i báº¡n cÅ©',
                description: 'Reconnecting and Social Catch-Ups',
                icon: 'ðŸ‘‹',
                difficulty: 'intermediate',
                objectives: ['Catch up with old friends', 'Discuss work-life changes', 'Express opinions on lifestyle choices'],
                estimatedTime: '10 min'
            },
            {
                id: 'workplace_meeting',
                title: 'Há»p nhÃ³m cÃ´ng viá»‡c',
                description: 'Workplace Meetings and Professional Communication',
                icon: 'ðŸ’¼',
                difficulty: 'intermediate',
                objectives: ['Discuss project progress', 'Propose and evaluate strategies', 'Assign responsibilities professionally'],
                estimatedTime: '10 min'
            },
            {
                id: 'restaurant_order',
                title: 'NhÃ  hÃ ng - Gá»i mÃ³n',
                description: 'Ordering food at a restaurant',
                icon: 'ðŸœ',
                difficulty: 'intermediate',
                objectives: ['Order dishes politely', 'Ask about ingredients', 'Request modifications'],
                estimatedTime: '12 min'
            },
            {
                id: 'taxi_directions',
                title: 'Taxi - Chá»‰ Ä‘Æ°á»ng',
                description: 'Giving directions to a taxi driver',
                icon: 'ðŸš•',
                difficulty: 'intermediate',
                objectives: ['State destination clearly', 'Negotiate price', 'Handle route changes'],
                estimatedTime: '7 min'
            },
            {
                id: 'market_shopping',
                title: 'Chá»£ - Mua sáº¯m',
                description: 'Shopping at a local market',
                icon: 'ðŸ›’',
                difficulty: 'intermediate',
                objectives: ['Bargain prices', 'Ask about products', 'Complete transactions'],
                estimatedTime: '15 min'
            },
            {
                id: 'tourist_info',
                title: 'Du lá»‹ch - Há»i thÃ´ng tin',
                description: 'Asking for tourist information',
                icon: 'ðŸ—ºï¸',
                difficulty: 'intermediate',
                objectives: ['Request recommendations', 'Ask directions', 'Understand local customs'],
                estimatedTime: '10 min'
            }
        ];

        // Sample Dialogues Database
        const SAMPLE_DIALOGUES = {
            'reconnecting': {
                scenario: 'Gáº·p láº¡i báº¡n cÅ©',
                context: 'Anna runs into her old friend Minh and they catch up after not seeing each other for three years.',
                dialogue: [
                    { speaker: 'Minh', text: 'á»¦a, Anna pháº£i khÃ´ng? LÃ¢u quÃ¡ khÃ´ng gáº·p!' },
                    { speaker: 'Anna', text: 'Trá»i Æ¡i, Minh! ÄÃºng rá»“i, cÅ©ng pháº£i ba nÄƒm rá»“i nhá»‰?' },
                    { speaker: 'Minh', text: 'á»ª, tá»« khi báº¡n chuyá»ƒn cÃ´ng ty lÃ  mÃ¬nh khÃ´ng gáº·p láº¡i. Dáº¡o nÃ y báº¡n tháº¿ nÃ o?' },
                    { speaker: 'Anna', text: 'MÃ¬nh khÃ¡ báº­n, vÃ¬ cÃ´ng viá»‡c má»›i Ä‘Ã²i há»i nhiá»u [BLANK1] hÆ¡n nÃªn mÃ¬nh thÆ°á»ng xuyÃªn pháº£i [BLANK2].' },
                    { speaker: 'Minh', text: 'Nghe cÃ³ váº» Ã¡p lá»±c Ä‘áº¥y. NhÆ°ng cháº¯c báº¡n cÅ©ng há»c Ä‘Æ°á»£c nhiá»u thá»© má»›i?' },
                    { speaker: 'Anna', text: 'ÄÃºng váº­y. Máº·c dÃ¹ cÃ´ng viá»‡c [BLANK3] nhÆ°ng mÃ¬nh cáº£m tháº¥y [BLANK4] hÆ¡n ráº¥t nhiá»u.' },
                    { speaker: 'Minh', text: 'Váº­y thÃ¬ tá»‘t rá»“i. CÃ²n mÃ¬nh thÃ¬ chuyá»ƒn sang lÃ m freelance, nÃªn thá»i gian [BLANK5] hÆ¡n trÆ°á»›c.' },
                    { speaker: 'Anna', text: 'Tháº­t Ã ? KhÃ´ng nhá»¯ng linh hoáº¡t mÃ  cÃ²n [BLANK6] ná»¯a Ä‘Ãºng khÃ´ng?' },
                    { speaker: 'Minh', text: 'á»ª, tá»± do thÃ¬ cÃ³, nhÆ°ng [BLANK7] láº¡i khÃ´ng [BLANK8]. VÃ¬ khÃ´ng cÃ³ lÆ°Æ¡ng cá»‘ Ä‘á»‹nh nÃªn mÃ¬nh pháº£i tá»± tÃ¬m khÃ¡ch hÃ ng.' },
                    { speaker: 'Anna', text: 'Nghe cÅ©ng khÃ¡ [BLANK9]. NhÆ°ng cháº¯c báº¡n thÃ­ch cáº£m giÃ¡c [BLANK10]?' },
                    { speaker: 'Minh', text: 'ÄÃºng lÃ  váº­y. TrÆ°á»›c Ä‘Ã¢y mÃ¬nh lÃ m vÄƒn phÃ²ng suá»‘t ngÃ y, [BLANK11] bÃ¢y giá» mÃ¬nh cÃ³ thá»ƒ lÃ m viá»‡c á»Ÿ quÃ¡n cÃ  phÃª hoáº·c á»Ÿ nhÃ .' },
                    { speaker: 'Anna', text: 'MÃ¬nh nhá»› há»“i Ä‘Ã³ báº¡n hay than lÃ  khÃ´ng cÃ³ thá»i gian cho gia Ä‘Ã¬nh. BÃ¢y giá» cháº¯c [BLANK12] rá»“i?' },
                    { speaker: 'Minh', text: 'Äá»¡ hÆ¡n nhiá»u. Máº·c dÃ¹ thu nháº­p giáº£m má»™t chÃºt nhÆ°ng mÃ¬nh cÃ³ thá»i gian Ä‘Æ°a con Ä‘i há»c vÃ  táº­p thá»ƒ dá»¥c thÆ°á»ng xuyÃªn hÆ¡n.' },
                    { speaker: 'Anna', text: 'Nghe báº¡n nÃ³i mÃ¬nh cÅ©ng [BLANK13] vá» cuá»™c sá»‘ng cá»§a mÃ¬nh. CÃ³ láº½ mÃ¬nh nÃªn [BLANK14] giá»¯a cÃ´ng viá»‡c vÃ  cuá»™c sá»‘ng tá»‘t hÆ¡n.' },
                    { speaker: 'Minh', text: 'Theo mÃ¬nh thÃ¬ má»—i ngÆ°á»i cÃ³ má»™t [BLANK15] khÃ¡c nhau. Quan trá»ng lÃ  mÃ¬nh cáº£m tháº¥y [BLANK16] vá»›i lá»±a chá»n cá»§a mÃ¬nh.' },
                    { speaker: 'Anna', text: 'Báº¡n nÃ³i Ä‘Ãºng. DÃ¹ sao thÃ¬ gáº·p láº¡i báº¡n hÃ´m nay mÃ¬nh ráº¥t vui.' },
                    { speaker: 'Minh', text: 'MÃ¬nh cÅ©ng váº­y. Khi nÃ o ráº£nh thÃ¬ mÃ¬nh gáº·p nhau lÃ¢u hÆ¡n nhÃ©.' },
                    { speaker: 'Anna', text: 'Nháº¥t trÃ­. Láº§n sau mÃ¬nh sáº½ ká»ƒ cho báº¡n nghe ká»¹ hÆ¡n vá» [BLANK17] má»›i cá»§a mÃ¬nh.' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'trÃ¡ch nhiá»‡m',
                        translation: 'responsibility / responsibilities',
                        notes: '"TrÃ¡ch nhiá»‡m" = responsibility. "ÄÃ²i há»i nhiá»u trÃ¡ch nhiá»‡m" = demands a lot of responsibility.',
                        politeness: 'neutral',
                        category: 'work'
                    },
                    {
                        id: 'blank2',
                        answer: 'lÃ m thÃªm giá»',
                        translation: 'to work overtime / work extra hours',
                        notes: '"LÃ m thÃªm giá»" = to do overtime. "ThÆ°á»ng xuyÃªn" before it means "frequently/regularly".',
                        politeness: 'neutral',
                        category: 'work'
                    },
                    {
                        id: 'blank3',
                        answer: 'váº¥t váº£',
                        translation: 'tough / tiring / demanding',
                        notes: '"Váº¥t váº£" describes hard, exhausting work. Often used to acknowledge effort.',
                        politeness: 'neutral',
                        category: 'description'
                    },
                    {
                        id: 'blank4',
                        answer: 'trÆ°á»Ÿng thÃ nh',
                        translation: 'mature / grown / developed',
                        notes: '"TrÆ°á»Ÿng thÃ nh hÆ¡n" = more mature/grown. Used for personal development.',
                        politeness: 'neutral',
                        category: 'personal'
                    },
                    {
                        id: 'blank5',
                        answer: 'linh hoáº¡t',
                        translation: 'flexible',
                        notes: '"Linh hoáº¡t" = flexible. "Thá»i gian linh hoáº¡t" = flexible schedule/hours.',
                        politeness: 'neutral',
                        category: 'lifestyle'
                    },
                    {
                        id: 'blank6',
                        answer: 'tá»± do',
                        translation: 'free / freedom',
                        notes: '"Tá»± do" = freedom/free. Here used as an adjective meaning "free (to do as you wish)".',
                        politeness: 'neutral',
                        category: 'lifestyle'
                    },
                    {
                        id: 'blank7',
                        answer: 'thu nháº­p',
                        translation: 'income / earnings',
                        notes: '"Thu nháº­p" = income. "Thu nháº­p khÃ´ng á»•n Ä‘á»‹nh" = unstable income.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank8',
                        answer: 'á»•n Ä‘á»‹nh',
                        translation: 'stable / steady',
                        notes: '"á»”n Ä‘á»‹nh" = stable. Often paired with "thu nháº­p" (income) or "cÃ´ng viá»‡c" (job).',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank9',
                        answer: 'rá»§i ro',
                        translation: 'risky / risk',
                        notes: '"Rá»§i ro" = risk. "KhÃ¡ rá»§i ro" = quite risky. Used for financial or career risks.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank10',
                        answer: 'tá»± chá»§',
                        translation: 'autonomous / self-directed / in control',
                        notes: '"Tá»± chá»§" = self-directed/autonomous. "Cáº£m giÃ¡c tá»± chá»§" = feeling of being in control.',
                        politeness: 'neutral',
                        category: 'personal'
                    },
                    {
                        id: 'blank11',
                        answer: 'trong khi',
                        translation: 'while / whereas',
                        notes: '"Trong khi" = while/whereas. Used to contrast two situations.',
                        politeness: 'neutral',
                        category: 'grammar'
                    },
                    {
                        id: 'blank12',
                        answer: 'Ä‘á»¡ hÆ¡n',
                        translation: 'better / less difficult / more manageable',
                        notes: '"Äá»¡ hÆ¡n" = improved/better (literally "less hard than before"). Very common in casual speech.',
                        politeness: 'neutral',
                        category: 'comparison'
                    },
                    {
                        id: 'blank13',
                        answer: 'suy nghÄ© láº¡i',
                        translation: 'to reconsider / think again about',
                        notes: '"Suy nghÄ© láº¡i" = to reconsider/rethink. "Vá»" follows to mean "about".',
                        politeness: 'neutral',
                        category: 'reflection'
                    },
                    {
                        id: 'blank14',
                        answer: 'cÃ¢n báº±ng',
                        translation: 'balance / to balance',
                        notes: '"CÃ¢n báº±ng" = balance. "CÃ¢n báº±ng giá»¯a A vÃ  B" = balance between A and B.',
                        politeness: 'neutral',
                        category: 'lifestyle'
                    },
                    {
                        id: 'blank15',
                        answer: 'Æ°u tiÃªn',
                        translation: 'priority / priorities',
                        notes: '"Æ¯u tiÃªn" = priority. "Má»—i ngÆ°á»i cÃ³ má»™t Æ°u tiÃªn" = each person has different priorities.',
                        politeness: 'neutral',
                        category: 'values'
                    },
                    {
                        id: 'blank16',
                        answer: 'hÃ i lÃ²ng',
                        translation: 'satisfied / content / happy with',
                        notes: '"HÃ i lÃ²ng" = satisfied/content. "HÃ i lÃ²ng vá»›i" = satisfied with something.',
                        politeness: 'neutral',
                        category: 'values'
                    },
                    {
                        id: 'blank17',
                        answer: 'dá»± Ã¡n',
                        translation: 'project',
                        notes: '"Dá»± Ã¡n" = project. Used in professional and personal contexts.',
                        politeness: 'neutral',
                        category: 'work'
                    }
                ]
            },
            'workplace_meeting': {
                scenario: 'Há»p nhÃ³m cÃ´ng viá»‡c',
                context: 'A team meeting to update project progress and discuss the marketing strategy for a new product.',
                dialogue: [
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'HÃ´m nay chÃºng ta há»p Ä‘á»ƒ cáº­p nháº­t [BLANK1] dá»± Ã¡n vÃ  tháº£o luáº­n vá» [BLANK2] quáº£ng bÃ¡ sáº£n pháº©m má»›i.' },
                    { speaker: 'Anna', text: 'Theo em, tiáº¿n Ä‘á»™ nhÃ¬n chung khÃ¡ tá»‘t, nhÆ°ng váº«n cÃ²n má»™t sá»‘ váº¥n Ä‘á» cáº§n giáº£i quyáº¿t.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Cá»¥ thá»ƒ lÃ  váº¥n Ä‘á» gÃ¬?' },
                    { speaker: 'Anna', text: 'VÃ¬ [BLANK3] quáº£ng cÃ¡o bá»‹ cáº¯t giáº£m nÃªn [BLANK4] khÃ¡ch hÃ ng tháº¥p hÆ¡n [BLANK5].' },
                    { speaker: 'Minh', text: 'TÃ´i Ä‘á»“ng Ã½ má»™t pháº§n. Tuy nhiÃªn, tÃ´i nghÄ© chÃºng ta cÃ³ thá»ƒ [BLANK6] kÃªnh truyá»n thÃ´ng hiá»‡n táº¡i thay vÃ¬ tÄƒng ngÃ¢n sÃ¡ch.' },
                    { speaker: 'Anna', text: 'Ã kiáº¿n Ä‘Ã³ cÅ©ng [BLANK7]. Máº·c dÃ¹ ngÃ¢n sÃ¡ch [BLANK8] nhÆ°ng náº¿u chÃºng ta táº­p trung vÃ o khÃ¡ch hÃ ng má»¥c tiÃªu thÃ¬ hiá»‡u quáº£ cÃ³ thá»ƒ cao hÆ¡n.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Váº­y ai sáº½ [BLANK9] phÃ¢n tÃ­ch láº¡i nhÃ³m khÃ¡ch hÃ ng má»¥c tiÃªu?' },
                    { speaker: 'Minh', text: 'TÃ´i cÃ³ thá»ƒ phá»¥ trÃ¡ch pháº§n Ä‘Ã³, nhÆ°ng tÃ´i cáº§n thÃªm dá»¯ liá»‡u tá»« bá»™ pháº­n nghiÃªn cá»©u thá»‹ trÆ°á»ng.' },
                    { speaker: 'Anna', text: 'KhÃ´ng nhá»¯ng cáº§n dá»¯ liá»‡u má»›i mÃ  chÃºng ta cÃ²n nÃªn xem láº¡i [BLANK10] tá»« chiáº¿n dá»‹ch trÆ°á»›c.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'ÄÃºng rá»“i. Pháº£n há»“i cá»§a khÃ¡ch hÃ ng khÃ¡ tÃ­ch cá»±c, tuy nhiÃªn [BLANK11] váº«n chÆ°a cao.' },
                    { speaker: 'Minh', text: 'CÃ³ láº½ váº¥n Ä‘á» náº±m á»Ÿ [BLANK12] truyá»n thÃ´ng chÆ°a Ä‘á»§ rÃµ rÃ ng.' },
                    { speaker: 'Anna', text: 'TÃ´i nghÄ© lÃ  chÃºng ta nÃªn [BLANK13] ná»™i dung theo hÆ°á»›ng Ä‘Æ¡n giáº£n vÃ  trá»±c tiáº¿p hÆ¡n.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Náº¿u thay Ä‘á»•i thÃ´ng Ä‘iá»‡p, chÃºng ta cáº§n Ä‘áº£m báº£o ráº±ng hÃ¬nh áº£nh thÆ°Æ¡ng hiá»‡u váº«n [BLANK14].' },
                    { speaker: 'Minh', text: 'TÃ´i hoÃ n toÃ n Ä‘á»“ng Ã½. Máº·c dÃ¹ cáº§n sÃ¡ng táº¡o nhÆ°ng khÃ´ng nÃªn lÃ m máº¥t [BLANK15] thÆ°Æ¡ng hiá»‡u.' },
                    { speaker: 'Anna', text: 'Váº­y bÆ°á»›c tiáº¿p theo lÃ  gÃ¬ áº¡?' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Minh phÃ¢n tÃ­ch láº¡i nhÃ³m khÃ¡ch hÃ ng, Anna Ä‘iá»u chá»‰nh ná»™i dung thÃ´ng Ä‘iá»‡p. Tuáº§n sau chÃºng ta sáº½ há»p láº¡i Ä‘á»ƒ [BLANK16] káº¿t quáº£.' },
                    { speaker: 'Anna', text: 'Dáº¡, tÃ´i sáº½ hoÃ n thÃ nh trÆ°á»›c thá»© SÃ¡u Ä‘á»ƒ cáº£ nhÃ³m cÃ³ thá»i gian xem láº¡i.' },
                    { speaker: 'Minh', text: 'Náº¿u cÃ³ khÃ³ khÄƒn gÃ¬, tÃ´i sáº½ [BLANK17] thÃªm vá»›i anh trÆ°á»›c khi Ä‘Æ°a ra [BLANK18].' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'tiáº¿n Ä‘á»™',
                        translation: 'progress / timeline',
                        notes: '"Tiáº¿n Ä‘á»™" = progress or schedule. "Cáº­p nháº­t tiáº¿n Ä‘á»™" = to update on progress. Common in professional meetings.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank2',
                        answer: 'chiáº¿n lÆ°á»£c',
                        translation: 'strategy',
                        notes: '"Chiáº¿n lÆ°á»£c" = strategy. "Chiáº¿n lÆ°á»£c quáº£ng bÃ¡" = promotion/marketing strategy.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank3',
                        answer: 'ngÃ¢n sÃ¡ch',
                        translation: 'budget',
                        notes: '"NgÃ¢n sÃ¡ch" = budget. "NgÃ¢n sÃ¡ch bá»‹ cáº¯t giáº£m" = budget was cut/reduced.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank4',
                        answer: 'pháº¡m vi tiáº¿p cáº­n',
                        translation: 'reach / scope of reach',
                        notes: '"Pháº¡m vi tiáº¿p cáº­n" = reach (e.g. how many customers you reach). Common in marketing contexts.',
                        politeness: 'neutral',
                        category: 'marketing'
                    },
                    {
                        id: 'blank5',
                        answer: 'dá»± kiáº¿n',
                        translation: 'expected / projected / planned',
                        notes: '"Dá»± kiáº¿n" = expected/projected. "Tháº¥p hÆ¡n dá»± kiáº¿n" = lower than expected.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank6',
                        answer: 'tá»‘i Æ°u hÃ³a',
                        translation: 'to optimize',
                        notes: '"Tá»‘i Æ°u hÃ³a" = to optimize. Used in tech, marketing, and business contexts.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank7',
                        answer: 'há»£p lÃ½',
                        translation: 'reasonable / logical / sensible',
                        notes: '"Há»£p lÃ½" = reasonable/makes sense. "Ã kiáº¿n Ä‘Ã³ cÅ©ng há»£p lÃ½" = That idea is also reasonable.',
                        politeness: 'neutral',
                        category: 'evaluation'
                    },
                    {
                        id: 'blank8',
                        answer: 'háº¡n cháº¿',
                        translation: 'limited / restricted',
                        notes: '"Háº¡n cháº¿" = limited/restricted. "NgÃ¢n sÃ¡ch háº¡n cháº¿" = limited budget. Also a noun meaning limitation.',
                        politeness: 'neutral',
                        category: 'description'
                    },
                    {
                        id: 'blank9',
                        answer: 'chá»‹u trÃ¡ch nhiá»‡m',
                        translation: 'to be responsible for / take responsibility',
                        notes: '"Chá»‹u trÃ¡ch nhiá»‡m" = to be in charge of / responsible for. Used to assign tasks formally.',
                        politeness: 'neutral',
                        category: 'professional'
                    },
                    {
                        id: 'blank10',
                        answer: 'pháº£n há»“i',
                        translation: 'feedback / response',
                        notes: '"Pháº£n há»“i" = feedback or response. "Xem láº¡i pháº£n há»“i" = review feedback.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank11',
                        answer: 'tá»· lá»‡ chuyá»ƒn Ä‘á»•i',
                        translation: 'conversion rate',
                        notes: '"Tá»· lá»‡ chuyá»ƒn Ä‘á»•i" = conversion rate. Key metric in marketing/sales.',
                        politeness: 'neutral',
                        category: 'marketing'
                    },
                    {
                        id: 'blank12',
                        answer: 'thÃ´ng Ä‘iá»‡p',
                        translation: 'message / messaging',
                        notes: '"ThÃ´ng Ä‘iá»‡p" = message or brand messaging. "ThÃ´ng Ä‘iá»‡p truyá»n thÃ´ng" = communications message.',
                        politeness: 'neutral',
                        category: 'marketing'
                    },
                    {
                        id: 'blank13',
                        answer: 'Ä‘iá»u chá»‰nh',
                        translation: 'to adjust / to revise',
                        notes: '"Äiá»u chá»‰nh" = to adjust/tweak. "Äiá»u chá»‰nh ná»™i dung" = revise the content.',
                        politeness: 'neutral',
                        category: 'action'
                    },
                    {
                        id: 'blank14',
                        answer: 'nháº¥t quÃ¡n',
                        translation: 'consistent',
                        notes: '"Nháº¥t quÃ¡n" = consistent. "HÃ¬nh áº£nh thÆ°Æ¡ng hiá»‡u váº«n nháº¥t quÃ¡n" = brand image remains consistent.',
                        politeness: 'neutral',
                        category: 'branding'
                    },
                    {
                        id: 'blank15',
                        answer: 'báº£n sáº¯c',
                        translation: 'identity / character / essence',
                        notes: '"Báº£n sáº¯c" = identity/essence. "Báº£n sáº¯c thÆ°Æ¡ng hiá»‡u" = brand identity.',
                        politeness: 'neutral',
                        category: 'branding'
                    },
                    {
                        id: 'blank16',
                        answer: 'Ä‘Ã¡nh giÃ¡',
                        translation: 'to evaluate / to assess / review',
                        notes: '"ÄÃ¡nh giÃ¡" = to evaluate/assess. "ÄÃ¡nh giÃ¡ káº¿t quáº£" = evaluate results.',
                        politeness: 'neutral',
                        category: 'evaluation'
                    },
                    {
                        id: 'blank17',
                        answer: 'trao Ä‘á»•i',
                        translation: 'to discuss / to exchange ideas',
                        notes: '"Trao Ä‘á»•i" = to discuss/exchange. More collaborative than "nÃ³i chuyá»‡n". Common in professional settings.',
                        politeness: 'neutral',
                        category: 'professional'
                    },
                    {
                        id: 'blank18',
                        answer: 'quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng',
                        translation: 'final decision',
                        notes: '"Quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng" = final decision. "ÄÆ°a ra quyáº¿t Ä‘á»‹nh" = to make/give a decision.',
                        politeness: 'neutral',
                        category: 'professional'
                    }
                ]
            },
            'restaurant_order': {
                scenario: 'NhÃ  hÃ ng - Gá»i mÃ³n',
                context: 'You are at a local Vietnamese restaurant ordering phá»Ÿ and drinks.',
                dialogue: [
                    { speaker: 'Phá»¥c vá»¥', text: 'Xin chÃ o! [BLANK1] áº¡?' },
                    { speaker: 'Báº¡n', text: 'ChÃ o chá»‹. [BLANK2] vÃ  má»™t ly nÆ°á»›c chanh.' },
                    { speaker: 'Phá»¥c vá»¥', text: 'VÃ¢ng áº¡. Phá»Ÿ bÃ² hay phá»Ÿ gÃ  áº¡?' },
                    { speaker: 'Báº¡n', text: '[BLANK3].' },
                    { speaker: 'Phá»¥c vá»¥', text: 'Dáº¡. Báº¡n Äƒn cay khÃ´ng áº¡?' },
                    { speaker: 'Báº¡n', text: '[BLANK4].' },
                    { speaker: 'Phá»¥c vá»¥', text: 'VÃ¢ng áº¡. MÃ³n sáº½ cÃ³ trong 10 phÃºt ná»¯a nhÃ©!' },
                    { speaker: 'Báº¡n', text: '[BLANK5]!' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'Báº¡n dÃ¹ng gÃ¬',
                        translation: 'What would you like?',
                        notes: 'Common way servers ask what you want to order. "DÃ¹ng" = to use/have/eat',
                        politeness: 'polite',
                        category: 'greeting'
                    },
                    {
                        id: 'blank2',
                        answer: 'Cho tÃ´i má»™t tÃ´ phá»Ÿ',
                        translation: 'Give me one bowl of phá»Ÿ',
                        notes: '"Cho tÃ´i" = give me, "má»™t tÃ´" = one bowl. Very common ordering phrase',
                        politeness: 'neutral',
                        category: 'ordering'
                    },
                    {
                        id: 'blank3',
                        answer: 'Phá»Ÿ bÃ² áº¡',
                        translation: 'Beef phá»Ÿ',
                        notes: '"Phá»Ÿ bÃ²" = beef phá»Ÿ, "phá»Ÿ gÃ " = chicken phá»Ÿ. "áº " adds politeness',
                        politeness: 'polite',
                        category: 'responding'
                    },
                    {
                        id: 'blank4',
                        answer: 'KhÃ´ng cay nhÃ©',
                        translation: 'Not spicy please',
                        notes: '"Cay" = spicy. "NhÃ©" is a soft request particle. Add "má»™t chÃºt" for "a little spicy"',
                        politeness: 'polite',
                        category: 'preference'
                    },
                    {
                        id: 'blank5',
                        answer: 'Cáº£m Æ¡n chá»‹',
                        translation: 'Thank you',
                        notes: '"Chá»‹" when thanking a woman, "anh" for a man. Shows respect to service staff',
                        politeness: 'polite',
                        category: 'gratitude'
                    }
                ]
            },
            'taxi_directions': {
                scenario: 'Taxi - Chá»‰ Ä‘Æ°á»ng',
                context: 'You are taking a taxi from your hotel to Ben Thanh Market.',
                dialogue: [
                    { speaker: 'TÃ i xáº¿', text: 'ChÃ o báº¡n! [BLANK1]?' },
                    { speaker: 'Báº¡n', text: '[BLANK2] Báº¿n ThÃ nh.' },
                    { speaker: 'TÃ i xáº¿', text: 'ÄÆ°á»£c rá»“i. Báº¿n ThÃ nh Market pháº£i khÃ´ng?' },
                    { speaker: 'Báº¡n', text: 'VÃ¢ng, Ä‘Ãºng rá»“i. [BLANK3]?' },
                    { speaker: 'TÃ i xáº¿', text: 'Khoáº£ng 20 phÃºt thÃ´i, náº¿u Ä‘Æ°á»ng khÃ´ng Ä‘Ã´ng.' },
                    { speaker: 'Báº¡n', text: '[BLANK4] nhÃ©!' },
                    { speaker: 'TÃ i xáº¿', text: 'Dáº¡ khÃ´ng sao. TÃ´i Ä‘i Ä‘Æ°á»ng táº¯t cho báº¡n.' },
                    { speaker: 'Báº¡n', text: 'Äáº¿n rá»“i áº¡. [BLANK5]?' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'Báº¡n Ä‘i Ä‘Ã¢u',
                        translation: 'Where are you going?',
                        notes: 'Standard taxi greeting. "Äi Ä‘Ã¢u" = go where',
                        politeness: 'neutral',
                        category: 'greeting'
                    },
                    {
                        id: 'blank2',
                        answer: 'Cho tÃ´i Ä‘áº¿n chá»£',
                        translation: 'Take me to the market',
                        notes: '"Cho tÃ´i Ä‘áº¿n" = take me to. "Chá»£" = market. Common with taxi/directions',
                        politeness: 'neutral',
                        category: 'request'
                    },
                    {
                        id: 'blank3',
                        answer: 'Máº¥t bao lÃ¢u',
                        translation: 'How long does it take?',
                        notes: '"Máº¥t" = to take/lose, "bao lÃ¢u" = how long. Essential travel phrase',
                        politeness: 'neutral',
                        category: 'inquiry'
                    },
                    {
                        id: 'blank4',
                        answer: 'Äi nhanh má»™t chÃºt',
                        translation: 'Go a bit faster/hurry please',
                        notes: '"Nhanh" = fast, "má»™t chÃºt" = a little. Use when in a hurry but stay polite',
                        politeness: 'polite',
                        category: 'request'
                    },
                    {
                        id: 'blank5',
                        answer: 'Bao nhiÃªu tiá»n',
                        translation: 'How much money?',
                        notes: 'Essential phrase for asking prices. "Bao nhiÃªu" = how much, "tiá»n" = money',
                        politeness: 'neutral',
                        category: 'transaction'
                    }
                ]
            },
            'airport_checkin': {
                scenario: 'SÃ¢n bay - LÃ m thá»§ tá»¥c',
                context: 'You are checking in at Tan Son Nhat Airport in Ho Chi Minh City for a domestic flight to Da Nang.',
                dialogue: [
                    { speaker: 'NhÃ¢n viÃªn', text: 'Xin chÃ o! [BLANK1] áº¡?' },
                    { speaker: 'Báº¡n', text: 'ChÃ o chá»‹. [BLANK2] Ä‘áº¿n ÄÃ  Náºµng.' },
                    { speaker: 'NhÃ¢n viÃªn', text: 'VÃ¢ng áº¡. Cho tÃ´i xem há»™ chiáº¿u vÃ  vÃ© cá»§a báº¡n nhÃ©.' },
                    { speaker: 'Báº¡n', text: 'Dáº¡, Ä‘Ã¢y áº¡. [BLANK3] Ä‘Æ°á»£c khÃ´ng áº¡?' },
                    { speaker: 'NhÃ¢n viÃªn', text: 'ÄÆ°á»£c áº¡. Báº¡n cÃ³ hÃ nh lÃ½ kÃ½ gá»­i khÃ´ng?' },
                    { speaker: 'Báº¡n', text: 'CÃ³ áº¡. [BLANK4].' },
                    { speaker: 'NhÃ¢n viÃªn', text: 'VÃ¢ng. ÄÃ¢y lÃ  tháº» lÃªn mÃ¡y bay cá»§a báº¡n. Cá»­a lÃªn mÃ¡y bay sá»‘ 12. [BLANK5] nhÃ©!' },
                    { speaker: 'Báº¡n', text: 'Cáº£m Æ¡n chá»‹!' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'Báº¡n Ä‘i chuyáº¿n bay nÃ o',
                        translation: 'Which flight are you taking?',
                        notes: 'Polite way to ask about flight information. "Chuyáº¿n bay" means "flight".',
                        politeness: 'polite',
                        category: 'greeting'
                    },
                    {
                        id: 'blank2',
                        answer: 'TÃ´i cÃ³ vÃ©',
                        translation: 'I have a ticket',
                        notes: 'Standard phrase when presenting your ticket at check-in.',
                        politeness: 'neutral',
                        category: 'statement'
                    },
                    {
                        id: 'blank3',
                        answer: 'TÃ´i muá»‘n chá»n chá»— ngá»“i cáº¡nh cá»­a sá»•',
                        translation: 'I would like to choose a window seat',
                        notes: '"Chá»— ngá»“i" = seat, "cáº¡nh cá»­a sá»•" = by the window, "lá»‘i Ä‘i" = aisle',
                        politeness: 'polite',
                        category: 'request'
                    },
                    {
                        id: 'blank4',
                        answer: 'TÃ´i cÃ³ má»™t va li',
                        translation: 'I have one suitcase',
                        notes: '"Va li" or "hÃ nh lÃ½" both mean luggage/suitcase',
                        politeness: 'neutral',
                        category: 'statement'
                    },
                    {
                        id: 'blank5',
                        answer: 'ChÃºc báº¡n cÃ³ chuyáº¿n bay tá»‘t Ä‘áº¹p',
                        translation: 'Have a good flight',
                        notes: 'Common farewell at airports. "Tá»‘t Ä‘áº¹p" means good/pleasant',
                        politeness: 'polite',
                        category: 'farewell'
                    }
                ]
            }
        };

        // ==================== MAIN APP ====================
        
        function App() {
            const [currentScreen, setCurrentScreen] = useState('home');
            const [selectedScenario, setSelectedScenario] = useState(null);
            const [weeklyStats, setWeeklyStats] = useState(StorageManager.getWeeklyStats());

            useEffect(() => {
                setWeeklyStats(StorageManager.getWeeklyStats());
            }, [currentScreen]);

            const handleSelectScenario = (scenario) => {
                setSelectedScenario(scenario);
                setCurrentScreen('scenario');
            };

            const handleBackToHome = () => {
                setCurrentScreen('home');
                setSelectedScenario(null);
            };

            const handleGoToReview = () => {
                setCurrentScreen('review');
            };

            const handleGoToDashboard = () => {
                setCurrentScreen('dashboard');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
                    {/* Navigation Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <span className="text-3xl">ðŸ‡»ðŸ‡³</span>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900">
                                            Vietnamese Mastery
                                        </h1>
                                        <p className="text-sm text-gray-600">Simulate â€¢ Analyze â€¢ Train</p>
                                    </div>
                                </div>
                                <nav className="flex items-center space-x-4">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            currentScreen === 'home' 
                                                ? 'bg-indigo-600 text-white' 
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        Home
                                    </button>
                                    <button
                                        onClick={handleGoToReview}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            currentScreen === 'review' 
                                                ? 'bg-indigo-600 text-white' 
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        Review
                                    </button>
                                    <button
                                        onClick={handleGoToDashboard}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            currentScreen === 'dashboard' 
                                                ? 'bg-indigo-600 text-white' 
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        Dashboard
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {currentScreen === 'home' && (
                            <HomePage scenarios={TRAVEL_SCENARIOS} onSelectScenario={handleSelectScenario} />
                        )}
                        {currentScreen === 'scenario' && selectedScenario && (
                            <ScenarioPage scenario={selectedScenario} onBack={handleBackToHome} />
                        )}
                        {currentScreen === 'review' && (
                            <ReviewPage onBack={handleBackToHome} />
                        )}
                        {currentScreen === 'dashboard' && (
                            <DashboardPage stats={weeklyStats} onBack={handleBackToHome} />
                        )}
                    </main>
                </div>
            );
        }

        // ==================== HOME PAGE ====================
        
        function HomePage({ scenarios, onSelectScenario }) {
            const srsQueue = StorageManager.getSRSQueue();
            const phrases = StorageManager.getPhrases();
            const totalPhrases = Object.keys(phrases).length;
            const mastered = Object.values(phrases).filter(p => p.repetitions >= 3).length;

            return (
                <div>
                    {/* Quick Stats Banner */}
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <p className="text-indigo-200 text-sm font-medium mb-1">Due for Review</p>
                                <p className="text-4xl font-bold">{srsQueue.length}</p>
                                <p className="text-indigo-100 text-sm mt-1">phrases ready to practice</p>
                            </div>
                            <div>
                                <p className="text-indigo-200 text-sm font-medium mb-1">Total Progress</p>
                                <p className="text-4xl font-bold">{totalPhrases}</p>
                                <p className="text-indigo-100 text-sm mt-1">phrases learned</p>
                            </div>
                            <div>
                                <p className="text-indigo-200 text-sm font-medium mb-1">Mastery</p>
                                <p className="text-4xl font-bold">{mastered}</p>
                                <p className="text-indigo-100 text-sm mt-1">phrases mastered</p>
                            </div>
                        </div>
                    </div>

                    {/* Scenario Grid */}
                    <div>
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Choose Your Scenario</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {scenarios.map(scenario => (
                                <div
                                    key={scenario.id}
                                    className="scenario-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer border-2 border-transparent hover:border-indigo-500"
                                    onClick={() => onSelectScenario(scenario)}
                                >
                                    <div className="p-6">
                                        <div className="text-5xl mb-4">{scenario.icon}</div>
                                        <h3 className="text-xl font-bold text-gray-900 mb-2">
                                            {scenario.title}
                                        </h3>
                                        <p className="text-gray-600 mb-4">{scenario.description}</p>
                                        
                                        {/* Objectives */}
                                        <div className="mb-4">
                                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Learning Objectives</p>
                                            <ul className="space-y-1">
                                                {scenario.objectives.map((obj, idx) => (
                                                    <li key={idx} className="text-sm text-gray-700 flex items-start">
                                                        <span className="text-green-500 mr-2">âœ“</span>
                                                        {obj}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>

                                        {/* Tags */}
                                        <div className="flex items-center justify-between">
                                            <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                                {scenario.difficulty}
                                            </span>
                                            <span className="text-xs text-gray-500">
                                                â±ï¸ {scenario.estimatedTime}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== SCENARIO PAGE ====================
        
        function ScenarioPage({ scenario, onBack }) {
            const [activeTab, setActiveTab] = useState('simulate');
            const [simulationComplete, setSimulationComplete] = useState(false);
            const [simulationResults, setSimulationResults] = useState(null);

            const handleSimulationComplete = (results) => {
                setSimulationComplete(true);
                setSimulationResults(results);
                StorageManager.saveSimulation(scenario.id, results);
            };

            return (
                <div>
                    {/* Scenario Header */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                <span className="text-5xl">{scenario.icon}</span>
                                <div>
                                    <h2 className="text-3xl font-bold text-gray-900">{scenario.title}</h2>
                                    <p className="text-gray-600">{scenario.description}</p>
                                </div>
                            </div>
                            <button
                                onClick={onBack}
                                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition font-medium"
                            >
                                â† Back
                            </button>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="bg-white rounded-xl shadow-lg mb-6">
                        <div className="border-b border-gray-200">
                            <nav className="flex">
                                <button
                                    onClick={() => setActiveTab('simulate')}
                                    className={`tab-button px-8 py-4 font-semibold ${
                                        activeTab === 'simulate' ? 'active' : 'text-gray-600 hover:text-gray-900'
                                    }`}
                                >
                                    ðŸŽ­ SIMULATE
                                </button>
                                <button
                                    onClick={() => setActiveTab('analyze')}
                                    disabled={!simulationComplete}
                                    className={`tab-button px-8 py-4 font-semibold ${
                                        activeTab === 'analyze' 
                                            ? 'active' 
                                            : simulationComplete 
                                                ? 'text-gray-600 hover:text-gray-900' 
                                                : 'text-gray-400 cursor-not-allowed'
                                    }`}
                                >
                                    ðŸ“Š ANALYZE
                                    {simulationComplete && <span className="ml-2 text-green-500">âœ“</span>}
                                </button>
                                <button
                                    onClick={() => setActiveTab('train')}
                                    className={`tab-button px-8 py-4 font-semibold ${
                                        activeTab === 'train' ? 'active' : 'text-gray-600 hover:text-gray-900'
                                    }`}
                                >
                                    ðŸ’ª TRAIN
                                </button>
                            </nav>
                        </div>

                        {/* Tab Content */}
                        <div className="p-8">
                            {activeTab === 'simulate' && (
                                <SimulateTab 
                                    scenario={scenario} 
                                    onComplete={handleSimulationComplete}
                                />
                            )}
                            {activeTab === 'analyze' && simulationResults && (
                                <AnalyzeTab 
                                    scenario={scenario}
                                    results={simulationResults}
                                />
                            )}
                            {activeTab === 'train' && (
                                <TrainTab scenario={scenario} />
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== SIMULATE TAB ====================
        
        function SimulateTab({ scenario, onComplete }) {
            const [dialogue, setDialogue] = useState(null);
            const [userAnswers, setUserAnswers] = useState({});
            const [submitted, setSubmitted] = useState(false);
            const [startTime, setStartTime] = useState(null);
            const [responseTimes, setResponseTimes] = useState({});
            const [stage, setStage] = useState('learn'); // 'learn', 'practice', 'test'
            const [currentBlankIndex, setCurrentBlankIndex] = useState(0);
            const inputRefs = useRef({});

            useEffect(() => {
                // Load dialogue
                const dialogueData = SAMPLE_DIALOGUES[scenario.id] || SAMPLE_DIALOGUES['restaurant_order'];
                setDialogue(dialogueData);
                setStartTime(Date.now());
            }, [scenario.id]);

            const handleAnswerChange = (blankId, value) => {
                if (!responseTimes[blankId]) {
                    setResponseTimes(prev => ({
                        ...prev,
                        [blankId]: Date.now() - startTime
                    }));
                }
                setUserAnswers(prev => ({
                    ...prev,
                    [blankId]: value
                }));
            };

            const normalizeVietnamese = (text) => {
                return text.toLowerCase().trim().replace(/\s+/g, ' ');
            };

            const calculateSimilarity = (answer, correct) => {
                const a = normalizeVietnamese(answer);
                const c = normalizeVietnamese(correct);
                
                if (a === c) return 1.0;
                
                const aWords = a.split(' ');
                const cWords = c.split(' ');
                const matches = aWords.filter(word => cWords.includes(word)).length;
                
                return matches / Math.max(aWords.length, cWords.length);
            };

            const handleSubmit = () => {
                if (!dialogue) return;

                let totalCorrect = 0;
                let totalPolite = 0;
                let politeCorrect = 0;
                const blankResults = [];

                dialogue.blanks.forEach(blank => {
                    const userAnswer = userAnswers[blank.id] || '';
                    const similarity = calculateSimilarity(userAnswer, blank.answer);
                    const correct = similarity >= 0.8;

                    if (correct) totalCorrect++;
                    if (blank.politeness === 'polite') {
                        totalPolite++;
                        if (correct) politeCorrect++;
                    }

                    blankResults.push({
                        blankId: blank.id,
                        correct,
                        similarity,
                        responseTime: responseTimes[blank.id] || 0
                    });

                    StorageManager.savePhraseProgress(
                        `${scenario.id}_${blank.id}`,
                        {
                            correct,
                            similarity,
                            phrase: blank.answer,
                            translation: blank.translation,
                            scenario: scenario.id
                        }
                    );
                });

                const avgResponseTime = Object.values(responseTimes).reduce((a, b) => a + b, 0) / Object.keys(responseTimes).length;
                const politenessAccuracy = totalPolite > 0 ? (politeCorrect / totalPolite) * 100 : 0;
                const overallAccuracy = (totalCorrect / dialogue.blanks.length) * 100;

                const results = {
                    accuracy: overallAccuracy,
                    avgResponseTime: Math.round(avgResponseTime / 1000),
                    politenessAccuracy: Math.round(politenessAccuracy),
                    blanks: blankResults
                };

                // Update weekly stats
                const currentStats = StorageManager.getWeeklyStats();
                StorageManager.updateWeeklyStats({
                    scenariosCompleted: currentStats.scenariosCompleted + 1,
                    avgResponseTime: Math.round((currentStats.avgResponseTime + results.avgResponseTime) / 2),
                    politenessAccuracy: Math.round((currentStats.politenessAccuracy + results.politenessAccuracy) / 2)
                });

                setSubmitted(true);
                onComplete(results);
            };

            const handleNextStage = () => {
                if (stage === 'learn') {
                    setStage('practice');
                    setCurrentBlankIndex(0);
                    setUserAnswers({});
                } else if (stage === 'practice') {
                    setStage('test');
                    setUserAnswers({});
                    setStartTime(Date.now());
                } else if (stage === 'test') {
                    setStage('rebuild');
                }
            };

            const handlePracticeAnswer = (blankId, selectedAnswer, correctAnswer) => {
                const correct = normalizeVietnamese(selectedAnswer) === normalizeVietnamese(correctAnswer);
                
                setUserAnswers(prev => ({
                    ...prev,
                    [blankId]: selectedAnswer
                }));

                // Auto-advance after selection
                setTimeout(() => {
                    if (currentBlankIndex < dialogue.blanks.length - 1) {
                        setCurrentBlankIndex(prev => prev + 1);
                    }
                }, 1500);
            };

            if (!dialogue) {
                return <div className="text-center py-12">Loading dialogue...</div>;
            }

            // STAGE 1: LEARN - Show full dialogue with all answers
            if (stage === 'learn') {
                return (
                    <div>
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h3 className="text-2xl font-bold text-gray-900">ðŸ“š Stage 1: Learn</h3>
                                    <p className="text-gray-600">Read through the complete conversation and learn the key phrases</p>
                                </div>
                                <div className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-semibold">
                                    Step 1 of 5
                                </div>
                            </div>
                        </div>

                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6">
                            <p className="text-lg text-gray-700 mb-2">
                                <strong>Context:</strong> {dialogue.context}
                            </p>
                            <p className="text-sm text-gray-600">
                                ðŸ’¡ Pay attention to the <strong className="text-indigo-600">highlighted phrases</strong> - you'll practice these next!
                            </p>
                        </div>

                        {/* Full Dialogue with Highlights */}
                        <div className="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-8 mb-6">
                            <h4 className="text-lg font-bold text-gray-900 mb-6">Complete Conversation</h4>
                            <div className="space-y-4">
                                {dialogue.dialogue.map((line, index) => {
                                    const parts = line.text.split(/(\[BLANK\d+\])/g);
                                    
                                    return (
                                        <div key={index} className="flex items-start space-x-3">
                                            <div className="flex-shrink-0 w-28">
                                                <span className={`text-sm font-semibold ${
                                                    line.speaker === 'Báº¡n' ? 'text-indigo-600' : 'text-gray-700'
                                                }`}>
                                                    {line.speaker}:
                                                </span>
                                            </div>
                                            <div className="flex-1">
                                                <p className="text-lg leading-relaxed">
                                                    {parts.map((part, i) => {
                                                        const blankMatch = part.match(/\[BLANK(\d+)\]/);
                                                        if (blankMatch) {
                                                            const blankNum = blankMatch[1];
                                                            const blankId = `blank${blankNum}`;
                                                            const blank = dialogue.blanks.find(b => b.id === blankId);
                                                            
                                                            if (!blank) return null;

                                                            return (
                                                                <span key={i} className="inline">
                                                                    <strong className="text-indigo-600 bg-indigo-100 px-2 py-1 rounded">
                                                                        {blank.answer}
                                                                    </strong>
                                                                </span>
                                                            );
                                                        }
                                                        return <span key={i}>{part}</span>;
                                                    })}
                                                </p>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Key Phrases Reference */}
                        <div className="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-8 mb-6">
                            <h4 className="text-lg font-bold text-gray-900 mb-4">ðŸŽ¯ Key Phrases to Remember</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {dialogue.blanks.map((blank, index) => (
                                    <div key={blank.id} className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200">
                                        <div className="flex items-center space-x-2 mb-2">
                                            <span className="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                                {index + 1}
                                            </span>
                                            <span className="px-2 py-1 bg-purple-200 text-purple-700 rounded text-xs font-semibold">
                                                {blank.category}
                                            </span>
                                        </div>
                                        <p className="text-lg font-bold text-indigo-900 mb-1">{blank.answer}</p>
                                        <p className="text-sm text-gray-700 mb-2">
                                            <strong>Meaning:</strong> {blank.translation}
                                        </p>
                                        <p className="text-xs text-gray-600">{blank.notes}</p>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-end">
                            <button
                                onClick={handleNextStage}
                                className="px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center space-x-2"
                            >
                                <span>I've learned these phrases</span>
                                <span>â†’</span>
                            </button>
                        </div>
                    </div>
                );
            }

            // STAGE 2: PRACTICE - Multiple choice for each phrase
            if (stage === 'practice') {
                const currentBlank = dialogue.blanks[currentBlankIndex];
                const userAnswer = userAnswers[currentBlank.id];
                const hasAnswered = userAnswer !== undefined;
                const isCorrect = hasAnswered && normalizeVietnamese(userAnswer) === normalizeVietnamese(currentBlank.answer);

                // Generate wrong answers (simplified - in production, use more sophisticated distractors)
                const generateChoices = (correctAnswer) => {
                    const otherBlanks = dialogue.blanks.filter(b => b.id !== currentBlank.id);
                    const choices = [correctAnswer];
                    
                    // Add 2-3 wrong answers from other blanks
                    for (let i = 0; i < Math.min(2, otherBlanks.length); i++) {
                        choices.push(otherBlanks[i].answer);
                    }
                    
                    // Shuffle
                    return choices.sort(() => Math.random() - 0.5);
                };

                const choices = generateChoices(currentBlank.answer);
                const allPracticeComplete = currentBlankIndex === dialogue.blanks.length - 1 && hasAnswered;

                return (
                    <div>
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h3 className="text-2xl font-bold text-gray-900">âœï¸ Stage 2: Practice</h3>
                                    <p className="text-gray-600">Choose the correct Vietnamese phrase for each situation</p>
                                </div>
                                <div className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold">
                                    Step 2 of 5
                                </div>
                            </div>
                            <div className="flex items-center space-x-2">
                                <div className="flex-1 bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-green-500 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${((currentBlankIndex + (hasAnswered ? 1 : 0)) / dialogue.blanks.length) * 100}%` }}
                                    />
                                </div>
                                <span className="text-sm font-medium text-gray-600">
                                    {currentBlankIndex + 1} / {dialogue.blanks.length}
                                </span>
                            </div>
                        </div>

                        {/* Question Card */}
                        <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6">
                            {/* Category Badge */}
                            <div className="mb-4">
                                <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">
                                    {currentBlank.category}
                                </span>
                            </div>

                            {/* Question */}
                            <div className="mb-6">
                                <p className="text-gray-600 text-sm mb-2">How do you say in Vietnamese?</p>
                                <p className="text-3xl font-bold text-gray-900 mb-4">{currentBlank.translation}</p>
                                {currentBlank.politeness === 'polite' && (
                                    <p className="text-sm text-indigo-600 bg-indigo-50 inline-block px-3 py-1 rounded">
                                        ðŸ’¡ Remember to use polite form
                                    </p>
                                )}
                            </div>

                            {/* Multiple Choice Options */}
                            <div className="space-y-3">
                                {choices.map((choice, idx) => {
                                    const isSelected = userAnswer === choice;
                                    const isCorrectChoice = normalizeVietnamese(choice) === normalizeVietnamese(currentBlank.answer);
                                    
                                    let buttonStyle = 'bg-gray-50 border-2 border-gray-300 hover:border-indigo-400 hover:bg-indigo-50';
                                    if (hasAnswered) {
                                        if (isCorrectChoice) {
                                            buttonStyle = 'bg-green-100 border-2 border-green-500';
                                        } else if (isSelected) {
                                            buttonStyle = 'bg-red-100 border-2 border-red-500';
                                        } else {
                                            buttonStyle = 'bg-gray-100 border-2 border-gray-300 opacity-50';
                                        }
                                    }

                                    return (
                                        <button
                                            key={idx}
                                            onClick={() => !hasAnswered && handlePracticeAnswer(currentBlank.id, choice, currentBlank.answer)}
                                            disabled={hasAnswered}
                                            className={`w-full p-4 rounded-lg text-left transition ${buttonStyle} ${
                                                hasAnswered ? 'cursor-default' : 'cursor-pointer'
                                            }`}
                                        >
                                            <div className="flex items-center justify-between">
                                                <span className="text-lg font-medium">{choice}</span>
                                                {hasAnswered && isCorrectChoice && (
                                                    <span className="text-2xl">âœ…</span>
                                                )}
                                                {hasAnswered && isSelected && !isCorrectChoice && (
                                                    <span className="text-2xl">âŒ</span>
                                                )}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>

                            {/* Explanation after answering */}
                            {hasAnswered && (
                                <div className={`mt-6 p-4 rounded-lg ${
                                    isCorrect ? 'bg-green-50 border-2 border-green-200' : 'bg-orange-50 border-2 border-orange-200'
                                }`}>
                                    <p className={`font-semibold mb-2 ${isCorrect ? 'text-green-800' : 'text-orange-800'}`}>
                                        {isCorrect ? 'ðŸŽ‰ Correct!' : 'ðŸ“š Keep practicing!'}
                                    </p>
                                    <p className="text-gray-700 text-sm mb-1">
                                        <strong>Notes:</strong> {currentBlank.notes}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Navigation */}
                        <div className="flex justify-between">
                            {currentBlankIndex > 0 && (
                                <button
                                    onClick={() => setCurrentBlankIndex(prev => prev - 1)}
                                    className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                                >
                                    â† Previous
                                </button>
                            )}
                            <div className="flex-1"></div>
                            {hasAnswered && !allPracticeComplete && (
                                <button
                                    onClick={() => setCurrentBlankIndex(prev => prev + 1)}
                                    className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition"
                                >
                                    Next â†’
                                </button>
                            )}
                            {allPracticeComplete && (
                                <button
                                    onClick={handleNextStage}
                                    className="px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                                >
                                    Ready for the Test â†’
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // STAGE 3: TEST - Fill in the blanks (original implementation)

            // STAGE 3: TEST - Fill in the blanks
            const renderDialogueLine = (line, index) => {
                const parts = line.text.split(/(\[BLANK\d+\])/g);
                
                return (
                    <div key={index} className="mb-4 animate-slide-in">
                        <div className="flex items-start space-x-3">
                            <div className="flex-shrink-0 w-28">
                                <span className={`text-sm font-semibold ${
                                    line.speaker === 'Báº¡n' ? 'text-indigo-600' : 'text-gray-700'
                                }`}>
                                    {line.speaker}:
                                </span>
                            </div>
                            <div className="flex-1">
                                <p className="text-lg leading-relaxed">
                                    {parts.map((part, i) => {
                                        const blankMatch = part.match(/\[BLANK(\d+)\]/);
                                        if (blankMatch) {
                                            const blankNum = blankMatch[1];
                                            const blankId = `blank${blankNum}`;
                                            const blank = dialogue.blanks.find(b => b.id === blankId);
                                            
                                            if (!blank) return null;

                                            const userAnswer = userAnswers[blankId] || '';
                                            const similarity = submitted ? calculateSimilarity(userAnswer, blank.answer) : 0;
                                            const isCorrect = similarity >= 0.8;

                                            return (
                                                <span key={i} className="inline-block mx-1">
                                                    <input
                                                        ref={el => inputRefs.current[blankId] = el}
                                                        type="text"
                                                        value={userAnswer}
                                                        onChange={(e) => handleAnswerChange(blankId, e.target.value)}
                                                        disabled={submitted}
                                                        className={`blank-input px-3 py-1 min-w-[200px] rounded ${
                                                            submitted 
                                                                ? isCorrect 
                                                                    ? 'correct' 
                                                                    : 'incorrect'
                                                                : ''
                                                        }`}
                                                        placeholder="..."
                                                    />
                                                    {submitted && !isCorrect && (
                                                        <div className="inline-block ml-2 text-green-600 font-medium">
                                                            âœ“ {blank.answer}
                                                        </div>
                                                    )}
                                                </span>
                                            );
                                        }
                                        return <span key={i}>{part}</span>;
                                    })}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            // STAGE 4: REBUILD THE SENTENCE
            if (stage === 'rebuild') {
                return <RebuildStage dialogue={dialogue} onBack={() => setStage('test')} onNextStage={() => setStage('listening')} onRestart={() => { setStage('learn'); setUserAnswers({}); setSubmitted(false); setCurrentBlankIndex(0); setStartTime(Date.now()); }} />;
            }

            // STAGE 5: LISTENING MODE
            if (stage === 'listening') {
                return <ListeningStage dialogue={dialogue} onBack={() => setStage('rebuild')} onRestart={() => { setStage('learn'); setUserAnswers({}); setSubmitted(false); setCurrentBlankIndex(0); setStartTime(Date.now()); }} />;
            }

            if (!dialogue) {
                return <div className="text-center py-12">Loading dialogue...</div>;
            }

            const allFilled = dialogue.blanks.every(blank => userAnswers[blank.id]?.trim());

            // STAGE 3: TEST - Fill in the blanks
            return (
                <div>
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">ðŸŽ¯ Stage 3: Test</h3>
                                <p className="text-gray-600">Now fill in the blanks from memory - you've got this!</p>
                            </div>
                            <div className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold">
                                Step 3 of 5
                            </div>
                        </div>
                    </div>
                    <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-6 mb-6">
                        <p className="text-lg text-gray-700 mb-2">
                            <strong>Context:</strong> {dialogue.context}
                        </p>
                        <p className="text-sm text-gray-600">
                            ðŸ’¡ Type the Vietnamese phrases you learned. Don't worry about perfect spelling - we check for meaning!
                        </p>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-8 mb-6">
                        <div className="space-y-2">
                            {dialogue.dialogue.map((line, index) => renderDialogueLine(line, index))}
                        </div>
                    </div>

                    <div className="flex items-center justify-between border-t pt-6">
                        <button
                            onClick={() => setStage('practice')}
                            className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                        >
                            â† Review Practice
                        </button>
                        <div>
                            {submitted && (
                                <p className="text-sm text-green-600 mr-4 inline-block">
                                    âœ“ Responses recorded for spaced repetition!
                                </p>
                            )}
                        </div>
                        <div className="flex space-x-3">
                            {!submitted ? (
                                <button
                                    onClick={handleSubmit}
                                    disabled={!allFilled}
                                    className={`px-8 py-3 rounded-lg font-semibold transition ${
                                        allFilled
                                            ? 'bg-purple-600 text-white hover:bg-purple-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Submit Test
                                </button>
                            ) : (
                                <>
                                    <button
                                        onClick={() => {
                                            setStage('learn');
                                            setUserAnswers({});
                                            setSubmitted(false);
                                            setCurrentBlankIndex(0);
                                            setStartTime(Date.now());
                                        }}
                                        className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                                    >
                                        Practice Again
                                    </button>
                                    <button
                                        onClick={() => setStage('rebuild')}
                                        className="px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                                    >
                                        Next: Rebuild â†’
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== REBUILD STAGE ====================

        function RebuildStage({ dialogue, onBack, onRestart, onNextStage }) {
            // Build sentence pool: fill in blank placeholders with correct answers so all words are present
            const sentences = React.useMemo(() => {
                // Build a lookup map: blankId -> answer (e.g. 'blank1' -> 'trÃ¡ch nhiá»‡m')
                const answerMap = {};
                (dialogue.blanks || []).forEach(b => { answerMap[b.id] = b.answer; });
                return dialogue.dialogue
                    .map(line => {
                        // Replace [BLANK1] with the correct answer for blank1, etc.
                        const filled = line.text.replace(/\[BLANK(\d+)\]/g, (_, n) => {
                            const key = 'blank' + n;
                            return answerMap[key] || '';
                        }).replace(/\s+/g, ' ').trim();
                        return { speaker: line.speaker, text: filled };
                    })
                    .filter(line => line.text.length > 8);
            }, [dialogue]);

            const [currentIndex, setCurrentIndex] = useState(0);
            const [selectedWords, setSelectedWords] = useState([]);
            const [availableWords, setAvailableWords] = useState([]);
            const [result, setResult] = useState(null); // null | 'correct' | 'incorrect'
            const [completed, setCompleted] = useState(0);

            const shuffleArray = (arr) => {
                const a = [...arr];
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            };

            const loadSentence = (index) => {
                const sentence = sentences[index];
                if (!sentence) return;
                // Split on spaces, keep punctuation attached to word
                const words = sentence.text.split(' ').filter(w => w.length > 0);
                // Tag each word with a unique id to handle duplicates
                const tagged = words.map((w, i) => ({ id: `w${i}`, word: w }));
                setAvailableWords(shuffleArray(tagged));
                setSelectedWords([]);
                setResult(null);
            };

            useEffect(() => {
                loadSentence(currentIndex);
            }, [currentIndex]);

            const handlePickWord = (item) => {
                setAvailableWords(prev => prev.filter(w => w.id !== item.id));
                setSelectedWords(prev => [...prev, item]);
                setResult(null);
            };

            const handleRemoveWord = (item) => {
                setSelectedWords(prev => prev.filter(w => w.id !== item.id));
                setAvailableWords(prev => [...prev, item]);
                setResult(null);
            };

            const handleCheck = () => {
                const answer = selectedWords.map(w => w.word).join(' ');
                const correct = sentences[currentIndex].text;
                if (answer === correct) {
                    setResult('correct');
                    setCompleted(prev => prev + 1);
                } else {
                    setResult('incorrect');
                }
            };

            const handleNext = () => {
                if (currentIndex < sentences.length - 1) {
                    setCurrentIndex(prev => prev + 1);
                }
            };

            const handleTryAgain = () => {
                loadSentence(currentIndex);
            };

            const isLastSentence = currentIndex === sentences.length - 1;
            const allDone = isLastSentence && result === 'correct';
            const current = sentences[currentIndex];

            return (
                <div>
                    {/* Header */}
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">ðŸ§© Stage 4: Rebuild the Sentence</h3>
                                <p className="text-gray-600">Arrange the words in the correct order to rebuild each sentence</p>
                            </div>
                            <div className="px-4 py-2 bg-teal-100 text-teal-700 rounded-lg font-semibold">
                                Step 4 of 5
                            </div>
                        </div>
                        {/* Progress bar */}
                        <div className="flex items-center space-x-3">
                            <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-teal-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${((currentIndex + (result === 'correct' ? 1 : 0)) / sentences.length) * 100}%` }}
                                />
                            </div>
                            <span className="text-sm font-medium text-gray-600 whitespace-nowrap">
                                {currentIndex + 1} / {sentences.length}
                            </span>
                        </div>
                    </div>

                    {/* Card */}
                    <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6">
                        {/* Speaker badge */}
                        <div className="mb-5">
                            <span className="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm font-semibold">
                                {current.speaker}
                            </span>
                        </div>

                        {/* Answer area */}
                        <div className="mb-6">
                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Your sentence</p>
                            <div
                                className={`min-h-[60px] flex flex-wrap gap-2 p-4 rounded-xl border-2 transition-colors ${
                                    result === 'correct' ? 'border-green-400 bg-green-50' :
                                    result === 'incorrect' ? 'border-red-400 bg-red-50' :
                                    'border-dashed border-gray-300 bg-gray-50'
                                }`}
                            >
                                {selectedWords.length === 0 && (
                                    <span className="text-gray-400 text-sm italic self-center">Click words below to build the sentenceâ€¦</span>
                                )}
                                {selectedWords.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => result === null && handleRemoveWord(item)}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                            result === 'correct' ? 'bg-green-200 text-green-900 cursor-default' :
                                            result === 'incorrect' ? 'bg-red-200 text-red-900 cursor-default' :
                                            'bg-indigo-600 text-white hover:bg-red-500 hover:scale-95'
                                        }`}
                                        title={result === null ? 'Click to remove' : ''}
                                    >
                                        {item.word}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Word bank */}
                        <div className="mb-6">
                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Word bank</p>
                            <div className="flex flex-wrap gap-2 min-h-[44px]">
                                {availableWords.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => result === null && handlePickWord(item)}
                                        disabled={result !== null}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium border-2 transition-all ${
                                            result !== null
                                                ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-default'
                                                : 'bg-white border-indigo-300 text-indigo-700 hover:bg-indigo-50 hover:border-indigo-500 hover:scale-105 active:scale-95'
                                        }`}
                                    >
                                        {item.word}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Result feedback */}
                        {result === 'correct' && (
                            <div className="flex items-center space-x-3 p-4 bg-green-50 border-2 border-green-300 rounded-xl animate-slide-in">
                                <span className="text-2xl">âœ…</span>
                                <div>
                                    <p className="font-bold text-green-800">Correct!</p>
                                    <p className="text-green-700 text-sm">Perfect â€” the sentence matches exactly.</p>
                                </div>
                            </div>
                        )}
                        {result === 'incorrect' && (
                            <div className="flex items-center space-x-3 p-4 bg-red-50 border-2 border-red-300 rounded-xl animate-slide-in">
                                <span className="text-2xl">âŒ</span>
                                <div>
                                    <p className="font-bold text-red-800">Try again!</p>
                                    <p className="text-red-700 text-sm">The word order isn't quite right. Remove words and try a different order.</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* All done screen */}
                    {allDone && (
                        <div className="bg-gradient-to-r from-teal-500 to-green-500 rounded-xl p-8 text-white text-center mb-6 animate-slide-in">
                            <div className="text-5xl mb-3">ðŸŽ‰</div>
                            <h4 className="text-2xl font-bold mb-2">All sentences rebuilt!</h4>
                            <p className="text-teal-100 mb-1">You've completed all 5 stages of this scenario.</p>
                            <p className="text-teal-100">You scored {completed} / {sentences.length} on the rebuild exercises.</p>
                        </div>
                    )}

                    {/* Action buttons */}
                    <div className="flex items-center justify-between border-t pt-6">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                        >
                            â† Back to Test
                        </button>
                        <div className="flex space-x-3">
                            {result === 'incorrect' && (
                                <button
                                    onClick={handleTryAgain}
                                    className="px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition"
                                >
                                    Reset Words
                                </button>
                            )}
                            {result === 'correct' && !isLastSentence && (
                                <button
                                    onClick={handleNext}
                                    className="px-8 py-3 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700 transition"
                                >
                                    Next Sentence â†’
                                </button>
                            )}
                            {allDone && (
                                <>
                                    <button
                                        onClick={onRestart}
                                        className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                                    >
                                        Start Over ðŸ”„
                                    </button>
                                    <button
                                        onClick={onNextStage}
                                        className="px-8 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition"
                                    >
                                        Next: Listening ðŸŽ§
                                    </button>
                                </>
                            )}
                            {result === null && (
                                <button
                                    onClick={handleCheck}
                                    disabled={selectedWords.length === 0}
                                    className={`px-8 py-3 rounded-lg font-semibold transition ${
                                        selectedWords.length > 0
                                            ? 'bg-teal-600 text-white hover:bg-teal-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check âœ“
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }


        // ==================== LISTENING STAGE ====================

        function ListeningStage({ dialogue, onBack, onRestart }) {
            const { useState, useEffect, useRef, useMemo } = React;

            // Reuse same sentence pool as RebuildStage â€” fill in blank answers so all words are present
            const sentences = useMemo(() => {
                const answerMap = {};
                (dialogue.blanks || []).forEach(b => { answerMap[b.id] = b.answer; });
                return dialogue.dialogue
                    .map(line => {
                        const filled = line.text.replace(/\[BLANK(\d+)\]/g, (_, n) => {
                            const key = 'blank' + n;
                            return answerMap[key] || '';
                        }).replace(/\s+/g, ' ').trim();
                        return { speaker: line.speaker, text: filled };
                    })
                    .filter(line => line.text.length > 8);
            }, [dialogue]);

            const [currentIndex, setCurrentIndex] = useState(0);
            const [hasPlayed, setHasPlayed] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [selectedWords, setSelectedWords] = useState([]);
            const [availableWords, setAvailableWords] = useState([]);
            const [result, setResult] = useState(null); // null | 'correct' | 'incorrect'
            const [completed, setCompleted] = useState(0);
            const [ttsSupported, setTtsSupported] = useState(true);
            const utteranceRef = useRef(null);

            const shuffleArray = (arr) => {
                const a = [...arr];
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            };

            const loadSentence = (index) => {
                const sentence = sentences[index];
                if (!sentence) return;
                const words = sentence.text.split(' ').filter(w => w.length > 0);
                const tagged = words.map((w, i) => ({ id: `lw${i}`, word: w }));
                setAvailableWords(shuffleArray(tagged));
                setSelectedWords([]);
                setResult(null);
                setHasPlayed(false);
                setIsPlaying(false);
                // Cancel any ongoing speech
                if (window.speechSynthesis) window.speechSynthesis.cancel();
            };

            useEffect(() => {
                if (!window.speechSynthesis) {
                    setTtsSupported(false);
                }
                loadSentence(0);
                return () => {
                    if (window.speechSynthesis) window.speechSynthesis.cancel();
                };
            }, []);

            useEffect(() => {
                loadSentence(currentIndex);
            }, [currentIndex]);

            const playAudio = () => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const text = sentences[currentIndex].text;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.rate = 0.85;
                utterance.pitch = 1;

                // Try to find a Vietnamese voice
                const voices = window.speechSynthesis.getVoices();
                const viVoice = voices.find(v => v.lang === 'vi-VN' || v.lang.startsWith('vi'));
                if (viVoice) utterance.voice = viVoice;

                utterance.onstart = () => setIsPlaying(true);
                utterance.onend = () => {
                    setIsPlaying(false);
                    setHasPlayed(true);
                };
                utterance.onerror = () => {
                    setIsPlaying(false);
                    setHasPlayed(true);
                };
                utteranceRef.current = utterance;
                window.speechSynthesis.speak(utterance);
            };

            // Voices may load async â€” retry after a short delay if needed
            const handlePlayClick = () => {
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        window.speechSynthesis.onvoiceschanged = null;
                        playAudio();
                    };
                    // Fallback: play anyway after 300ms even without voice list
                    setTimeout(() => playAudio(), 300);
                } else {
                    playAudio();
                }
            };

            const handlePickWord = (item) => {
                if (result !== null) return;
                setAvailableWords(prev => prev.filter(w => w.id !== item.id));
                setSelectedWords(prev => [...prev, item]);
            };

            const handleRemoveWord = (item) => {
                if (result !== null) return;
                setSelectedWords(prev => prev.filter(w => w.id !== item.id));
                setAvailableWords(prev => [...prev, item]);
            };

            const handleCheck = () => {
                const answer = selectedWords.map(w => w.word).join(' ');
                const correct = sentences[currentIndex].text;
                if (answer === correct) {
                    setResult('correct');
                    setCompleted(prev => prev + 1);
                } else {
                    setResult('incorrect');
                }
            };

            const handleTryAgain = () => {
                loadSentence(currentIndex);
            };

            const handleNext = () => {
                if (currentIndex < sentences.length - 1) {
                    setCurrentIndex(prev => prev + 1);
                }
            };

            const isLastSentence = currentIndex === sentences.length - 1;
            const allDone = isLastSentence && result === 'correct';
            const current = sentences[currentIndex];

            return (
                <div>
                    {/* Header */}
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">ðŸŽ§ Stage 5: Listening Mode</h3>
                                <p className="text-gray-600">Listen to the sentence, then rebuild it from memory</p>
                            </div>
                            <div className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold">
                                Final Step
                            </div>
                        </div>
                        <div className="flex items-center space-x-3">
                            <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-purple-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${((currentIndex + (result === 'correct' ? 1 : 0)) / sentences.length) * 100}%` }}
                                />
                            </div>
                            <span className="text-sm font-medium text-gray-600 whitespace-nowrap">
                                {currentIndex + 1} / {sentences.length}
                            </span>
                        </div>
                    </div>

                    {!ttsSupported && (
                        <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6 flex items-center space-x-3">
                            <span className="text-2xl">âš ï¸</span>
                            <p className="text-yellow-800 text-sm">Your browser doesn't support Text-to-Speech. The sentence is shown below so you can still practice rebuilding.</p>
                        </div>
                    )}

                    {/* Card */}
                    <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6">
                        {/* Speaker badge */}
                        <div className="flex items-center justify-between mb-6">
                            <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">
                                {current.speaker}
                            </span>
                            <span className="text-xs text-gray-400 italic">Sentence {currentIndex + 1} of {sentences.length}</span>
                        </div>

                        {/* Audio play zone */}
                        <div className="flex flex-col items-center justify-center py-8 mb-6 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl border-2 border-purple-200">
                            <button
                                onClick={handlePlayClick}
                                disabled={isPlaying}
                                className={`w-20 h-20 rounded-full flex items-center justify-center text-3xl shadow-lg transition-all mb-4 ${
                                    isPlaying
                                        ? 'bg-purple-300 cursor-not-allowed scale-95'
                                        : 'bg-purple-600 hover:bg-purple-700 hover:scale-110 active:scale-95 text-white'
                                }`}
                                title="Play audio"
                            >
                                {isPlaying ? 'â¸' : 'â–¶'}
                            </button>
                            <p className="text-purple-700 font-semibold text-sm mb-1">
                                {isPlaying ? 'Playingâ€¦' : hasPlayed ? 'Play again' : 'Play Audio'}
                            </p>
                            <p className="text-purple-400 text-xs">Vietnamese (vi-VN) Â· click to replay anytime</p>

                            {/* Fallback: show sentence if TTS unsupported */}
                            {!ttsSupported && (
                                <p className="mt-4 text-gray-800 text-lg font-medium text-center px-4">{current.text}</p>
                            )}
                        </div>

                        {/* Word puzzle â€” always shown so user can start building while listening */}
                        <div className="mb-6">
                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Your sentence</p>
                            <div
                                className={`min-h-[60px] flex flex-wrap gap-2 p-4 rounded-xl border-2 transition-colors ${
                                    result === 'correct' ? 'border-green-400 bg-green-50' :
                                    result === 'incorrect' ? 'border-red-400 bg-red-50' :
                                    'border-dashed border-gray-300 bg-gray-50'
                                }`}
                            >
                                {selectedWords.length === 0 && (
                                    <span className="text-gray-400 text-sm italic self-center">Click words below to build the sentenceâ€¦</span>
                                )}
                                {selectedWords.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => handleRemoveWord(item)}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                            result === 'correct' ? 'bg-green-200 text-green-900 cursor-default' :
                                            result === 'incorrect' ? 'bg-red-200 text-red-900 cursor-default' :
                                            'bg-purple-600 text-white hover:bg-red-500 hover:scale-95'
                                        }`}
                                        title={result === null ? 'Click to remove' : ''}
                                    >
                                        {item.word}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="mb-6">
                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Word bank</p>
                            <div className="flex flex-wrap gap-2 min-h-[44px]">
                                {availableWords.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => handlePickWord(item)}
                                        disabled={result !== null}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium border-2 transition-all ${
                                            result !== null
                                                ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-default'
                                                : 'bg-white border-purple-300 text-purple-700 hover:bg-purple-50 hover:border-purple-500 hover:scale-105 active:scale-95'
                                        }`}
                                    >
                                        {item.word}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Result feedback */}
                        {result === 'correct' && (
                            <div className="animate-slide-in">
                                <div className="flex items-center space-x-3 p-4 bg-green-50 border-2 border-green-300 rounded-xl mb-3">
                                    <span className="text-2xl">âœ…</span>
                                    <div>
                                        <p className="font-bold text-green-800">Correct!</p>
                                        <p className="text-green-700 text-sm">You rebuilt the sentence perfectly from audio.</p>
                                    </div>
                                </div>
                                <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <p className="text-xs text-gray-500 mb-1">Full sentence:</p>
                                    <p className="text-gray-800 font-medium">{current.text}</p>
                                </div>
                            </div>
                        )}
                        {result === 'incorrect' && (
                            <div className="flex items-center space-x-3 p-4 bg-red-50 border-2 border-red-300 rounded-xl animate-slide-in">
                                <span className="text-2xl">âŒ</span>
                                <div>
                                    <p className="font-bold text-red-800">Try again!</p>
                                    <p className="text-red-700 text-sm">Listen again and rearrange the words. You can replay as many times as you need!</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* All done banner */}
                    {allDone && (
                        <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl p-8 text-white text-center mb-6 animate-slide-in">
                            <div className="text-5xl mb-3">ðŸ†</div>
                            <h4 className="text-2xl font-bold mb-2">All 5 stages complete!</h4>
                            <p className="text-purple-100 mb-1">Outstanding work â€” you've finished Listening Mode.</p>
                            <p className="text-purple-200">Listening score: {completed} / {sentences.length} sentences</p>
                        </div>
                    )}

                    {/* Action buttons */}
                    <div className="flex items-center justify-between border-t pt-6">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                        >
                            â† Back to Rebuild
                        </button>
                        <div className="flex space-x-3">
                            {result === 'incorrect' && (
                                <button
                                    onClick={handleTryAgain}
                                    className="px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition"
                                >
                                    Reset Words
                                </button>
                            )}
                            {result === 'correct' && !isLastSentence && (
                                <button
                                    onClick={handleNext}
                                    className="px-8 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition"
                                >
                                    Next Sentence â†’
                                </button>
                            )}
                            {allDone && (
                                <button
                                    onClick={onRestart}
                                    className="px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition"
                                >
                                    Start Over ðŸ”„
                                </button>
                            )}
                            {result === null && (
                                <button
                                    onClick={handleCheck}
                                    disabled={selectedWords.length === 0}
                                    className={`px-8 py-3 rounded-lg font-semibold transition ${
                                        selectedWords.length > 0
                                            ? 'bg-purple-600 text-white hover:bg-purple-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check âœ“
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== ANALYZE TAB ====================
        
        function AnalyzeTab({ scenario, results }) {
            const dialogue = SAMPLE_DIALOGUES[scenario.id] || SAMPLE_DIALOGUES['restaurant_order'];

            const getGrade = (accuracy) => {
                if (accuracy >= 90) return { grade: 'A', color: 'text-green-600', bg: 'bg-green-100' };
                if (accuracy >= 80) return { grade: 'B', color: 'text-blue-600', bg: 'bg-blue-100' };
                if (accuracy >= 70) return { grade: 'C', color: 'text-yellow-600', bg: 'bg-yellow-100' };
                return { grade: 'D', color: 'text-red-600', bg: 'bg-red-100' };
            };

            const accuracyGrade = getGrade(results.accuracy);

            return (
                <div>
                    <h3 className="text-2xl font-bold text-gray-900 mb-6">Performance Analysis</h3>

                    {/* Metrics Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white">
                            <p className="text-green-100 text-sm font-medium mb-2">Overall Accuracy</p>
                            <p className="text-5xl font-bold">{Math.round(results.accuracy)}%</p>
                            <p className={`mt-2 px-3 py-1 inline-block rounded-full text-sm font-bold ${accuracyGrade.bg} ${accuracyGrade.color}`}>
                                Grade: {accuracyGrade.grade}
                            </p>
                        </div>

                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                            <p className="text-blue-100 text-sm font-medium mb-2">Avg Response Time</p>
                            <p className="text-5xl font-bold">{results.avgResponseTime}s</p>
                            <p className="text-blue-100 text-sm mt-2">per phrase</p>
                        </div>

                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                            <p className="text-purple-100 text-sm font-medium mb-2">Politeness Accuracy</p>
                            <p className="text-5xl font-bold">{results.politenessAccuracy}%</p>
                            <p className="text-purple-100 text-sm mt-2">formal expressions</p>
                        </div>
                    </div>

                    {/* Detailed Breakdown */}
                    <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                        <h4 className="text-xl font-bold text-gray-900 mb-4">Phrase-by-Phrase Breakdown</h4>
                        <div className="space-y-4">
                            {dialogue.blanks.map((blank, index) => {
                                const result = results.blanks.find(b => b.blankId === blank.id);
                                const isCorrect = result?.correct || false;
                                const responseTime = result?.responseTime || 0;

                                return (
                                    <div key={blank.id} className={`p-4 rounded-lg border-2 ${
                                        isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'
                                    }`}>
                                        <div className="flex items-start justify-between mb-2">
                                            <div className="flex-1">
                                                <div className="flex items-center space-x-2 mb-2">
                                                    <span className="text-2xl">{isCorrect ? 'âœ…' : 'âŒ'}</span>
                                                    <span className="font-semibold text-gray-900">Phrase {index + 1}</span>
                                                    <span className="px-2 py-1 bg-gray-200 rounded text-xs font-medium text-gray-700">
                                                        {blank.category}
                                                    </span>
                                                    {blank.politeness === 'polite' && (
                                                        <span className="px-2 py-1 bg-purple-200 rounded text-xs font-medium text-purple-700">
                                                            polite form
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-lg font-medium text-indigo-600 mb-1">{blank.answer}</p>
                                                <p className="text-gray-700 mb-1">
                                                    <span className="font-medium">Translation:</span> {blank.translation}
                                                </p>
                                                <p className="text-sm text-gray-600">{blank.notes}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-sm text-gray-500">Response Time</p>
                                                <p className="text-xl font-bold text-gray-900">{Math.round(responseTime / 1000)}s</p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Recommendations */}
                    <div className="mt-6 bg-indigo-50 border-2 border-indigo-200 rounded-xl p-6">
                        <h4 className="text-lg font-bold text-indigo-900 mb-3">ðŸ’¡ Recommendations</h4>
                        <ul className="space-y-2">
                            {results.accuracy < 80 && (
                                <li className="text-indigo-800">â€¢ Focus on reviewing phrases you missed in the TRAIN tab</li>
                            )}
                            {results.avgResponseTime > 10 && (
                                <li className="text-indigo-800">â€¢ Practice these phrases more to improve fluency and recall speed</li>
                            )}
                            {results.politenessAccuracy < 90 && (
                                <li className="text-indigo-800">â€¢ Pay special attention to polite forms (áº¡, chá»‹, anh) in formal contexts</li>
                            )}
                            <li className="text-indigo-800">â€¢ Try the scenario again to improve your score!</li>
                        </ul>
                    </div>
                </div>
            );
        }

        // ==================== TRAIN TAB ====================
        
        function TrainTab({ scenario }) {
            const dialogue = SAMPLE_DIALOGUES[scenario.id] || SAMPLE_DIALOGUES['restaurant_order'];
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswer, setUserAnswer] = useState('');
            const [showAnswer, setShowAnswer] = useState(false);
            const [queue, setQueue] = useState([]);

            useEffect(() => {
                // Build SRS queue for this scenario
                const scenarioPhrases = dialogue.blanks.map(blank => ({
                    ...blank,
                    phraseId: `${scenario.id}_${blank.id}`
                }));
                
                // Prioritize phrases user has struggled with
                const phraseProgress = StorageManager.getPhrases();
                const sortedQueue = scenarioPhrases.sort((a, b) => {
                    const progressA = phraseProgress[a.phraseId];
                    const progressB = phraseProgress[b.phraseId];
                    
                    const accuracyA = progressA ? (progressA.correct / progressA.attempts) : 0;
                    const accuracyB = progressB ? (progressB.correct / progressB.attempts) : 0;
                    
                    return accuracyA - accuracyB;
                });

                setQueue(sortedQueue);
            }, [scenario.id]);

            const handleCheckAnswer = () => {
                setShowAnswer(true);
            };

            const handleNext = (quality) => {
                const currentPhrase = queue[currentIndex];
                const similarity = calculateSimilarity(userAnswer, currentPhrase.answer);
                const correct = similarity >= 0.8;

                StorageManager.savePhraseProgress(currentPhrase.phraseId, {
                    correct,
                    similarity,
                    phrase: currentPhrase.answer,
                    translation: currentPhrase.translation,
                    scenario: scenario.id
                });

                setUserAnswer('');
                setShowAnswer(false);
                setCurrentIndex((prev) => (prev + 1) % queue.length);
            };

            const calculateSimilarity = (answer, correct) => {
                const a = answer.toLowerCase().trim().replace(/\s+/g, ' ');
                const c = correct.toLowerCase().trim().replace(/\s+/g, ' ');
                
                if (a === c) return 1.0;
                
                const aWords = a.split(' ');
                const cWords = c.split(' ');
                const matches = aWords.filter(word => cWords.includes(word)).length;
                
                return matches / Math.max(aWords.length, cWords.length);
            };

            if (queue.length === 0) {
                return <div className="text-center py-12">Loading training queue...</div>;
            }

            const currentPhrase = queue[currentIndex];
            const phraseProgress = StorageManager.getPhrases()[currentPhrase.phraseId];
            const accuracy = phraseProgress ? (phraseProgress.correct / phraseProgress.attempts * 100) : 0;

            return (
                <div>
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-2xl font-bold text-gray-900">Spaced Repetition Training</h3>
                            <div className="text-sm text-gray-600">
                                Card {currentIndex + 1} of {queue.length}
                            </div>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                                className="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                                style={{ width: `${((currentIndex + 1) / queue.length) * 100}%` }}
                            />
                        </div>
                    </div>

                    {/* Flashcard */}
                    <div className="bg-white rounded-xl shadow-xl p-8 mb-6 border-2 border-gray-200">
                        {/* Progress Badge */}
                        {phraseProgress && (
                            <div className="mb-4">
                                <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                    accuracy >= 80 ? 'bg-green-100 text-green-700' :
                                    accuracy >= 60 ? 'bg-yellow-100 text-yellow-700' :
                                    'bg-red-100 text-red-700'
                                }`}>
                                    Accuracy: {Math.round(accuracy)}% ({phraseProgress.correct}/{phraseProgress.attempts})
                                </span>
                            </div>
                        )}

                        {/* Translation (Question) */}
                        <div className="mb-6">
                            <p className="text-gray-500 text-sm font-medium mb-2">Translate to Vietnamese:</p>
                            <p className="text-3xl font-bold text-gray-900 mb-2">{currentPhrase.translation}</p>
                            <div className="flex items-center space-x-2 mt-3">
                                <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                    {currentPhrase.category}
                                </span>
                                {currentPhrase.politeness === 'polite' && (
                                    <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                        polite form required
                                    </span>
                                )}
                            </div>
                        </div>

                        {/* Answer Input */}
                        <div className="mb-6">
                            <input
                                type="text"
                                value={userAnswer}
                                onChange={(e) => setUserAnswer(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter' && !showAnswer && userAnswer.trim()) {
                                        handleCheckAnswer();
                                    }
                                }}
                                disabled={showAnswer}
                                placeholder="Type your answer in Vietnamese..."
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                            />
                        </div>

                        {/* Answer Reveal */}
                        {showAnswer && (
                            <div className="bg-indigo-50 rounded-lg p-6 mb-6 animate-slide-in">
                                <p className="text-sm text-indigo-600 font-medium mb-2">Correct Answer:</p>
                                <p className="text-2xl font-bold text-indigo-900 mb-3">{currentPhrase.answer}</p>
                                <p className="text-gray-700 mb-2">
                                    <span className="font-medium">Notes:</span> {currentPhrase.notes}
                                </p>
                                {userAnswer && (
                                    <div className="mt-3 pt-3 border-t border-indigo-200">
                                        <p className="text-sm text-gray-600 mb-1">Your answer:</p>
                                        <p className="text-lg text-gray-900">{userAnswer}</p>
                                        {calculateSimilarity(userAnswer, currentPhrase.answer) >= 0.8 ? (
                                            <p className="text-green-600 font-medium mt-2">âœ… Excellent!</p>
                                        ) : (
                                            <p className="text-orange-600 font-medium mt-2">ðŸ“ Keep practicing!</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Action Buttons */}
                        <div className="flex space-x-3">
                            {!showAnswer ? (
                                <button
                                    onClick={handleCheckAnswer}
                                    disabled={!userAnswer.trim()}
                                    className={`flex-1 px-6 py-3 rounded-lg font-semibold transition ${
                                        userAnswer.trim()
                                            ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleNext}
                                    className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                                >
                                    Next Card â†’
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Queue Overview */}
                    <div className="bg-gray-100 rounded-lg p-4">
                        <p className="text-sm text-gray-600 mb-2">
                            <strong>Training Queue:</strong> This queue prioritizes phrases you've struggled with most.
                        </p>
                        <div className="flex flex-wrap gap-2">
                            {queue.map((phrase, idx) => {
                                const progress = StorageManager.getPhrases()[phrase.phraseId];
                                const acc = progress ? (progress.correct / progress.attempts * 100) : 0;
                                
                                return (
                                    <div
                                        key={phrase.phraseId}
                                        className={`px-3 py-1 rounded text-xs font-medium ${
                                            idx === currentIndex ? 'bg-indigo-600 text-white' :
                                            acc >= 80 ? 'bg-green-200 text-green-800' :
                                            acc >= 60 ? 'bg-yellow-200 text-yellow-800' :
                                            'bg-red-200 text-red-800'
                                        }`}
                                    >
                                        {idx + 1}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== REVIEW PAGE ====================
        
        function ReviewPage({ onBack }) {
            const weakPhrases = StorageManager.getWeakPhrases(15);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswer, setUserAnswer] = useState('');
            const [showAnswer, setShowAnswer] = useState(false);

            if (weakPhrases.length === 0) {
                return (
                    <div className="text-center py-12">
                        <div className="text-6xl mb-4">ðŸŽ‰</div>
                        <h3 className="text-2xl font-bold text-gray-900 mb-2">
                            No phrases need review!
                        </h3>
                        <p className="text-gray-600 mb-6">
                            You're doing great! Complete more scenarios to build your vocabulary.
                        </p>
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700"
                        >
                            Back to Home
                        </button>
                    </div>
                );
            }

            const currentPhrase = weakPhrases[currentIndex];
            const accuracy = currentPhrase.attempts > 0 ? (currentPhrase.correct / currentPhrase.attempts * 100) : 0;

            const handleCheckAnswer = () => {
                setShowAnswer(true);
            };

            const handleNext = () => {
                const similarity = calculateSimilarity(userAnswer, currentPhrase.phrase);
                const correct = similarity >= 0.8;

                StorageManager.savePhraseProgress(currentPhrase.id, {
                    correct,
                    similarity,
                    phrase: currentPhrase.phrase,
                    translation: currentPhrase.translation,
                    scenario: currentPhrase.scenario
                });

                setUserAnswer('');
                setShowAnswer(false);
                setCurrentIndex((prev) => (prev + 1) % weakPhrases.length);
            };

            const calculateSimilarity = (answer, correct) => {
                const a = answer.toLowerCase().trim().replace(/\s+/g, ' ');
                const c = correct.toLowerCase().trim().replace(/\s+/g, ' ');
                
                if (a === c) return 1.0;
                
                const aWords = a.split(' ');
                const cWords = c.split(' ');
                const matches = aWords.filter(word => cWords.includes(word)).length;
                
                return matches / Math.max(aWords.length, cWords.length);
            };

            return (
                <div>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-900">Micro-Drills Review</h2>
                                <p className="text-gray-600">Practice your weak points from all scenarios</p>
                            </div>
                            <button
                                onClick={onBack}
                                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                            >
                                â† Back
                            </button>
                        </div>
                    </div>

                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-semibold text-gray-900">
                                Randomized Weak Points ({weakPhrases.length} phrases)
                            </h3>
                            <div className="text-sm text-gray-600">
                                Card {currentIndex + 1} of {weakPhrases.length}
                            </div>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                                className="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                                style={{ width: `${((currentIndex + 1) / weakPhrases.length) * 100}%` }}
                            />
                        </div>
                    </div>

                    {/* Flashcard */}
                    <div className="bg-white rounded-xl shadow-xl p-8 border-2 border-orange-200">
                        {/* Metadata */}
                        <div className="mb-4 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold">
                                    Needs Practice
                                </span>
                                <span className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">
                                    from {currentPhrase.scenario}
                                </span>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                accuracy >= 70 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                            }`}>
                                {Math.round(accuracy)}% accuracy
                            </span>
                        </div>

                        {/* Question */}
                        <div className="mb-6">
                            <p className="text-gray-500 text-sm font-medium mb-2">Translate to Vietnamese:</p>
                            <p className="text-3xl font-bold text-gray-900">{currentPhrase.translation}</p>
                        </div>

                        {/* Answer Input */}
                        <div className="mb-6">
                            <input
                                type="text"
                                value={userAnswer}
                                onChange={(e) => setUserAnswer(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter' && !showAnswer && userAnswer.trim()) {
                                        handleCheckAnswer();
                                    }
                                }}
                                disabled={showAnswer}
                                placeholder="Type your answer..."
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                            />
                        </div>

                        {/* Answer Reveal */}
                        {showAnswer && (
                            <div className="bg-green-50 rounded-lg p-6 mb-6 animate-slide-in">
                                <p className="text-sm text-green-600 font-medium mb-2">Correct Answer:</p>
                                <p className="text-2xl font-bold text-green-900 mb-3">{currentPhrase.phrase}</p>
                                {userAnswer && (
                                    <div className="mt-3 pt-3 border-t border-green-200">
                                        <p className="text-sm text-gray-600 mb-1">Your answer:</p>
                                        <p className="text-lg text-gray-900">{userAnswer}</p>
                                        {calculateSimilarity(userAnswer, currentPhrase.phrase) >= 0.8 ? (
                                            <p className="text-green-600 font-medium mt-2">âœ… Great job!</p>
                                        ) : (
                                            <p className="text-orange-600 font-medium mt-2">ðŸ“ Review and try again!</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Actions */}
                        <div className="flex space-x-3">
                            {!showAnswer ? (
                                <button
                                    onClick={handleCheckAnswer}
                                    disabled={!userAnswer.trim()}
                                    className={`flex-1 px-6 py-3 rounded-lg font-semibold transition ${
                                        userAnswer.trim()
                                            ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleNext}
                                    className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                                >
                                    Next Card â†’
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== DASHBOARD PAGE ====================
        
        function DashboardPage({ stats, onBack }) {
            const phrases = StorageManager.getPhrases();
            const totalPhrases = Object.keys(phrases).length;
            const mastered = Object.values(phrases).filter(p => p.repetitions >= 3).length;
            const learning = totalPhrases - mastered;

            return (
                <div>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-900">Weekly Dashboard</h2>
                                <p className="text-gray-600">Your learning progress this week</p>
                            </div>
                            <button
                                onClick={onBack}
                                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                            >
                                â† Back
                            </button>
                        </div>
                    </div>

                    {/* Key Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-blue-100 text-sm font-medium mb-2">Scenarios Completed</p>
                            <p className="text-5xl font-bold mb-2">{stats.scenariosCompleted}</p>
                            <p className="text-blue-100 text-sm">this week</p>
                        </div>

                        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-green-100 text-sm font-medium mb-2">Avg Response Time</p>
                            <p className="text-5xl font-bold mb-2">{stats.avgResponseTime}s</p>
                            <p className="text-green-100 text-sm">per phrase</p>
                        </div>

                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-purple-100 text-sm font-medium mb-2">Politeness Accuracy</p>
                            <p className="text-5xl font-bold mb-2">{stats.politenessAccuracy}%</p>
                            <p className="text-purple-100 text-sm">formal expressions</p>
                        </div>

                        <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-orange-100 text-sm font-medium mb-2">Recovery Score</p>
                            <p className="text-5xl font-bold mb-2">{stats.recoveryScore || 0}</p>
                            <p className="text-orange-100 text-sm">from mistakes</p>
                        </div>
                    </div>

                    {/* Progress Overview */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold text-gray-900 mb-4">Learning Progress</h3>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-gray-700">Mastered</span>
                                        <span className="text-sm font-bold text-green-600">{mastered} phrases</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                            className="bg-green-500 h-3 rounded-full transition-all duration-500"
                                            style={{ width: `${totalPhrases > 0 ? (mastered / totalPhrases * 100) : 0}%` }}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-gray-700">Learning</span>
                                        <span className="text-sm font-bold text-orange-600">{learning} phrases</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                            className="bg-orange-500 h-3 rounded-full transition-all duration-500"
                                            style={{ width: `${totalPhrases > 0 ? (learning / totalPhrases * 100) : 0}%` }}
                                        />
                                    </div>
                                </div>

                                <div className="pt-4 border-t border-gray-200">
                                    <div className="flex items-center justify-between">
                                        <span className="text-sm font-medium text-gray-700">Total Vocabulary</span>
                                        <span className="text-2xl font-bold text-indigo-600">{totalPhrases}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold text-gray-900 mb-4">Weekly Goals</h3>
                            <div className="space-y-4">
                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        stats.scenariosCompleted >= 5 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {stats.scenariosCompleted >= 5 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">Complete 5 scenarios</p>
                                        <p className="text-sm text-gray-600">{stats.scenariosCompleted}/5 done</p>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        stats.politenessAccuracy >= 90 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {stats.politenessAccuracy >= 90 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">90% politeness accuracy</p>
                                        <p className="text-sm text-gray-600">{stats.politenessAccuracy}% achieved</p>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        stats.avgResponseTime <= 8 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {stats.avgResponseTime <= 8 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">Response time under 8s</p>
                                        <p className="text-sm text-gray-600">{stats.avgResponseTime}s average</p>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        mastered >= 20 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {mastered >= 20 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">Master 20 phrases</p>
                                        <p className="text-sm text-gray-600">{mastered}/20 mastered</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Insights */}
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-xl p-8 text-white">
                        <h3 className="text-2xl font-bold mb-4">ðŸ’¡ Weekly Insights</h3>
                        <div className="space-y-3">
                            {stats.scenariosCompleted >= 5 && (
                                <p className="text-indigo-100">
                                    ðŸŽ‰ Great work this week! You've completed {stats.scenariosCompleted} scenarios.
                                </p>
                            )}
                            {stats.politenessAccuracy >= 85 && (
                                <p className="text-indigo-100">
                                    ðŸ‘” Excellent politeness awareness! You're using formal Vietnamese naturally.
                                </p>
                            )}
                            {stats.avgResponseTime <= 10 && (
                                <p className="text-indigo-100">
                                    âš¡ Your response time is improving! Phrases are becoming more automatic.
                                </p>
                            )}
                            {mastered >= 15 && (
                                <p className="text-indigo-100">
                                    ðŸ† You've mastered {mastered} phrases! Keep up the momentum.
                                </p>
                            )}
                            {stats.scenariosCompleted < 3 && (
                                <p className="text-indigo-100">
                                    ðŸ“š Try to complete at least 3 scenarios this week for better progress.
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== RENDER APP ====================
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
