<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnamese Conversation Mastery</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .scenario-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .scenario-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
        }
        .blank-input {
            border-bottom: 2px solid #e5e7eb;
            transition: border-color 0.2s;
        }
        .blank-input:focus {
            outline: none;
            border-bottom-color: #4f46e5;
        }
        .blank-input.correct {
            border-bottom-color: #10b981;
            background-color: #d1fae5;
        }
        .blank-input.incorrect {
            border-bottom-color: #ef4444;
            background-color: #fee2e2;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .progress-ring {
            transition: stroke-dashoffset 0.5s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== DATA STRUCTURES ====================
        
        // Spaced Repetition Algorithm (SM-2)
        class SpacedRepetition {
            static calculateNextReview(quality, repetitions, easeFactor, interval) {
                let newEaseFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (newEaseFactor < 1.3) newEaseFactor = 1.3;

                let newRepetitions = repetitions;
                let newInterval = interval;

                if (quality < 3) {
                    newRepetitions = 0;
                    newInterval = 1;
                } else {
                    newRepetitions += 1;
                    if (newRepetitions === 1) {
                        newInterval = 1;
                    } else if (newRepetitions === 2) {
                        newInterval = 6;
                    } else {
                        newInterval = Math.round(interval * newEaseFactor);
                    }
                }

                const nextReviewDate = new Date();
                nextReviewDate.setMinutes(nextReviewDate.getMinutes() + newInterval);

                return {
                    easeFactor: newEaseFactor,
                    repetitions: newRepetitions,
                    interval: newInterval,
                    nextReview: nextReviewDate.toISOString()
                };
            }
        }

        // Storage Manager
        class StorageManager {
            static KEYS = {
                PHRASES: 'viet_phrases',
                SIMULATIONS: 'viet_simulations',
                WEEKLY_STATS: 'viet_weekly_stats',
                SRS_QUEUE: 'viet_srs_queue'
            };

            static getPhrases() {
                const data = localStorage.getItem(this.KEYS.PHRASES);
                return data ? JSON.parse(data) : {};
            }

            static savePhraseProgress(phraseId, result) {
                const phrases = this.getPhrases();
                const existing = phrases[phraseId] || {
                    easeFactor: 2.5,
                    repetitions: 0,
                    interval: 0,
                    nextReview: new Date().toISOString(),
                    attempts: 0,
                    correct: 0
                };

                const quality = result.correct ? 5 : Math.floor((result.similarity || 0) * 5);
                const updated = SpacedRepetition.calculateNextReview(
                    quality,
                    existing.repetitions,
                    existing.easeFactor,
                    existing.interval
                );

                phrases[phraseId] = {
                    ...updated,
                    lastReview: new Date().toISOString(),
                    attempts: existing.attempts + 1,
                    correct: existing.correct + (result.correct ? 1 : 0),
                    phrase: result.phrase,
                    translation: result.translation,
                    scenario: result.scenario
                };

                localStorage.setItem(this.KEYS.PHRASES, JSON.stringify(phrases));
                return phrases[phraseId];
            }

            static saveSimulation(scenarioId, simulationData) {
                const simulations = JSON.parse(localStorage.getItem(this.KEYS.SIMULATIONS) || '{}');
                if (!simulations[scenarioId]) {
                    simulations[scenarioId] = [];
                }
                simulations[scenarioId].push({
                    ...simulationData,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem(this.KEYS.SIMULATIONS, JSON.stringify(simulations));
            }

            static getSimulations(scenarioId) {
                const simulations = JSON.parse(localStorage.getItem(this.KEYS.SIMULATIONS) || '{}');
                return simulations[scenarioId] || [];
            }

            static getWeakPhrases(limit = 10) {
                const phrases = this.getPhrases();
                const weak = Object.entries(phrases)
                    .filter(([_, data]) => {
                        const accuracy = data.attempts > 0 ? data.correct / data.attempts : 0;
                        return accuracy < 0.7 || data.repetitions < 2;
                    })
                    .sort((a, b) => {
                        const accA = a[1].attempts > 0 ? a[1].correct / a[1].attempts : 0;
                        const accB = b[1].attempts > 0 ? b[1].correct / b[1].attempts : 0;
                        return accA - accB;
                    })
                    .slice(0, limit);
                
                return weak.map(([id, data]) => ({ id, ...data }));
            }

            static getWeeklyStats() {
                const data = localStorage.getItem(this.KEYS.WEEKLY_STATS);
                if (!data) return this.initializeWeeklyStats();
                return JSON.parse(data);
            }

            static initializeWeeklyStats() {
                const stats = {
                    scenariosCompleted: 0,
                    avgResponseTime: 0,
                    politenessAccuracy: 0,
                    recoveryScore: 0,
                    weekStart: new Date().toISOString()
                };
                localStorage.setItem(this.KEYS.WEEKLY_STATS, JSON.stringify(stats));
                return stats;
            }

            static updateWeeklyStats(update) {
                const stats = this.getWeeklyStats();
                const updated = { ...stats, ...update };
                localStorage.setItem(this.KEYS.WEEKLY_STATS, JSON.stringify(updated));
                return updated;
            }

            static getSRSQueue() {
                const phrases = this.getPhrases();
                const now = new Date();
                const due = [];

                for (const [id, data] of Object.entries(phrases)) {
                    const nextReview = new Date(data.nextReview);
                    if (nextReview <= now) {
                        due.push({ id, ...data });
                    }
                }

                return due;
            }
        }

        // Scenarios Data
        const TRAVEL_SCENARIOS = [
            {
                id: 'reconnecting',
                title: 'Gáº·p láº¡i báº¡n cÅ©',
                description: 'Reconnecting and Social Catch-Ups',
                icon: 'ðŸ‘‹',
                difficulty: 'intermediate',
                objectives: ['Catch up with old friends', 'Discuss work-life changes', 'Express opinions on lifestyle choices'],
                estimatedTime: '10 min'
            },
            {
                id: 'workplace_meeting',
                title: 'Há»p nhÃ³m cÃ´ng viá»‡c',
                description: 'Workplace Meetings and Professional Communication',
                icon: 'ðŸ’¼',
                difficulty: 'intermediate',
                objectives: ['Discuss project progress', 'Propose and evaluate strategies', 'Assign responsibilities professionally'],
                estimatedTime: '10 min'
            },
            {
                id: 'restaurant_order',
                title: 'ThuÃª nhÃ  - ThÆ°Æ¡ng lÆ°á»£ng',
                description: 'Renting, Contracts, and Negotiation',
                icon: 'ðŸ ',
                difficulty: 'intermediate',
                objectives: ['Negotiate rent and contract terms', 'Discuss deposit and payment conditions', 'Clarify repair responsibilities and refund clauses'],
                estimatedTime: '12 min'
            },
            {
                id: 'taxi_directions',
                title: 'Taxi - Chá»‰ Ä‘Æ°á»ng',
                description: 'Giving directions to a taxi driver',
                icon: 'ðŸš•',
                difficulty: 'intermediate',
                objectives: ['State destination clearly', 'Negotiate price', 'Handle route changes'],
                estimatedTime: '7 min'
            },
            {
                id: 'market_shopping',
                title: 'Chá»£ - Mua sáº¯m',
                description: 'Shopping at a local market',
                icon: 'ðŸ›’',
                difficulty: 'intermediate',
                objectives: ['Bargain prices', 'Ask about products', 'Complete transactions'],
                estimatedTime: '15 min'
            },
            {
                id: 'tourist_info',
                title: 'Du lá»‹ch - Há»i thÃ´ng tin',
                description: 'Asking for tourist information',
                icon: 'ðŸ—ºï¸',
                difficulty: 'intermediate',
                objectives: ['Request recommendations', 'Ask directions', 'Understand local customs'],
                estimatedTime: '10 min'
            }
        ];

        // Sample Dialogues Database
        const SAMPLE_DIALOGUES = {
            'reconnecting': {
                scenario: 'Gáº·p láº¡i báº¡n cÅ©',
                context: 'Anna runs into her old friend Minh and they catch up after not seeing each other for three years.',
                dialogue: [
                    { speaker: 'Minh', text: 'á»¦a, Anna pháº£i khÃ´ng? LÃ¢u quÃ¡ khÃ´ng gáº·p!' },
                    { speaker: 'Anna', text: 'Trá»i Æ¡i, Minh! ÄÃºng rá»“i, cÅ©ng pháº£i ba nÄƒm rá»“i nhá»‰?' },
                    { speaker: 'Minh', text: 'á»ª, tá»« khi báº¡n chuyá»ƒn cÃ´ng ty lÃ  mÃ¬nh khÃ´ng gáº·p láº¡i. Dáº¡o nÃ y báº¡n tháº¿ nÃ o?' },
                    { speaker: 'Anna', text: 'MÃ¬nh khÃ¡ báº­n, vÃ¬ cÃ´ng viá»‡c má»›i Ä‘Ã²i há»i nhiá»u [BLANK1] hÆ¡n nÃªn mÃ¬nh thÆ°á»ng xuyÃªn pháº£i [BLANK2].' },
                    { speaker: 'Minh', text: 'Nghe cÃ³ váº» Ã¡p lá»±c Ä‘áº¥y. NhÆ°ng cháº¯c báº¡n cÅ©ng há»c Ä‘Æ°á»£c nhiá»u thá»© má»›i?' },
                    { speaker: 'Anna', text: 'ÄÃºng váº­y. Máº·c dÃ¹ cÃ´ng viá»‡c [BLANK3] nhÆ°ng mÃ¬nh cáº£m tháº¥y [BLANK4] hÆ¡n ráº¥t nhiá»u.' },
                    { speaker: 'Minh', text: 'Váº­y thÃ¬ tá»‘t rá»“i. CÃ²n mÃ¬nh thÃ¬ chuyá»ƒn sang lÃ m freelance, nÃªn thá»i gian [BLANK5] hÆ¡n trÆ°á»›c.' },
                    { speaker: 'Anna', text: 'Tháº­t Ã ? KhÃ´ng nhá»¯ng linh hoáº¡t mÃ  cÃ²n [BLANK6] ná»¯a Ä‘Ãºng khÃ´ng?' },
                    { speaker: 'Minh', text: 'á»ª, tá»± do thÃ¬ cÃ³, nhÆ°ng [BLANK7] láº¡i khÃ´ng [BLANK8]. VÃ¬ khÃ´ng cÃ³ lÆ°Æ¡ng cá»‘ Ä‘á»‹nh nÃªn mÃ¬nh pháº£i tá»± tÃ¬m khÃ¡ch hÃ ng.' },
                    { speaker: 'Anna', text: 'Nghe cÅ©ng khÃ¡ [BLANK9]. NhÆ°ng cháº¯c báº¡n thÃ­ch cáº£m giÃ¡c [BLANK10]?' },
                    { speaker: 'Minh', text: 'ÄÃºng lÃ  váº­y. TrÆ°á»›c Ä‘Ã¢y mÃ¬nh lÃ m vÄƒn phÃ²ng suá»‘t ngÃ y, [BLANK11] bÃ¢y giá» mÃ¬nh cÃ³ thá»ƒ lÃ m viá»‡c á»Ÿ quÃ¡n cÃ  phÃª hoáº·c á»Ÿ nhÃ .' },
                    { speaker: 'Anna', text: 'MÃ¬nh nhá»› há»“i Ä‘Ã³ báº¡n hay than lÃ  khÃ´ng cÃ³ thá»i gian cho gia Ä‘Ã¬nh. BÃ¢y giá» cháº¯c [BLANK12] rá»“i?' },
                    { speaker: 'Minh', text: 'Äá»¡ hÆ¡n nhiá»u. Máº·c dÃ¹ thu nháº­p giáº£m má»™t chÃºt nhÆ°ng mÃ¬nh cÃ³ thá»i gian Ä‘Æ°a con Ä‘i há»c vÃ  táº­p thá»ƒ dá»¥c thÆ°á»ng xuyÃªn hÆ¡n.' },
                    { speaker: 'Anna', text: 'Nghe báº¡n nÃ³i mÃ¬nh cÅ©ng [BLANK13] vá» cuá»™c sá»‘ng cá»§a mÃ¬nh. CÃ³ láº½ mÃ¬nh nÃªn [BLANK14] giá»¯a cÃ´ng viá»‡c vÃ  cuá»™c sá»‘ng tá»‘t hÆ¡n.' },
                    { speaker: 'Minh', text: 'Theo mÃ¬nh thÃ¬ má»—i ngÆ°á»i cÃ³ má»™t [BLANK15] khÃ¡c nhau. Quan trá»ng lÃ  mÃ¬nh cáº£m tháº¥y [BLANK16] vá»›i lá»±a chá»n cá»§a mÃ¬nh.' },
                    { speaker: 'Anna', text: 'Báº¡n nÃ³i Ä‘Ãºng. DÃ¹ sao thÃ¬ gáº·p láº¡i báº¡n hÃ´m nay mÃ¬nh ráº¥t vui.' },
                    { speaker: 'Minh', text: 'MÃ¬nh cÅ©ng váº­y. Khi nÃ o ráº£nh thÃ¬ mÃ¬nh gáº·p nhau lÃ¢u hÆ¡n nhÃ©.' },
                    { speaker: 'Anna', text: 'Nháº¥t trÃ­. Láº§n sau mÃ¬nh sáº½ ká»ƒ cho báº¡n nghe ká»¹ hÆ¡n vá» [BLANK17] má»›i cá»§a mÃ¬nh.' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'trÃ¡ch nhiá»‡m',
                        translation: 'responsibility / responsibilities',
                        notes: '"TrÃ¡ch nhiá»‡m" = responsibility. "ÄÃ²i há»i nhiá»u trÃ¡ch nhiá»‡m" = demands a lot of responsibility.',
                        politeness: 'neutral',
                        category: 'work'
                    },
                    {
                        id: 'blank2',
                        answer: 'lÃ m thÃªm giá»',
                        translation: 'to work overtime / work extra hours',
                        notes: '"LÃ m thÃªm giá»" = to do overtime. "ThÆ°á»ng xuyÃªn" before it means "frequently/regularly".',
                        politeness: 'neutral',
                        category: 'work'
                    },
                    {
                        id: 'blank3',
                        answer: 'váº¥t váº£',
                        translation: 'tough / tiring / demanding',
                        notes: '"Váº¥t váº£" describes hard, exhausting work. Often used to acknowledge effort.',
                        politeness: 'neutral',
                        category: 'description'
                    },
                    {
                        id: 'blank4',
                        answer: 'trÆ°á»Ÿng thÃ nh',
                        translation: 'mature / grown / developed',
                        notes: '"TrÆ°á»Ÿng thÃ nh hÆ¡n" = more mature/grown. Used for personal development.',
                        politeness: 'neutral',
                        category: 'personal'
                    },
                    {
                        id: 'blank5',
                        answer: 'linh hoáº¡t',
                        translation: 'flexible',
                        notes: '"Linh hoáº¡t" = flexible. "Thá»i gian linh hoáº¡t" = flexible schedule/hours.',
                        politeness: 'neutral',
                        category: 'lifestyle'
                    },
                    {
                        id: 'blank6',
                        answer: 'tá»± do',
                        translation: 'free / freedom',
                        notes: '"Tá»± do" = freedom/free. Here used as an adjective meaning "free (to do as you wish)".',
                        politeness: 'neutral',
                        category: 'lifestyle'
                    },
                    {
                        id: 'blank7',
                        answer: 'thu nháº­p',
                        translation: 'income / earnings',
                        notes: '"Thu nháº­p" = income. "Thu nháº­p khÃ´ng á»•n Ä‘á»‹nh" = unstable income.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank8',
                        answer: 'á»•n Ä‘á»‹nh',
                        translation: 'stable / steady',
                        notes: '"á»”n Ä‘á»‹nh" = stable. Often paired with "thu nháº­p" (income) or "cÃ´ng viá»‡c" (job).',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank9',
                        answer: 'rá»§i ro',
                        translation: 'risky / risk',
                        notes: '"Rá»§i ro" = risk. "KhÃ¡ rá»§i ro" = quite risky. Used for financial or career risks.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank10',
                        answer: 'tá»± chá»§',
                        translation: 'autonomous / self-directed / in control',
                        notes: '"Tá»± chá»§" = self-directed/autonomous. "Cáº£m giÃ¡c tá»± chá»§" = feeling of being in control.',
                        politeness: 'neutral',
                        category: 'personal'
                    },
                    {
                        id: 'blank11',
                        answer: 'trong khi',
                        translation: 'while / whereas',
                        notes: '"Trong khi" = while/whereas. Used to contrast two situations.',
                        politeness: 'neutral',
                        category: 'grammar'
                    },
                    {
                        id: 'blank12',
                        answer: 'Ä‘á»¡ hÆ¡n',
                        translation: 'better / less difficult / more manageable',
                        notes: '"Äá»¡ hÆ¡n" = improved/better (literally "less hard than before"). Very common in casual speech.',
                        politeness: 'neutral',
                        category: 'comparison'
                    },
                    {
                        id: 'blank13',
                        answer: 'suy nghÄ© láº¡i',
                        translation: 'to reconsider / think again about',
                        notes: '"Suy nghÄ© láº¡i" = to reconsider/rethink. "Vá»" follows to mean "about".',
                        politeness: 'neutral',
                        category: 'reflection'
                    },
                    {
                        id: 'blank14',
                        answer: 'cÃ¢n báº±ng',
                        translation: 'balance / to balance',
                        notes: '"CÃ¢n báº±ng" = balance. "CÃ¢n báº±ng giá»¯a A vÃ  B" = balance between A and B.',
                        politeness: 'neutral',
                        category: 'lifestyle'
                    },
                    {
                        id: 'blank15',
                        answer: 'Æ°u tiÃªn',
                        translation: 'priority / priorities',
                        notes: '"Æ¯u tiÃªn" = priority. "Má»—i ngÆ°á»i cÃ³ má»™t Æ°u tiÃªn" = each person has different priorities.',
                        politeness: 'neutral',
                        category: 'values'
                    },
                    {
                        id: 'blank16',
                        answer: 'hÃ i lÃ²ng',
                        translation: 'satisfied / content / happy with',
                        notes: '"HÃ i lÃ²ng" = satisfied/content. "HÃ i lÃ²ng vá»›i" = satisfied with something.',
                        politeness: 'neutral',
                        category: 'values'
                    },
                    {
                        id: 'blank17',
                        answer: 'dá»± Ã¡n',
                        translation: 'project',
                        notes: '"Dá»± Ã¡n" = project. Used in professional and personal contexts.',
                        politeness: 'neutral',
                        category: 'work'
                    }
                ]
            },
            'workplace_meeting': {
                scenario: 'Há»p nhÃ³m cÃ´ng viá»‡c',
                context: 'A team meeting to update project progress and discuss the marketing strategy for a new product.',
                dialogue: [
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'HÃ´m nay chÃºng ta há»p Ä‘á»ƒ cáº­p nháº­t [BLANK1] dá»± Ã¡n vÃ  tháº£o luáº­n vá» [BLANK2] quáº£ng bÃ¡ sáº£n pháº©m má»›i.' },
                    { speaker: 'Anna', text: 'Theo em, tiáº¿n Ä‘á»™ nhÃ¬n chung khÃ¡ tá»‘t, nhÆ°ng váº«n cÃ²n má»™t sá»‘ váº¥n Ä‘á» cáº§n giáº£i quyáº¿t.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Cá»¥ thá»ƒ lÃ  váº¥n Ä‘á» gÃ¬?' },
                    { speaker: 'Anna', text: 'VÃ¬ [BLANK3] quáº£ng cÃ¡o bá»‹ cáº¯t giáº£m nÃªn [BLANK4] khÃ¡ch hÃ ng tháº¥p hÆ¡n [BLANK5].' },
                    { speaker: 'Minh', text: 'TÃ´i Ä‘á»“ng Ã½ má»™t pháº§n. Tuy nhiÃªn, tÃ´i nghÄ© chÃºng ta cÃ³ thá»ƒ [BLANK6] kÃªnh truyá»n thÃ´ng hiá»‡n táº¡i thay vÃ¬ tÄƒng ngÃ¢n sÃ¡ch.' },
                    { speaker: 'Anna', text: 'Ã kiáº¿n Ä‘Ã³ cÅ©ng [BLANK7]. Máº·c dÃ¹ ngÃ¢n sÃ¡ch [BLANK8] nhÆ°ng náº¿u chÃºng ta táº­p trung vÃ o khÃ¡ch hÃ ng má»¥c tiÃªu thÃ¬ hiá»‡u quáº£ cÃ³ thá»ƒ cao hÆ¡n.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Váº­y ai sáº½ [BLANK9] phÃ¢n tÃ­ch láº¡i nhÃ³m khÃ¡ch hÃ ng má»¥c tiÃªu?' },
                    { speaker: 'Minh', text: 'TÃ´i cÃ³ thá»ƒ phá»¥ trÃ¡ch pháº§n Ä‘Ã³, nhÆ°ng tÃ´i cáº§n thÃªm dá»¯ liá»‡u tá»« bá»™ pháº­n nghiÃªn cá»©u thá»‹ trÆ°á»ng.' },
                    { speaker: 'Anna', text: 'KhÃ´ng nhá»¯ng cáº§n dá»¯ liá»‡u má»›i mÃ  chÃºng ta cÃ²n nÃªn xem láº¡i [BLANK10] tá»« chiáº¿n dá»‹ch trÆ°á»›c.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'ÄÃºng rá»“i. Pháº£n há»“i cá»§a khÃ¡ch hÃ ng khÃ¡ tÃ­ch cá»±c, tuy nhiÃªn [BLANK11] váº«n chÆ°a cao.' },
                    { speaker: 'Minh', text: 'CÃ³ láº½ váº¥n Ä‘á» náº±m á»Ÿ [BLANK12] truyá»n thÃ´ng chÆ°a Ä‘á»§ rÃµ rÃ ng.' },
                    { speaker: 'Anna', text: 'TÃ´i nghÄ© lÃ  chÃºng ta nÃªn [BLANK13] ná»™i dung theo hÆ°á»›ng Ä‘Æ¡n giáº£n vÃ  trá»±c tiáº¿p hÆ¡n.' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Náº¿u thay Ä‘á»•i thÃ´ng Ä‘iá»‡p, chÃºng ta cáº§n Ä‘áº£m báº£o ráº±ng hÃ¬nh áº£nh thÆ°Æ¡ng hiá»‡u váº«n [BLANK14].' },
                    { speaker: 'Minh', text: 'TÃ´i hoÃ n toÃ n Ä‘á»“ng Ã½. Máº·c dÃ¹ cáº§n sÃ¡ng táº¡o nhÆ°ng khÃ´ng nÃªn lÃ m máº¥t [BLANK15] thÆ°Æ¡ng hiá»‡u.' },
                    { speaker: 'Anna', text: 'Váº­y bÆ°á»›c tiáº¿p theo lÃ  gÃ¬ áº¡?' },
                    { speaker: 'TrÆ°á»Ÿng nhÃ³m', text: 'Minh phÃ¢n tÃ­ch láº¡i nhÃ³m khÃ¡ch hÃ ng, Anna Ä‘iá»u chá»‰nh ná»™i dung thÃ´ng Ä‘iá»‡p. Tuáº§n sau chÃºng ta sáº½ há»p láº¡i Ä‘á»ƒ [BLANK16] káº¿t quáº£.' },
                    { speaker: 'Anna', text: 'Dáº¡, tÃ´i sáº½ hoÃ n thÃ nh trÆ°á»›c thá»© SÃ¡u Ä‘á»ƒ cáº£ nhÃ³m cÃ³ thá»i gian xem láº¡i.' },
                    { speaker: 'Minh', text: 'Náº¿u cÃ³ khÃ³ khÄƒn gÃ¬, tÃ´i sáº½ [BLANK17] thÃªm vá»›i anh trÆ°á»›c khi Ä‘Æ°a ra [BLANK18].' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'tiáº¿n Ä‘á»™',
                        translation: 'progress / timeline',
                        notes: '"Tiáº¿n Ä‘á»™" = progress or schedule. "Cáº­p nháº­t tiáº¿n Ä‘á»™" = to update on progress. Common in professional meetings.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank2',
                        answer: 'chiáº¿n lÆ°á»£c',
                        translation: 'strategy',
                        notes: '"Chiáº¿n lÆ°á»£c" = strategy. "Chiáº¿n lÆ°á»£c quáº£ng bÃ¡" = promotion/marketing strategy.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank3',
                        answer: 'ngÃ¢n sÃ¡ch',
                        translation: 'budget',
                        notes: '"NgÃ¢n sÃ¡ch" = budget. "NgÃ¢n sÃ¡ch bá»‹ cáº¯t giáº£m" = budget was cut/reduced.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank4',
                        answer: 'pháº¡m vi tiáº¿p cáº­n',
                        translation: 'reach / scope of reach',
                        notes: '"Pháº¡m vi tiáº¿p cáº­n" = reach (e.g. how many customers you reach). Common in marketing contexts.',
                        politeness: 'neutral',
                        category: 'marketing'
                    },
                    {
                        id: 'blank5',
                        answer: 'dá»± kiáº¿n',
                        translation: 'expected / projected / planned',
                        notes: '"Dá»± kiáº¿n" = expected/projected. "Tháº¥p hÆ¡n dá»± kiáº¿n" = lower than expected.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank6',
                        answer: 'tá»‘i Æ°u hÃ³a',
                        translation: 'to optimize',
                        notes: '"Tá»‘i Æ°u hÃ³a" = to optimize. Used in tech, marketing, and business contexts.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank7',
                        answer: 'há»£p lÃ½',
                        translation: 'reasonable / logical / sensible',
                        notes: '"Há»£p lÃ½" = reasonable/makes sense. "Ã kiáº¿n Ä‘Ã³ cÅ©ng há»£p lÃ½" = That idea is also reasonable.',
                        politeness: 'neutral',
                        category: 'evaluation'
                    },
                    {
                        id: 'blank8',
                        answer: 'háº¡n cháº¿',
                        translation: 'limited / restricted',
                        notes: '"Háº¡n cháº¿" = limited/restricted. "NgÃ¢n sÃ¡ch háº¡n cháº¿" = limited budget. Also a noun meaning limitation.',
                        politeness: 'neutral',
                        category: 'description'
                    },
                    {
                        id: 'blank9',
                        answer: 'chá»‹u trÃ¡ch nhiá»‡m',
                        translation: 'to be responsible for / take responsibility',
                        notes: '"Chá»‹u trÃ¡ch nhiá»‡m" = to be in charge of / responsible for. Used to assign tasks formally.',
                        politeness: 'neutral',
                        category: 'professional'
                    },
                    {
                        id: 'blank10',
                        answer: 'pháº£n há»“i',
                        translation: 'feedback / response',
                        notes: '"Pháº£n há»“i" = feedback or response. "Xem láº¡i pháº£n há»“i" = review feedback.',
                        politeness: 'neutral',
                        category: 'business'
                    },
                    {
                        id: 'blank11',
                        answer: 'tá»· lá»‡ chuyá»ƒn Ä‘á»•i',
                        translation: 'conversion rate',
                        notes: '"Tá»· lá»‡ chuyá»ƒn Ä‘á»•i" = conversion rate. Key metric in marketing/sales.',
                        politeness: 'neutral',
                        category: 'marketing'
                    },
                    {
                        id: 'blank12',
                        answer: 'thÃ´ng Ä‘iá»‡p',
                        translation: 'message / messaging',
                        notes: '"ThÃ´ng Ä‘iá»‡p" = message or brand messaging. "ThÃ´ng Ä‘iá»‡p truyá»n thÃ´ng" = communications message.',
                        politeness: 'neutral',
                        category: 'marketing'
                    },
                    {
                        id: 'blank13',
                        answer: 'Ä‘iá»u chá»‰nh',
                        translation: 'to adjust / to revise',
                        notes: '"Äiá»u chá»‰nh" = to adjust/tweak. "Äiá»u chá»‰nh ná»™i dung" = revise the content.',
                        politeness: 'neutral',
                        category: 'action'
                    },
                    {
                        id: 'blank14',
                        answer: 'nháº¥t quÃ¡n',
                        translation: 'consistent',
                        notes: '"Nháº¥t quÃ¡n" = consistent. "HÃ¬nh áº£nh thÆ°Æ¡ng hiá»‡u váº«n nháº¥t quÃ¡n" = brand image remains consistent.',
                        politeness: 'neutral',
                        category: 'branding'
                    },
                    {
                        id: 'blank15',
                        answer: 'báº£n sáº¯c',
                        translation: 'identity / character / essence',
                        notes: '"Báº£n sáº¯c" = identity/essence. "Báº£n sáº¯c thÆ°Æ¡ng hiá»‡u" = brand identity.',
                        politeness: 'neutral',
                        category: 'branding'
                    },
                    {
                        id: 'blank16',
                        answer: 'Ä‘Ã¡nh giÃ¡',
                        translation: 'to evaluate / to assess / review',
                        notes: '"ÄÃ¡nh giÃ¡" = to evaluate/assess. "ÄÃ¡nh giÃ¡ káº¿t quáº£" = evaluate results.',
                        politeness: 'neutral',
                        category: 'evaluation'
                    },
                    {
                        id: 'blank17',
                        answer: 'trao Ä‘á»•i',
                        translation: 'to discuss / to exchange ideas',
                        notes: '"Trao Ä‘á»•i" = to discuss/exchange. More collaborative than "nÃ³i chuyá»‡n". Common in professional settings.',
                        politeness: 'neutral',
                        category: 'professional'
                    },
                    {
                        id: 'blank18',
                        answer: 'quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng',
                        translation: 'final decision',
                        notes: '"Quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng" = final decision. "ÄÆ°a ra quyáº¿t Ä‘á»‹nh" = to make/give a decision.',
                        politeness: 'neutral',
                        category: 'professional'
                    }
                ]
            },
            'restaurant_order': {
                scenario: 'ThuÃª nhÃ  - ThÆ°Æ¡ng lÆ°á»£ng',
                context: 'Anna visits a landlord to view an apartment and negotiates the rental price, deposit, contract length, and repair responsibilities.',
                dialogue: [
                    { speaker: 'Chá»§ nhÃ ', text: 'ChÃ o báº¡n, báº¡n Ä‘áº¿n xem [BLANK1] pháº£i khÃ´ng?' },
                    { speaker: 'Anna', text: 'VÃ¢ng, tÃ´i cÃ³ háº¹n trÆ°á»›c. CÄƒn há»™ nÃ y váº«n cÃ²n trá»‘ng chá»© áº¡?' },
                    { speaker: 'Chá»§ nhÃ ', text: 'Váº«n cÃ²n. CÄƒn nÃ y rá»™ng 60 mÃ©t vuÃ´ng, cÃ³ hai phÃ²ng ngá»§ vÃ  Ä‘Ã£ Ä‘Æ°á»£c trang bá»‹ Ä‘áº§y Ä‘á»§ ná»™i tháº¥t.' },
                    { speaker: 'Anna', text: 'TÃ´i tháº¥y vá»‹ trÃ­ khÃ¡ thuáº­n tiá»‡n. Tuy nhiÃªn, [BLANK2] má»—i thÃ¡ng lÃ  bao nhiÃªu áº¡?' },
                    { speaker: 'Chá»§ nhÃ ', text: 'GiÃ¡ thuÃª lÃ  15 triá»‡u má»™t thÃ¡ng, chÆ°a bao gá»“m Ä‘iá»‡n nÆ°á»›c.' },
                    { speaker: 'Anna', text: 'VÃ¬ tÃ´i dá»± Ä‘á»‹nh thuÃª lÃ¢u dÃ i nÃªn khÃ´ng biáº¿t giÃ¡ Ä‘Ã³ cÃ³ thá»ƒ [BLANK3] Ä‘Æ°á»£c khÃ´ng?' },
                    { speaker: 'Chá»§ nhÃ ', text: 'ThÃ´ng thÆ°á»ng thÃ¬ giÃ¡ [BLANK4], nhÆ°ng náº¿u báº¡n [BLANK5] Ã­t nháº¥t má»™t nÄƒm thÃ¬ tÃ´i cÃ³ thá»ƒ giáº£m má»™t chÃºt.' },
                    { speaker: 'Anna', text: 'Náº¿u tÃ´i kÃ½ hai nÄƒm thÃ¬ anh cÃ³ thá»ƒ giáº£m xuá»‘ng cÃ²n 14 triá»‡u Ä‘Æ°á»£c khÃ´ng?' },
                    { speaker: 'Chá»§ nhÃ ', text: 'Máº·c dÃ¹ hai nÄƒm lÃ  [BLANK6] khÃ¡ dÃ i nhÆ°ng 14 triá»‡u thÃ¬ hÆ¡i tháº¥p. TÃ´i cÃ³ thá»ƒ giáº£m xuá»‘ng 14 triá»‡u rÆ°á»¡i.' },
                    { speaker: 'Anna', text: 'TÃ´i hiá»ƒu. KhÃ´ng nhá»¯ng tÃ´i thuÃª lÃ¢u dÃ i mÃ  cÃ²n sáºµn sÃ ng [BLANK7] ba thÃ¡ng tiá»n thuÃª.' },
                    { speaker: 'Chá»§ nhÃ ', text: 'Äáº·t cá»c ba thÃ¡ng thÃ¬ cÅ©ng [BLANK8]. Tuy nhiÃªn, báº¡n cáº§n thanh toÃ¡n tiá»n thuÃª vÃ o Ä‘áº§u má»—i thÃ¡ng.' },
                    { speaker: 'Anna', text: 'Äiá»u Ä‘Ã³ khÃ´ng váº¥n Ä‘á» gÃ¬. TÃ´i chá»‰ muá»‘n há»i thÃªm: náº¿u cÃ³ há»ng hÃ³c thÃ¬ ai [BLANK9] [BLANK10]?' },
                    { speaker: 'Chá»§ nhÃ ', text: 'Náº¿u thiáº¿t bá»‹ há»ng do sá»­ dá»¥ng bÃ¬nh thÆ°á»ng thÃ¬ tÃ´i sáº½ chá»‹u [BLANK11] sá»­a chá»¯a. NhÆ°ng náº¿u do báº¡n lÃ m há»ng thÃ¬ báº¡n pháº£i tá»± chi tráº£.' },
                    { speaker: 'Anna', text: 'NhÆ° váº­y thÃ¬ rÃµ rÃ ng rá»“i. Máº·c dÃ¹ giÃ¡ hÆ¡i cao so vá»›i [BLANK12] cá»§a tÃ´i nhÆ°ng cÄƒn há»™ nÃ y [BLANK13] vá»›i nhu cáº§u cá»§a tÃ´i.' },
                    { speaker: 'Chá»§ nhÃ ', text: 'Váº­y chÃºng ta [BLANK14] giÃ¡ 14 triá»‡u rÆ°á»¡i má»™t thÃ¡ng, [BLANK15] hai nÄƒm, Ä‘áº·t cá»c ba thÃ¡ng, Ä‘Æ°á»£c chá»©?' },
                    { speaker: 'Anna', text: 'VÃ¢ng, tÃ´i Ä‘á»“ng Ã½ vá»›i Ä‘iá»u kiá»‡n lÃ  há»£p Ä‘á»“ng ghi rÃµ cÃ¡c [BLANK16] vá» sá»­a chá»¯a vÃ  [BLANK17] tiá»n Ä‘áº·t cá»c.' },
                    { speaker: 'Chá»§ nhÃ ', text: 'KhÃ´ng váº¥n Ä‘á» gÃ¬. TÃ´i sáº½ chuáº©n bá»‹ há»£p Ä‘á»“ng chi tiáº¿t Ä‘á»ƒ báº¡n xem trÆ°á»›c khi kÃ½.' },
                    { speaker: 'Anna', text: 'Cáº£m Æ¡n anh. VÃ¬ tÃ´i muá»‘n Ä‘áº£m báº£o má»i thá»© [BLANK18] nÃªn tÃ´i sáº½ Ä‘á»c ká»¹ trÆ°á»›c khi [BLANK19].' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'cÄƒn há»™',
                        translation: 'apartment / flat',
                        notes: '"CÄƒn há»™" = apartment. "CÄƒn" is a classifier for housing units. Very common in urban rental contexts.',
                        politeness: 'neutral',
                        category: 'housing'
                    },
                    {
                        id: 'blank2',
                        answer: 'tiá»n thuÃª',
                        translation: 'rent / rental payment',
                        notes: '"Tiá»n thuÃª" = rent. "Tiá»n" = money, "thuÃª" = to rent. "Tiá»n thuÃª má»—i thÃ¡ng" = monthly rent.',
                        politeness: 'neutral',
                        category: 'housing'
                    },
                    {
                        id: 'blank3',
                        answer: 'thÆ°Æ¡ng lÆ°á»£ng',
                        translation: 'to negotiate',
                        notes: '"ThÆ°Æ¡ng lÆ°á»£ng" = to negotiate. Used when discussing price or terms in rental, business, or purchasing contexts.',
                        politeness: 'neutral',
                        category: 'negotiation'
                    },
                    {
                        id: 'blank4',
                        answer: 'cá»‘ Ä‘á»‹nh',
                        translation: 'fixed / set',
                        notes: '"Cá»‘ Ä‘á»‹nh" = fixed/set. "GiÃ¡ cá»‘ Ä‘á»‹nh" = fixed price. Opposite of "linh hoáº¡t" (flexible).',
                        politeness: 'neutral',
                        category: 'description'
                    },
                    {
                        id: 'blank5',
                        answer: 'kÃ½ há»£p Ä‘á»“ng',
                        translation: 'to sign a contract',
                        notes: '"KÃ½ há»£p Ä‘á»“ng" = to sign a contract. "KÃ½" = to sign. This phrase captures the action of committing to the agreement.',
                        politeness: 'neutral',
                        category: 'legal'
                    },
                    {
                        id: 'blank6',
                        answer: 'thá»i háº¡n',
                        translation: 'duration / term / period',
                        notes: '"Thá»i háº¡n" = duration or term. "Thá»i háº¡n há»£p Ä‘á»“ng" = contract term. "Hai nÄƒm lÃ  thá»i háº¡n khÃ¡ dÃ i" = two years is quite a long term.',
                        politeness: 'neutral',
                        category: 'time'
                    },
                    {
                        id: 'blank7',
                        answer: 'Ä‘áº·t cá»c',
                        translation: 'to pay a deposit / security deposit',
                        notes: '"Äáº·t cá»c" = to put down a deposit. "Äáº·t cá»c ba thÃ¡ng" = three months as a deposit. Standard in Vietnamese rental agreements.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank8',
                        answer: 'há»£p lÃ½',
                        translation: 'reasonable / fair / sensible',
                        notes: '"Há»£p lÃ½" = reasonable/fair. "CÅ©ng há»£p lÃ½" = also makes sense / is also reasonable. Used to accept a proposal as fair.',
                        politeness: 'neutral',
                        category: 'evaluation'
                    },
                    {
                        id: 'blank9',
                        answer: 'chá»‹u trÃ¡ch nhiá»‡m',
                        translation: 'to be responsible for / take responsibility',
                        notes: '"Chá»‹u trÃ¡ch nhiá»‡m" = to be responsible for. Used to clarify accountability â€” e.g. for repairs or damages.',
                        politeness: 'neutral',
                        category: 'legal'
                    },
                    {
                        id: 'blank10',
                        answer: 'sá»­a chá»¯a',
                        translation: 'repair / to repair / maintenance',
                        notes: '"Sá»­a chá»¯a" = repair/fix. "Chá»‹u trÃ¡ch nhiá»‡m sá»­a chá»¯a" = be responsible for repairs. "Chi phÃ­ sá»­a chá»¯a" = repair costs.',
                        politeness: 'neutral',
                        category: 'housing'
                    },
                    {
                        id: 'blank11',
                        answer: 'chi phÃ­',
                        translation: 'cost / expense',
                        notes: '"Chi phÃ­" = cost/expense. "Chá»‹u chi phÃ­" = to bear/cover the cost. "Chi phÃ­ sá»­a chá»¯a" = repair expenses.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank12',
                        answer: 'ngÃ¢n sÃ¡ch',
                        translation: 'budget',
                        notes: '"NgÃ¢n sÃ¡ch" = budget. "Cao so vá»›i ngÃ¢n sÃ¡ch cá»§a tÃ´i" = high compared to my budget. Used in both personal and business contexts.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank13',
                        answer: 'phÃ¹ há»£p',
                        translation: 'suitable / appropriate / fitting',
                        notes: '"PhÃ¹ há»£p" = suitable/fitting. "PhÃ¹ há»£p vá»›i nhu cáº§u" = suits my needs. Very common when evaluating whether something meets requirements.',
                        politeness: 'neutral',
                        category: 'evaluation'
                    },
                    {
                        id: 'blank14',
                        answer: 'thá»‘ng nháº¥t',
                        translation: 'to agree on / reach consensus',
                        notes: '"Thá»‘ng nháº¥t" = to agree/reach consensus. "ChÃºng ta thá»‘ng nháº¥t" = we agree on. Used to confirm a mutual decision.',
                        politeness: 'neutral',
                        category: 'negotiation'
                    },
                    {
                        id: 'blank15',
                        answer: 'há»£p Ä‘á»“ng',
                        translation: 'contract / agreement',
                        notes: '"Há»£p Ä‘á»“ng" = contract/agreement. "Há»£p Ä‘á»“ng hai nÄƒm" = two-year contract. Always paired with "kÃ½" (to sign) when signing.',
                        politeness: 'neutral',
                        category: 'legal'
                    },
                    {
                        id: 'blank16',
                        answer: 'Ä‘iá»u khoáº£n',
                        translation: 'terms / clauses / conditions',
                        notes: '"Äiá»u khoáº£n" = terms/clauses. "Ghi rÃµ cÃ¡c Ä‘iá»u khoáº£n" = clearly state the terms and conditions. Essential in any contract.',
                        politeness: 'neutral',
                        category: 'legal'
                    },
                    {
                        id: 'blank17',
                        answer: 'hoÃ n tráº£',
                        translation: 'to refund / return (money)',
                        notes: '"HoÃ n tráº£" = to refund/return. "HoÃ n tráº£ tiá»n Ä‘áº·t cá»c" = refund the deposit. An important clause in any rental contract.',
                        politeness: 'neutral',
                        category: 'finance'
                    },
                    {
                        id: 'blank18',
                        answer: 'minh báº¡ch',
                        translation: 'transparent / clear / open',
                        notes: '"Minh báº¡ch" = transparent/clear. "Äáº£m báº£o má»i thá»© minh báº¡ch" = ensure everything is transparent. Used in legal and business contexts.',
                        politeness: 'neutral',
                        category: 'values'
                    },
                    {
                        id: 'blank19',
                        answer: 'quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng',
                        translation: 'final decision',
                        notes: '"Quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng" = final decision. "TrÆ°á»›c khi quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng" = before making the final decision.',
                        politeness: 'neutral',
                        category: 'decision'
                    }
                ]
            },
            'taxi_directions': {
                scenario: 'Taxi - Chá»‰ Ä‘Æ°á»ng',
                context: 'You are taking a taxi from your hotel to Ben Thanh Market.',
                dialogue: [
                    { speaker: 'TÃ i xáº¿', text: 'ChÃ o báº¡n! [BLANK1]?' },
                    { speaker: 'Báº¡n', text: '[BLANK2] Báº¿n ThÃ nh.' },
                    { speaker: 'TÃ i xáº¿', text: 'ÄÆ°á»£c rá»“i. Báº¿n ThÃ nh Market pháº£i khÃ´ng?' },
                    { speaker: 'Báº¡n', text: 'VÃ¢ng, Ä‘Ãºng rá»“i. [BLANK3]?' },
                    { speaker: 'TÃ i xáº¿', text: 'Khoáº£ng 20 phÃºt thÃ´i, náº¿u Ä‘Æ°á»ng khÃ´ng Ä‘Ã´ng.' },
                    { speaker: 'Báº¡n', text: '[BLANK4] nhÃ©!' },
                    { speaker: 'TÃ i xáº¿', text: 'Dáº¡ khÃ´ng sao. TÃ´i Ä‘i Ä‘Æ°á»ng táº¯t cho báº¡n.' },
                    { speaker: 'Báº¡n', text: 'Äáº¿n rá»“i áº¡. [BLANK5]?' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'Báº¡n Ä‘i Ä‘Ã¢u',
                        translation: 'Where are you going?',
                        notes: 'Standard taxi greeting. "Äi Ä‘Ã¢u" = go where',
                        politeness: 'neutral',
                        category: 'greeting'
                    },
                    {
                        id: 'blank2',
                        answer: 'Cho tÃ´i Ä‘áº¿n chá»£',
                        translation: 'Take me to the market',
                        notes: '"Cho tÃ´i Ä‘áº¿n" = take me to. "Chá»£" = market. Common with taxi/directions',
                        politeness: 'neutral',
                        category: 'request'
                    },
                    {
                        id: 'blank3',
                        answer: 'Máº¥t bao lÃ¢u',
                        translation: 'How long does it take?',
                        notes: '"Máº¥t" = to take/lose, "bao lÃ¢u" = how long. Essential travel phrase',
                        politeness: 'neutral',
                        category: 'inquiry'
                    },
                    {
                        id: 'blank4',
                        answer: 'Äi nhanh má»™t chÃºt',
                        translation: 'Go a bit faster/hurry please',
                        notes: '"Nhanh" = fast, "má»™t chÃºt" = a little. Use when in a hurry but stay polite',
                        politeness: 'polite',
                        category: 'request'
                    },
                    {
                        id: 'blank5',
                        answer: 'Bao nhiÃªu tiá»n',
                        translation: 'How much money?',
                        notes: 'Essential phrase for asking prices. "Bao nhiÃªu" = how much, "tiá»n" = money',
                        politeness: 'neutral',
                        category: 'transaction'
                    }
                ]
            },
            'airport_checkin': {
                scenario: 'SÃ¢n bay - LÃ m thá»§ tá»¥c',
                context: 'You are checking in at Tan Son Nhat Airport in Ho Chi Minh City for a domestic flight to Da Nang.',
                dialogue: [
                    { speaker: 'NhÃ¢n viÃªn', text: 'Xin chÃ o! [BLANK1] áº¡?' },
                    { speaker: 'Báº¡n', text: 'ChÃ o chá»‹. [BLANK2] Ä‘áº¿n ÄÃ  Náºµng.' },
                    { speaker: 'NhÃ¢n viÃªn', text: 'VÃ¢ng áº¡. Cho tÃ´i xem há»™ chiáº¿u vÃ  vÃ© cá»§a báº¡n nhÃ©.' },
                    { speaker: 'Báº¡n', text: 'Dáº¡, Ä‘Ã¢y áº¡. [BLANK3] Ä‘Æ°á»£c khÃ´ng áº¡?' },
                    { speaker: 'NhÃ¢n viÃªn', text: 'ÄÆ°á»£c áº¡. Báº¡n cÃ³ hÃ nh lÃ½ kÃ½ gá»­i khÃ´ng?' },
                    { speaker: 'Báº¡n', text: 'CÃ³ áº¡. [BLANK4].' },
                    { speaker: 'NhÃ¢n viÃªn', text: 'VÃ¢ng. ÄÃ¢y lÃ  tháº» lÃªn mÃ¡y bay cá»§a báº¡n. Cá»­a lÃªn mÃ¡y bay sá»‘ 12. [BLANK5] nhÃ©!' },
                    { speaker: 'Báº¡n', text: 'Cáº£m Æ¡n chá»‹!' }
                ],
                blanks: [
                    {
                        id: 'blank1',
                        answer: 'Báº¡n Ä‘i chuyáº¿n bay nÃ o',
                        translation: 'Which flight are you taking?',
                        notes: 'Polite way to ask about flight information. "Chuyáº¿n bay" means "flight".',
                        politeness: 'polite',
                        category: 'greeting'
                    },
                    {
                        id: 'blank2',
                        answer: 'TÃ´i cÃ³ vÃ©',
                        translation: 'I have a ticket',
                        notes: 'Standard phrase when presenting your ticket at check-in.',
                        politeness: 'neutral',
                        category: 'statement'
                    },
                    {
                        id: 'blank3',
                        answer: 'TÃ´i muá»‘n chá»n chá»— ngá»“i cáº¡nh cá»­a sá»•',
                        translation: 'I would like to choose a window seat',
                        notes: '"Chá»— ngá»“i" = seat, "cáº¡nh cá»­a sá»•" = by the window, "lá»‘i Ä‘i" = aisle',
                        politeness: 'polite',
                        category: 'request'
                    },
                    {
                        id: 'blank4',
                        answer: 'TÃ´i cÃ³ má»™t va li',
                        translation: 'I have one suitcase',
                        notes: '"Va li" or "hÃ nh lÃ½" both mean luggage/suitcase',
                        politeness: 'neutral',
                        category: 'statement'
                    },
                    {
                        id: 'blank5',
                        answer: 'ChÃºc báº¡n cÃ³ chuyáº¿n bay tá»‘t Ä‘áº¹p',
                        translation: 'Have a good flight',
                        notes: 'Common farewell at airports. "Tá»‘t Ä‘áº¹p" means good/pleasant',
                        politeness: 'polite',
                        category: 'farewell'
                    }
                ]
            }
        };

        // ==================== MAIN APP ====================
        
        function App() {
            const [currentScreen, setCurrentScreen] = useState('home');
            const [selectedScenario, setSelectedScenario] = useState(null);
            const [weeklyStats, setWeeklyStats] = useState(StorageManager.getWeeklyStats());

            useEffect(() => {
                setWeeklyStats(StorageManager.getWeeklyStats());
            }, [currentScreen]);

            const handleSelectScenario = (scenario) => {
                setSelectedScenario(scenario);
                setCurrentScreen('scenario');
            };

            const handleBackToHome = () => {
                setCurrentScreen('home');
                setSelectedScenario(null);
            };

            const handleGoToReview = () => {
                setCurrentScreen('review');
            };

            const handleGoToDashboard = () => {
                setCurrentScreen('dashboard');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
                    {/* Navigation Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <span className="text-3xl">ðŸ‡»ðŸ‡³</span>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900">
                                            Vietnamese Mastery
                                        </h1>
                                        <p className="text-sm text-gray-600">Simulate â€¢ Analyze â€¢ Train</p>
                                    </div>
                                </div>
                                <nav className="flex items-center space-x-4">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            currentScreen === 'home' 
                                                ? 'bg-indigo-600 text-white' 
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        Home
                                    </button>
                                    <button
                                        onClick={handleGoToReview}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            currentScreen === 'review' 
                                                ? 'bg-indigo-600 text-white' 
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        Review
                                    </button>
                                    <button
                                        onClick={handleGoToDashboard}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            currentScreen === 'dashboard' 
                                                ? 'bg-indigo-600 text-white' 
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        Dashboard
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {currentScreen === 'home' && (
                            <HomePage scenarios={TRAVEL_SCENARIOS} onSelectScenario={handleSelectScenario} />
                        )}
                        {currentScreen === 'scenario' && selectedScenario && (
                            <ScenarioPage scenario={selectedScenario} onBack={handleBackToHome} />
                        )}
                        {currentScreen === 'review' && (
                            <ReviewPage onBack={handleBackToHome} />
                        )}
                        {currentScreen === 'dashboard' && (
                            <DashboardPage stats={weeklyStats} onBack={handleBackToHome} />
                        )}
                    </main>
                </div>
            );
        }

        // ==================== HOME PAGE ====================
        
        function HomePage({ scenarios, onSelectScenario }) {
            const srsQueue = StorageManager.getSRSQueue();
            const phrases = StorageManager.getPhrases();
            const totalPhrases = Object.keys(phrases).length;
            const mastered = Object.values(phrases).filter(p => p.repetitions >= 3).length;

            return (
                <div>
                    {/* Quick Stats Banner */}
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <p className="text-indigo-200 text-sm font-medium mb-1">Due for Review</p>
                                <p className="text-4xl font-bold">{srsQueue.length}</p>
                                <p className="text-indigo-100 text-sm mt-1">phrases ready to practice</p>
                            </div>
                            <div>
                                <p className="text-indigo-200 text-sm font-medium mb-1">Total Progress</p>
                                <p className="text-4xl font-bold">{totalPhrases}</p>
                                <p className="text-indigo-100 text-sm mt-1">phrases learned</p>
                            </div>
                            <div>
                                <p className="text-indigo-200 text-sm font-medium mb-1">Mastery</p>
                                <p className="text-4xl font-bold">{mastered}</p>
                                <p className="text-indigo-100 text-sm mt-1">phrases mastered</p>
                            </div>
                        </div>
                    </div>

                    {/* Scenario Grid */}
                    <div>
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Choose Your Scenario</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {scenarios.map(scenario => (
                                <div
                                    key={scenario.id}
                                    className="scenario-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer border-2 border-transparent hover:border-indigo-500"
                                    onClick={() => onSelectScenario(scenario)}
                                >
                                    <div className="p-6">
                                        <div className="text-5xl mb-4">{scenario.icon}</div>
                                        <h3 className="text-xl font-bold text-gray-900 mb-2">
                                            {scenario.title}
                                        </h3>
                                        <p className="text-gray-600 mb-4">{scenario.description}</p>
                                        
                                        {/* Objectives */}
                                        <div className="mb-4">
                                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Learning Objectives</p>
                                            <ul className="space-y-1">
                                                {scenario.objectives.map((obj, idx) => (
                                                    <li key={idx} className="text-sm text-gray-700 flex items-start">
                                                        <span className="text-green-500 mr-2">âœ“</span>
                                                        {obj}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>

                                        {/* Tags */}
                                        <div className="flex items-center justify-between">
                                            <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                                {scenario.difficulty}
                                            </span>
                                            <span className="text-xs text-gray-500">
                                                â±ï¸ {scenario.estimatedTime}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== SCENARIO PAGE ====================

        const STAGE_META = [
            {
                id: 'learn',
                number: 1,
                label: 'Learn',
                emoji: 'ðŸ“š',
                description: 'Read the full dialogue with all answers revealed. Study key phrases and their meanings.',
                color: 'from-blue-500 to-blue-600',
                lightBg: 'bg-blue-50',
                border: 'border-blue-200',
                badge: 'bg-blue-100 text-blue-700',
                stepColor: 'bg-blue-600',
            },
            {
                id: 'practice',
                number: 2,
                label: 'Practice',
                emoji: 'âœï¸',
                description: 'Multiple-choice flashcards for every blank. Pick the correct Vietnamese phrase.',
                color: 'from-green-500 to-green-600',
                lightBg: 'bg-green-50',
                border: 'border-green-200',
                badge: 'bg-green-100 text-green-700',
                stepColor: 'bg-green-600',
            },
            {
                id: 'test',
                number: 3,
                label: 'Test',
                emoji: 'ðŸŽ¯',
                description: 'Fill in all the blanks from memory. Your answers are scored and saved.',
                color: 'from-purple-500 to-purple-600',
                lightBg: 'bg-purple-50',
                border: 'border-purple-200',
                badge: 'bg-purple-100 text-purple-700',
                stepColor: 'bg-purple-600',
            },
            {
                id: 'rebuild',
                number: 4,
                label: 'Rebuild',
                emoji: 'ðŸ§©',
                description: 'Rearrange scrambled words to reconstruct each sentence in the correct order.',
                color: 'from-teal-500 to-teal-600',
                lightBg: 'bg-teal-50',
                border: 'border-teal-200',
                badge: 'bg-teal-100 text-teal-700',
                stepColor: 'bg-teal-600',
            },
            {
                id: 'listening',
                number: 5,
                label: 'Listening',
                emoji: 'ðŸŽ§',
                description: 'Listen to each sentence read aloud, then rebuild it from the word bank.',
                color: 'from-pink-500 to-pink-600',
                lightBg: 'bg-pink-50',
                border: 'border-pink-200',
                badge: 'bg-pink-100 text-pink-700',
                stepColor: 'bg-pink-600',
            },
        ];

        // â”€â”€ STAGE CONFIGS (extended) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const STAGE_EXTENDED = {
            learn:    { headerBg: 'bg-blue-600',   headerText: 'text-white', iconBg: 'bg-blue-100',   iconText: 'text-blue-600',   accentBar: 'bg-blue-500',  bullets: ['Full Dialogue with highlighted phrases', 'Vocabulary & phrase notes', 'Comprehension quiz'] },
            practice: { headerBg: 'bg-green-600',  headerText: 'text-white', iconBg: 'bg-green-100',  iconText: 'text-green-700',  accentBar: 'bg-green-500', bullets: ['Fill in the blanks', 'Multiple-choice options', 'Instant feedback'] },
            test:     { headerBg: 'bg-purple-600', headerText: 'text-white', iconBg: 'bg-purple-100', iconText: 'text-purple-700', accentBar: 'bg-purple-500',bullets: ['Type full answers from memory', 'Timed challenge', 'Score saved to your profile'] },
            rebuild:  { headerBg: 'bg-orange-500', headerText: 'text-white', iconBg: 'bg-orange-100', iconText: 'text-orange-700', accentBar: 'bg-orange-500',bullets: ['Drag & arrange words', 'Reconstruct sentences', 'Build production fluency'] },
            listening:{ headerBg: 'bg-pink-600',   headerText: 'text-white', iconBg: 'bg-pink-100',   iconText: 'text-pink-700',   accentBar: 'bg-pink-500',  bullets: ['Listen & reconstruct', 'Audio playback controls', 'Available after Stage 3'] },
        };

        const STAGE_SUBLABELS = {
            learn:    'Context & Vocabulary',
            practice: 'Multiple Choice',
            test:     'Test Your Memory',
            rebuild:  'Build Sentences',
            listening:'Audio Practice',
        };

        // â”€â”€ HORIZONTAL LEARNING PATH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function HorizontalLearningPath({ stages, selectedStageId, onSelectStage, completedStages, recommendedStageId }) {
            return (
                <div className="flex items-stretch gap-0">
                    {stages.map((stage, idx) => {
                        const ext = STAGE_EXTENDED[stage.id] || {};
                        const isCompleted = completedStages.has(stage.id);
                        const isRecommended = stage.id === recommendedStageId;
                        const isSelected = stage.id === selectedStageId;

                        let statusLabel = 'Not Started';
                        let statusDot = 'bg-gray-300';
                        if (isCompleted)  { statusLabel = 'Completed';   statusDot = 'bg-emerald-500'; }
                        else if (isSelected) { statusLabel = 'In Progress'; statusDot = 'bg-amber-400'; }

                        return (
                            <React.Fragment key={stage.id}>
                                <button
                                    onClick={() => onSelectStage(stage.id)}
                                    className={`flex-1 text-left rounded-xl border-2 overflow-hidden transition-all duration-200 focus:outline-none
                                        ${isSelected
                                            ? (isRecommended ? 'border-purple-500 shadow-lg' : 'border-indigo-500 shadow-md')
                                            : 'border-gray-200 hover:border-gray-300 hover:shadow-sm'}`}
                                    style={isSelected && isRecommended ? { boxShadow: '0 0 0 3px rgba(168,85,247,0.2), 0 4px 20px rgba(168,85,247,0.15)' } : {}}
                                >
                                    {/* Colored header strip */}
                                    <div className={`px-3 py-2.5 ${isSelected ? ext.headerBg : 'bg-gray-100'} ${isSelected ? ext.headerText : 'text-gray-500'}`}>
                                        <div className="flex items-center gap-2">
                                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                                                ${isSelected ? 'bg-white bg-opacity-30 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                                {stage.number}
                                            </span>
                                            <div>
                                                <p className={`text-xs font-bold leading-tight ${isSelected ? 'text-white' : 'text-gray-700'}`}>{stage.label}</p>
                                                <p className={`text-xs leading-tight ${isSelected ? 'text-white text-opacity-80 opacity-80' : 'text-gray-400'}`}>{STAGE_SUBLABELS[stage.id]}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Body */}
                                    <div className="bg-white px-3 py-3">
                                        {/* Status row */}
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-1.5">
                                                <span className={`w-2 h-2 rounded-full ${statusDot}`}/>
                                                <span className="text-xs font-medium text-gray-500">{statusLabel}</span>
                                            </div>

                                        </div>

                                        {/* Progress bar if in-progress */}
                                        {isSelected && !isCompleted && (
                                            <div className="mt-2 h-1 bg-gray-100 rounded-full overflow-hidden">
                                                <div className={`h-full rounded-full ${ext.accentBar}`} style={{ width: '30%' }} />
                                            </div>
                                        )}


                                    </div>
                                </button>

                                {/* Arrow connector */}
                                {idx < stages.length - 1 && (
                                    <div className="flex items-center justify-center w-6 flex-shrink-0 text-gray-300 text-lg font-light select-none">â€º</div>
                                )}
                            </React.Fragment>
                        );
                    })}
                </div>
            );
        }

        function ScenarioPage({ scenario, onBack }) {
            const [activeStage, setActiveStage] = useState(null);
            const [selectedOverviewStage, setSelectedOverviewStage] = useState('learn');
            const [showSpeedTest, setShowSpeedTest] = useState(false);
            const [simulationResults, setSimulationResults] = useState(null);
            const [completedStages] = useState(new Set());

            const dialogue = SAMPLE_DIALOGUES[scenario.id] || SAMPLE_DIALOGUES['restaurant_order'];

            const handleSimulationComplete = (results) => {
                setSimulationResults(results);
                StorageManager.saveSimulation(scenario.id, results);
            };

            const goToOverview = () => setActiveStage(null);

            const STAGE_NAV = STAGE_META.map(s => ({ ...s }));
            const recommendedStageId = STAGE_NAV.find(s => !completedStages.has(s.id))?.id || STAGE_NAV[STAGE_NAV.length - 1].id;
            const completedCount = completedStages.size;
            const totalCount = STAGE_META.length;
            const progressPct = Math.round((completedCount / totalCount) * 100);

            const EXTRA_STAGE_META = {
                analyze: { emoji: 'ðŸ“Š', number: 'â€”', label: 'Analyze', badge: 'bg-orange-100 text-orange-700' },
                train:   { emoji: 'ðŸ’ª', number: 'â€”', label: 'Train',   badge: 'bg-indigo-100 text-indigo-700' },
            };

            const renderStageHeader = (stageMeta) => {
                const m = stageMeta || EXTRA_STAGE_META[activeStage] || { emoji: '', number: '', label: activeStage, badge: 'bg-gray-100 text-gray-700' };
                return (
                    <div className="flex items-center justify-between mb-6">
                        <button onClick={goToOverview} className="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                            <span>â†</span><span>Scene Overview</span>
                        </button>
                        <div className="flex items-center space-x-3">
                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${m.badge}`}>
                                {m.emoji} {m.number !== 'â€”' ? `Stage ${m.number} of 5` : m.emoji}
                            </span>
                            <span className="text-xl font-bold text-gray-800">{m.label}</span>
                        </div>
                    </div>
                );
            };

            // â”€â”€ ACTIVE STAGE CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (activeStage) {
                const meta = STAGE_META.find(s => s.id === activeStage);
                return (
                    <div>
                        {renderStageHeader(meta)}
                        {activeStage === 'learn' && <LearnStage dialogue={dialogue} onGoToStage={setActiveStage} />}
                        {activeStage === 'practice' && <PracticeStage dialogue={dialogue} onGoToStage={setActiveStage} />}
                        {activeStage === 'test' && <TestStage scenario={scenario} dialogue={dialogue} onComplete={handleSimulationComplete} onGoToStage={setActiveStage} />}
                        {activeStage === 'rebuild' && <RebuildStage dialogue={dialogue} onBack={goToOverview} onRestart={goToOverview} onNextStage={() => setActiveStage('listening')} />}
                        {activeStage === 'listening' && <ListeningStage dialogue={dialogue} onBack={goToOverview} onRestart={goToOverview} />}
                        {activeStage === 'analyze' && (
                            <div className="bg-white rounded-xl shadow-lg p-8">
                                {simulationResults ? <AnalyzeTab scenario={scenario} results={simulationResults} /> : (
                                    <div className="text-center py-16">
                                        <div className="text-6xl mb-4">ðŸ“Š</div>
                                        <h3 className="text-2xl font-bold text-gray-800 mb-2">No results yet</h3>
                                        <p className="text-gray-500 mb-6">Complete Stage 3 (Test) to see your performance analysis here.</p>
                                        <button onClick={() => setActiveStage('test')} className="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">Go to Stage 3: Test â†’</button>
                                    </div>
                                )}
                            </div>
                        )}
                        {activeStage === 'train' && <div className="bg-white rounded-xl shadow-lg p-8"><TrainTab scenario={scenario} /></div>}
                    </div>
                );
            }

            // â”€â”€ SCENE OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const selMeta = STAGE_META.find(s => s.id === selectedOverviewStage);
            const selExt  = STAGE_EXTENDED[selectedOverviewStage] || {};

            return (
                <div className="space-y-5">

                    {/* â•â• SCENE HEADER â•â• */}
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        {/* Top row */}
                        <div className="px-6 pt-5 pb-4 flex items-start justify-between gap-4">
                            <div className="flex items-center gap-4 min-w-0">
                                <div className="w-14 h-14 rounded-xl bg-amber-50 border border-amber-100 flex items-center justify-center text-3xl flex-shrink-0">
                                    {scenario.icon}
                                </div>
                                <div className="min-w-0">
                                    <h2 className="text-2xl font-bold text-gray-900 leading-tight">{scenario.title}</h2>
                                    <p className="text-sm text-gray-500 mt-0.5">{scenario.description}</p>
                                </div>
                            </div>
                            {/* Meta chips */}
                            <div className="flex items-center gap-6 flex-shrink-0">
                                <div className="text-center">
                                    <p className="text-xs text-gray-400 flex items-center gap-1 justify-center">â± Estimated Time</p>
                                    <p className="text-base font-bold text-gray-800">{scenario.estimatedTime}</p>
                                </div>
                                <div className="text-center">
                                    <p className="text-xs text-gray-400">Your Level</p>
                                    <p className="text-base font-bold text-amber-600 capitalize">{scenario.difficulty}</p>
                                </div>
                                <div className="text-center">
                                    <p className="text-xs text-gray-400 flex items-center gap-1 justify-center">â° Last Practiced</p>
                                    <p className="text-base font-bold text-gray-800">â€”</p>
                                </div>
                                <button onClick={onBack} className="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 border border-gray-200 rounded-lg hover:bg-gray-200 transition flex-shrink-0">
                                    â† Back
                                </button>
                            </div>
                        </div>
                        {/* Progress bar strip */}
                        <div className="px-6 pb-4">
                            <div className="flex items-center gap-3">
                                <div className="flex-1 bg-gray-100 rounded-full h-2.5 max-w-sm">
                                    <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2.5 rounded-full transition-all duration-700" style={{ width: `${progressPct}%` }} />
                                </div>
                                <span className="text-xs text-gray-400">{completedCount}/{totalCount} Stages Complete</span>
                            </div>
                        </div>
                    </div>

                    {/* â•â• SCENE LEARNING PATH â•â• */}
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                        <div className="flex items-center gap-3 mb-4">
                            <span className="text-lg">ðŸŽ¯</span>
                            <div>
                                <h3 className="text-base font-bold text-gray-900">Scene Learning Path</h3>
                                <p className="text-xs text-gray-400">Master this scenario through {totalCount} interactive stages</p>
                            </div>
                        </div>
                        <HorizontalLearningPath
                            stages={STAGE_NAV}
                            selectedStageId={selectedOverviewStage}
                            onSelectStage={setSelectedOverviewStage}
                            completedStages={completedStages}
                            recommendedStageId={recommendedStageId}
                        />
                    </div>

                    {/* â•â• BOTTOM SECTION: Left sidebar + Center + Right sidebar â•â• */}
                    <div className="grid grid-cols-12 gap-5">


                        {/* CENTER: Selected stage detail panel */}
                        <div className="col-span-9">
                            {selMeta && (
                                <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden h-full animate-slide-in">
                                    {/* Panel header */}
                                    <div className={`px-5 py-4 ${selExt.headerBg} ${selExt.headerText}`}>
                                        <div className="flex items-center gap-3">
                                            <div className="w-9 h-9 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-lg">
                                                {selMeta.emoji}
                                            </div>
                                            <div>
                                                <p className="text-white text-opacity-80 text-xs font-medium opacity-80">Stage {selMeta.number} of {totalCount}</p>
                                                <h4 className="text-white font-bold text-base leading-tight">What's Inside: {selMeta.label} Stage</h4>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Content items */}
                                    <div className="p-5 space-y-2">
                                        {(selExt.bullets || [selMeta.description]).map((bullet, i) => (
                                            <div key={i} className="flex items-center justify-between py-3 border-b border-gray-50 last:border-0">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-lg ${selExt.iconBg} ${selExt.iconText} flex items-center justify-center text-sm flex-shrink-0`}>
                                                        {['ðŸ“–','ðŸ“','â“'][i] || 'â€¢'}
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-semibold text-gray-800">{bullet}</p>
                                                        <p className="text-xs text-gray-400">{['With highlighted phrases','Meanings & examples','Test your understanding'][i] || ''}</p>
                                                    </div>
                                                </div>
                                                <span className="text-gray-300 text-lg flex-shrink-0">â€º</span>
                                            </div>
                                        ))}
                                    </div>

                                    {/* CTA */}
                                    <div className="px-5 pb-5">
                                        <button
                                            onClick={() => setActiveStage(selectedOverviewStage)}
                                            className={`w-full py-3 rounded-xl text-white font-bold text-sm transition-all duration-150 ${selExt.headerBg} hover:opacity-90 shadow-sm`}
                                        >
                                            Continue to {selMeta.label} â†’
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* RIGHT: Performance + Recommended */}
                        <div className="col-span-3 space-y-4">
                            {/* Your Performance */}
                            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                                <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 flex items-center gap-1.5">
                                    <span>ðŸ“Š</span> Your Performance
                                </h4>
                                {/* Donut + stats */}
                                <div className="flex items-center gap-4 mb-4">
                                    <div className="relative w-16 h-16 flex-shrink-0">
                                        <svg viewBox="0 0 36 36" className="w-16 h-16 -rotate-90">
                                            <circle cx="18" cy="18" r="15.9" fill="none" stroke="#f3f4f6" strokeWidth="3"/>
                                            <circle cx="18" cy="18" r="15.9" fill="none" stroke="#6366f1" strokeWidth="3"
                                                strokeDasharray={`${progressPct} ${100 - progressPct}`} strokeLinecap="round"/>
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                            <span className="text-xs font-bold text-gray-800">{progressPct}%</span>
                                            <span className="text-xs text-gray-400" style={{fontSize:'7px'}}>Mastery</span>
                                        </div>
                                    </div>
                                    <div className="space-y-1.5">
                                        <div>
                                            <p className="text-xs text-gray-400">Phrases</p>
                                            <p className="text-sm font-bold text-gray-800">{completedCount * 3}<span className="text-gray-400 font-normal">/{totalCount * 3}</span></p>
                                        </div>

                                    </div>
                                </div>
                                <button
                                    onClick={() => setActiveStage('analyze')}
                                    className="w-full text-xs font-semibold text-indigo-600 hover:text-indigo-700 border border-indigo-100 hover:border-indigo-300 rounded-lg py-2 transition-all">
                                    View Detailed Analytics â€º
                                </button>
                            </div>

                            {/* Recommended Next */}
                            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                                <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                                    <span>ðŸ’¡</span> Recommended Next
                                </h4>
                                <div className="space-y-2">
                                    {/* Primary: recommended stage */}
                                    {(() => {
                                        const rec = STAGE_META.find(s => s.id === recommendedStageId);
                                        const recExt = STAGE_EXTENDED[recommendedStageId] || {};
                                        return rec ? (
                                            <div className="border border-purple-200 bg-purple-50 rounded-xl p-3">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="flex items-center gap-2">
                                                        <div className={`w-8 h-8 rounded-lg ${recExt.iconBg} ${recExt.iconText} flex items-center justify-center text-sm`}>{rec.emoji}</div>
                                                        <div>
                                                            <p className="text-xs font-bold text-gray-800">{rec.label}</p>
                                                            <p className="text-xs text-gray-500">{STAGE_SUBLABELS[rec.id]}</p>
                                                        </div>
                                                    </div>
                                                    <span className="text-xs font-bold px-1.5 py-0.5 rounded bg-purple-600 text-white">Priority</span>
                                                </div>

                                            </div>
                                        ) : null;
                                    })()}

                                    {/* Analyze + Train â€” only shown after test completed */}
                                    {simulationResults && (
                                        <>
                                    {/* Analyze */}
                                    <button onClick={() => setActiveStage('analyze')} className="w-full flex items-center gap-2.5 p-2.5 rounded-lg hover:bg-gray-50 transition text-left border border-transparent hover:border-gray-200">
                                        <div className="w-8 h-8 rounded-lg bg-orange-50 flex items-center justify-center text-sm flex-shrink-0">ðŸ“ˆ</div>
                                        <div className="min-w-0 flex-1">
                                            <p className="text-xs font-semibold text-gray-800">Analyze</p>
                                            <p className="text-xs text-gray-400 truncate">Review your test results</p>
                                        </div>
                                        <span className="text-xs text-amber-500 font-medium whitespace-nowrap flex-shrink-0">After Test</span>
                                    </button>

                                    {/* Train */}
                                    <button onClick={() => setActiveStage('train')} className="w-full flex items-center gap-2.5 p-2.5 rounded-lg hover:bg-gray-50 transition text-left border border-transparent hover:border-gray-200">
                                        <div className="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-sm flex-shrink-0">ðŸ’ª</div>
                                        <div className="min-w-0 flex-1">
                                            <p className="text-xs font-semibold text-gray-800">Train Weak Phrases</p>
                                            <p className="text-xs text-gray-400 truncate">Boost low-confidence items</p>
                                        </div>
                                        <span className="text-xs text-gray-400 font-medium flex-shrink-0">SRS</span>
                                    </button>
                                        </>
                                    )}
                                </div>
                            </div>
                            {/* Quick Actions */}
                            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                                <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-1.5">
                                    <span>ðŸ”¥</span> Quick Actions
                                </h4>
                                <div className="grid grid-cols-2 gap-2">
                                    {[
                                        { emoji: 'ðŸƒ', label: 'Flashcards', sub: 'Review phrases', onClick: null },
                                        { emoji: 'âš¡', label: 'Speed Test', sub: '5 min challenge', onClick: () => setShowSpeedTest(true) },
                                        { emoji: 'âŒ', label: 'Wrong Answers', sub: 'Focus practice', onClick: null },
                                        { emoji: 'ðŸ“„', label: 'Download PDF', sub: 'Full transcript', onClick: null },
                                    ].map(qa => (
                                        <button key={qa.label} onClick={qa.onClick || undefined} className="flex flex-col items-center text-center p-2 rounded-lg bg-gray-50 hover:bg-indigo-50 hover:border-indigo-200 border border-transparent transition-all duration-150">
                                            <span className="text-xl mb-1">{qa.emoji}</span>
                                            <p className="text-xs font-semibold text-gray-700 leading-tight">{qa.label}</p>
                                            <p className="text-xs text-gray-400 leading-tight">{qa.sub}</p>
                                        </button>
                                    ))}
                                </div>
                                {showSpeedTest && <VietnameseSpeedTest onClose={() => setShowSpeedTest(false)} />}
                            </div>
                        </div>
                    </div>

                </div>
            );
        }

        // ==================== VIETNAMESE SPEED TEST ====================

        const VIET_200_WORDS = [
            'tÃ´i','báº¡n','anh','chá»‹','em','Ã´ng','bÃ ','há»','chÃºng tÃ´i','chÃºng ta',
            'lÃ ','cÃ³','khÃ´ng','vÃ ','cá»§a','trong','cho','vá»›i','nÃ y','Ä‘Ã³',
            'má»™t','hai','ba','bá»‘n','nÄƒm','sÃ¡u','báº£y','tÃ¡m','chÃ­n','mÆ°á»i',
            'Ä‘Æ°á»£c','lÃ m','Ä‘i','Ä‘áº¿n','vá»','ra','vÃ o','lÃªn','xuá»‘ng','qua',
            'nÃ³i','nghe','tháº¥y','biáº¿t','muá»‘n','cáº§n','pháº£i','cÃ³ thá»ƒ','nÃªn','hÃ£y',
            'nhÃ ','trÆ°á»ng','cÃ´ng viá»‡c','gia Ä‘Ã¬nh','báº¡n bÃ¨','thÃ nh phá»‘','Ä‘áº¥t nÆ°á»›c','tháº¿ giá»›i','cuá»™c sá»‘ng','thá»i gian',
            'Äƒn','uá»‘ng','ngá»§','há»c','chÆ¡i','mua','bÃ¡n','Ä‘á»c','viáº¿t','há»i',
            'tá»‘t','xáº¥u','lá»›n','nhá»','nhiá»u','Ã­t','má»›i','cÅ©','Ä‘áº¹p','vui',
            'hÃ´m nay','ngÃ y mai','hÃ´m qua','bÃ¢y giá»','sau nÃ y','trÆ°á»›c Ä‘Ã¢y','luÃ´n luÃ´n','thÆ°á»ng xuyÃªn','Ä‘Ã´i khi','khÃ´ng bao giá»',
            'ráº¥t','quÃ¡','cÅ©ng','cÃ²n','ná»¯a','thÃ´i','vÃ¬','nÃªn','nhÆ°ng','mÃ ',
            'cáº£m Æ¡n','xin lá»—i','khÃ´ng cÃ³ gÃ¬','vÃ¢ng','dáº¡','khÃ´ng','Ä‘Æ°á»£c rá»“i','táº¡m biá»‡t','xin chÃ o','háº¹n gáº·p láº¡i',
            'tiá»n','giÃ¡','ráº»','Ä‘áº¯t','bao nhiÃªu','máº¥y','sá»‘','láº§n','lÃºc','khi',
            'ngÆ°á»i','con','bá»‘','máº¹','anh trai','chá»‹ gÃ¡i','em trai','em gÃ¡i','vá»£','chá»“ng',
            'xe','Ä‘Æ°á»ng','phá»‘','quÃ¡n','cá»­a hÃ ng','bá»‡nh viá»‡n','ngÃ¢n hÃ ng','khÃ¡ch sáº¡n','sÃ¢n bay','chá»£',
            'sÃ¡ch','bÃ i','tá»«','cÃ¢u','tiáº¿ng Viá»‡t','tiáº¿ng Anh','ngÃ´n ngá»¯','vÄƒn hÃ³a','lá»‹ch sá»­','Ä‘á»‹a lÃ½',
            'trá»i','nÆ°á»›c','lá»­a','Ä‘áº¥t','giÃ³','mÆ°a','náº¯ng','láº¡nh','nÃ³ng','áº¥m',
            'Ä‘áº§u','tay','chÃ¢n','máº¯t','tai','miá»‡ng','mÅ©i','tim','bá»¥ng','lÆ°ng',
            'Ä‘á»','xanh','vÃ ng','tráº¯ng','Ä‘en','xÃ¡m','tÃ­m','cam','há»“ng','nÃ¢u',
            'Äƒn sÃ¡ng','Äƒn trÆ°a','Äƒn tá»‘i','uá»‘ng cÃ  phÃª','Ä‘i lÃ m','vá» nhÃ ','Ä‘i ngá»§','thá»©c dáº­y','táº¯m rá»­a','máº·c quáº§n Ã¡o',
        ];

        function VietnameseSpeedTest({ onClose }) {
            const { useState, useEffect, useRef, useMemo } = React;

            const DURATION_OPTIONS = [
                { label: '1 min',  value: 60   },
                { label: '2 min',  value: 120  },
                { label: '5 min',  value: 300  },
                { label: '10 min', value: 600  },
            ];
            const ROW_HEIGHT = 44; // px â€” height of one word row, used for row-scroll

            const wordList = useMemo(() => {
                // Split every entry by whitespace so "hÃ´m nay" â†’ ["hÃ´m", "nay"]
                const tokens = VIET_200_WORDS.flatMap(w => w.split(/\s+/));
                const flat = tokens.slice();
                for (let i = flat.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [flat[i], flat[j]] = [flat[j], flat[i]];
                }
                // Repeat enough to always have plenty of words
                const repeated = [...flat, ...flat, ...flat];
                return repeated.slice(0, Math.max(400, repeated.length));
            }, []);

            const [selectedDuration, setSelectedDuration] = useState(60);
            const [status, setStatus]           = useState('idle');
            const [typedInput, setTypedInput]   = useState('');
            const [wordIndex, setWordIndex]     = useState(0);
            const [wordResults, setWordResults] = useState({});  // wi -> {correct, typed}
            const [timeLeft, setTimeLeft]       = useState(60);
            const [keystrokes, setKeystrokes]   = useState(0);
            const [startTime, setStartTime]     = useState(null);
            const [caretTick, setCaretTick]     = useState(true); // blinking caret

            const inputRef         = useRef(null);
            const timerRef         = useRef(null);
            const caretTimerRef    = useRef(null);
            const wordsContainerRef = useRef(null);
            const wordRefs         = useRef({});

            // Blink caret
            useEffect(() => {
                if (status === 'running') {
                    caretTimerRef.current = setInterval(() => setCaretTick(t => !t), 530);
                } else {
                    clearInterval(caretTimerRef.current);
                    setCaretTick(true);
                }
                return () => clearInterval(caretTimerRef.current);
            }, [status]);

            // Row-scroll: when active word moves to a new row, scroll that row to the top
            useEffect(() => {
                const el = wordRefs.current[wordIndex];
                const container = wordsContainerRef.current;
                if (!el || !container) return;
                const wordTop = el.offsetTop;
                // Scroll so the row containing the active word is at top of container
                if (wordTop > container.scrollTop + ROW_HEIGHT) {
                    container.scrollTop = wordTop - ROW_HEIGHT;
                }
            }, [wordIndex]);

            const startTest = () => {
                setStatus('running');
                setStartTime(Date.now());
                setTimeLeft(selectedDuration);
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) { clearInterval(timerRef.current); setStatus('done'); return 0; }
                        return prev - 1;
                    });
                }, 1000);
                setTimeout(() => inputRef.current && inputRef.current.focus(), 30);
            };

            useEffect(() => () => { clearInterval(timerRef.current); clearInterval(caretTimerRef.current); }, []);

            const handleInput = (e) => {
                // Start test on very first keystroke (not on focus)
                if (status === 'idle') {
                    startTest();
                }
                if (status === 'done') return;
                const val = e.target.value;

                // Space = commit word
                if (val.endsWith(' ')) {
                    const typed = val.trimEnd();
                    const correct = typed === wordList[wordIndex];
                    setWordResults(prev => ({ ...prev, [wordIndex]: { typed, correct } }));
                    setWordIndex(prev => prev + 1);
                    setTypedInput('');
                    setKeystrokes(prev => prev + typed.length + 1);
                    return;
                }

                setTypedInput(val);
                setKeystrokes(prev => prev + 1);
            };

            // Backspace on empty input = go back one word
            const handleKeyDown = (e) => {
                if (e.key === 'Backspace' && typedInput === '' && wordIndex > 0) {
                    const prevIdx = wordIndex - 1;
                    // Only allow going back if prev word was wrong
                    if (wordResults[prevIdx] && !wordResults[prevIdx].correct) {
                        setWordIndex(prevIdx);
                        setTypedInput(wordResults[prevIdx].typed);
                        setWordResults(prev => { const n = {...prev}; delete n[prevIdx]; return n; });
                    }
                }
            };

            const completedResults = Object.values(wordResults);
            const correctWords = completedResults.filter(r => r.correct).length;
            const wrongWords   = completedResults.filter(r => !r.correct).length;
            const totalWords   = completedResults.length;
            const wpm          = status === 'done'
                ? Math.round(correctWords / (selectedDuration / 60))
                : startTime ? Math.round(correctWords / Math.max((Date.now() - startTime) / 60000, 1/60)) : 0;
            const accuracy     = totalWords > 0 ? Math.round((correctWords / totalWords) * 100) : 0;

            const handleRetry = () => {
                clearInterval(timerRef.current);
                clearInterval(caretTimerRef.current);
                setStatus('idle');
                setTypedInput('');
                setWordIndex(0);
                setWordResults({});
                setTimeLeft(selectedDuration);
                setKeystrokes(0);
                setStartTime(null);
                setCaretTick(true);
                if (wordsContainerRef.current) wordsContainerRef.current.scrollTop = 0;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">

                        {/* Header */}
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center justify-between">
                            <div>
                                <h2 className="text-white font-bold text-lg">âš¡ Vietnamese Speed Test</h2>
                                <p className="text-indigo-200 text-xs mt-0.5">200 most common Vietnamese words</p>
                            </div>
                            <button onClick={onClose} className="text-white text-opacity-70 hover:text-opacity-100 text-2xl leading-none transition">Ã—</button>
                        </div>

                        <div className="p-6">

                            {/* Stats bar */}
                            <div className="grid grid-cols-4 gap-3 mb-5">
                                {[
                                    { label: 'WPM',        value: status === 'idle' ? 'â€”' : wpm,           color: 'text-indigo-600' },
                                    { label: 'Accuracy',   value: status === 'idle' ? 'â€”' : accuracy+'%',  color: 'text-green-600' },
                                    { label: 'Keystrokes', value: status === 'idle' ? 'â€”' : keystrokes,    color: 'text-purple-600' },
                                    { label: 'Time',       value: status === 'done' ? '0s' : timeLeft+'s', color: timeLeft<=10 && status==='running' ? 'text-red-500' : 'text-gray-700' },
                                ].map(s => (
                                    <div key={s.label} className="bg-gray-50 rounded-xl p-3 text-center border border-gray-100">
                                        <p className={`text-2xl font-bold ${s.color}`}>{s.value}</p>
                                        <p className="text-xs text-gray-400 mt-0.5">{s.label}</p>
                                    </div>
                                ))}
                            </div>

                            {/* Duration selector â€” only shown while idle */}
                            {status === 'idle' && (
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="text-xs font-medium text-gray-500 mr-1">Duration:</span>
                                    {DURATION_OPTIONS.map(opt => (
                                        <button
                                            key={opt.value}
                                            onClick={() => { setSelectedDuration(opt.value); setTimeLeft(opt.value); }}
                                            className={`px-3 py-1.5 rounded-lg text-sm font-semibold border transition-colors ${
                                                selectedDuration === opt.value
                                                    ? 'bg-indigo-600 text-white border-indigo-600'
                                                    : 'bg-white text-gray-600 border-gray-200 hover:border-indigo-400 hover:text-indigo-600'
                                            }`}
                                        >
                                            {opt.label}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {/* â”€â”€ WORD DISPLAY â”€â”€ */}
                            <div
                                ref={wordsContainerRef}
                                className="bg-gray-50 rounded-xl border border-gray-200 mb-4 select-none overflow-hidden relative"
                                style={{ height: `${ROW_HEIGHT * 3}px` }}
                            >
                                {/* Fade overlays top/bottom for depth */}
                                <div className="absolute inset-x-0 top-0 h-4 bg-gradient-to-b from-gray-50 to-transparent z-10 pointer-events-none" />
                                <div className="absolute inset-x-0 bottom-0 h-4 bg-gradient-to-t from-gray-50 to-transparent z-10 pointer-events-none" />

                                <div className="flex flex-wrap content-start gap-x-2.5 gap-y-1 px-4 pt-3 pb-3">
                                    {wordList.map((word, wi) => {
                                        const isPast    = wi < wordIndex;
                                        const isCurrent = wi === wordIndex;
                                        const result    = wordResults[wi];
                                        // For current word: per-char colouring
                                        const letters   = word.split('');

                                        return (
                                            <span
                                                key={wi}
                                                ref={el => { if (el) wordRefs.current[wi] = el; }}
                                                className={`inline-flex items-center text-lg font-medium rounded-md px-1 py-0.5 transition-colors duration-75 ${
                                                    isPast
                                                        ? result?.correct
                                                            ? 'text-gray-400'
                                                            : 'text-red-400 border-b-2 border-red-400'
                                                        : isCurrent
                                                        ? 'text-gray-800'
                                                        : 'text-gray-400'
                                                }`}
                                                style={isCurrent ? { position: 'relative' } : {}}
                                            >
                                                {isCurrent ? (
                                                    <>
                                                        {letters.map((ch, ci) => {
                                                            const typed = typedInput[ci];
                                                            let cls = 'text-gray-400';
                                                            if (typed !== undefined) {
                                                                cls = typed === ch ? 'text-gray-800' : 'text-red-500';
                                                            }
                                                            const isCaret = ci === typedInput.length;
                                                            return (
                                                                <span key={ci} style={{ position: 'relative' }}>
                                                                    {isCaret && (
                                                                        <span style={{
                                                                            position: 'absolute',
                                                                            left: '-1px',
                                                                            top: '1px',
                                                                            bottom: '1px',
                                                                            width: '2px',
                                                                            background: '#6366f1',
                                                                            borderRadius: '1px',
                                                                            opacity: caretTick ? 1 : 0,
                                                                            transition: 'opacity 0.1s',
                                                                        }} />
                                                                    )}
                                                                    <span className={cls}>{ch}</span>
                                                                </span>
                                                            );
                                                        })}
                                                        {/* Caret after last char */}
                                                        {typedInput.length >= letters.length && (
                                                            <span style={{
                                                                display: 'inline-block',
                                                                width: '2px',
                                                                height: '1.1em',
                                                                background: '#6366f1',
                                                                borderRadius: '1px',
                                                                verticalAlign: 'text-bottom',
                                                                marginLeft: '1px',
                                                                opacity: caretTick ? 1 : 0,
                                                                transition: 'opacity 0.1s',
                                                            }} />
                                                        )}
                                                        {/* Overflow chars typed beyond word length */}
                                                        {typedInput.slice(letters.length).split('').map((ch, oi) => (
                                                            <span key={'o'+oi} className="text-red-500">{ch}</span>
                                                        ))}
                                                    </>
                                                ) : word}
                                            </span>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* â”€â”€ INPUT â”€â”€ */}
                            {status !== 'done' && (
                                <input
                                    ref={inputRef}
                                    type="text"
                                    value={typedInput}
                                    onChange={handleInput}
                                    onKeyDown={handleKeyDown}

                                    disabled={status === 'done'}
                                    placeholder={status === 'idle' ? 'Click here to start â€” timer begins on first keystroke' : ''}
                                    className={`w-full px-4 py-3 text-base rounded-xl border-2 outline-none transition-colors font-medium ${
                                        status === 'idle'
                                            ? 'border-gray-200 bg-gray-50 text-gray-500 cursor-pointer'
                                            : 'border-indigo-400 bg-white text-gray-900 focus:border-indigo-500'
                                    }`}
                                />
                            )}

                            {/* â”€â”€ RESULTS â”€â”€ */}
                            {status === 'done' && (
                                <div className="animate-slide-in space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
                                            <p className="text-3xl font-bold text-green-700">{correctWords}</p>
                                            <p className="text-sm text-green-600 mt-1">Correct Words âœ…</p>
                                        </div>
                                        <div className="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                                            <p className="text-3xl font-bold text-red-600">{wrongWords}</p>
                                            <p className="text-sm text-red-500 mt-1">Wrong Words âŒ</p>
                                        </div>
                                    </div>
                                    <div className="bg-indigo-50 border border-indigo-200 rounded-xl p-4 text-center">
                                        <p className="text-4xl font-bold text-indigo-700">{wpm} <span className="text-lg font-semibold">WPM</span></p>
                                        <p className="text-sm text-indigo-500 mt-1">{accuracy}% accuracy Â· {keystrokes} keystrokes</p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={handleRetry} className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition">
                                            ðŸ” Try Again
                                        </button>
                                        <button onClick={onClose} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold transition">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            )}

                            {status !== 'done' && (
                                <p className="text-xs text-gray-400 text-center mt-3">
                                    {status === 'idle' ? 'Timer starts when you begin typing' : `Type each word and press Space to advance Â· ${totalWords} words typed`}
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== STAGE 1: LEARN ====================

        function LearnStage({ dialogue, onGoToStage }) {
            return (
                <div>
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">ðŸ“š Stage 1: Learn</h3>
                                <p className="text-gray-600">Read the full dialogue â€” all answers are shown. Study each key phrase carefully.</p>
                            </div>
                            <div className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-semibold">
                                Step 1 of 5
                            </div>
                        </div>
                    </div>

                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6">
                        <p className="text-lg text-gray-700 mb-2">
                            <strong>Context:</strong> {dialogue.context}
                        </p>
                    </div>

                    {/* Full dialogue with answers revealed */}
                    <div className="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-8 mb-6">
                        <div className="space-y-4">
                            {dialogue.dialogue.map((line, index) => {
                                const parts = line.text.split(/(\[BLANK\d+\])/g);
                                return (
                                    <div key={index} className="mb-4 animate-slide-in">
                                        <div className="flex items-start space-x-3">
                                            <div className="flex-shrink-0 w-28">
                                                <span className="text-sm font-semibold text-gray-700">{line.speaker}:</span>
                                            </div>
                                            <div className="flex-1">
                                                <p className="text-lg leading-relaxed">
                                                    {parts.map((part, i) => {
                                                        const blankMatch = part.match(/\[BLANK(\d+)\]/);
                                                        if (blankMatch) {
                                                            const blank = dialogue.blanks.find(b => b.id === `blank${blankMatch[1]}`);
                                                            if (!blank) return null;
                                                            return (
                                                                <span key={i} className="inline">
                                                                    <strong className="text-indigo-600 bg-indigo-100 px-2 py-1 rounded">
                                                                        {blank.answer}
                                                                    </strong>
                                                                </span>
                                                            );
                                                        }
                                                        return <span key={i}>{part}</span>;
                                                    })}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Key Phrases Reference */}
                    <div className="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-8 mb-6">
                        <h4 className="text-lg font-bold text-gray-900 mb-4">ðŸŽ¯ Key Phrases to Remember</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {dialogue.blanks.map((blank, index) => (
                                <div key={blank.id} className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200">
                                    <div className="flex items-center space-x-2 mb-2">
                                        <span className="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                            {index + 1}
                                        </span>
                                        <span className="px-2 py-1 bg-purple-200 text-purple-700 rounded text-xs font-semibold">
                                            {blank.category}
                                        </span>
                                    </div>
                                    <p className="text-lg font-bold text-indigo-900 mb-1">{blank.answer}</p>
                                    <p className="text-sm text-gray-700 mb-2">
                                        <strong>Meaning:</strong> {blank.translation}
                                    </p>
                                    <p className="text-xs text-gray-600">{blank.notes}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="flex justify-end">
                        <button
                            onClick={() => onGoToStage('practice')}
                            className="px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center space-x-2"
                        >
                            <span>Ready to Practice</span>
                            <span>â†’</span>
                        </button>
                    </div>
                </div>
            );
        }

        // ==================== STAGE 2: PRACTICE ====================

        function PracticeStage({ dialogue, onGoToStage }) {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedAnswers, setSelectedAnswers] = useState({});
            const [correctCount, setCorrectCount] = useState(0);
            const [incorrectCount, setIncorrectCount] = useState(0);
            const [showSummary, setShowSummary] = useState(false);

            const normalizeVietnamese = (text) => text.toLowerCase().trim().replace(/\s+/g, ' ');

            // Group blanks by dialogue line â€” each line with blanks = one question
            const questions = React.useMemo(() => {
                return dialogue.dialogue
                    .map(line => {
                        const blankNums = [];
                        let m;
                        const re = /\[BLANK(\d+)\]/g;
                        while ((m = re.exec(line.text)) !== null) {
                            blankNums.push(parseInt(m[1], 10));
                        }
                        if (blankNums.length === 0) return null;
                        const blanks = blankNums.map(n => dialogue.blanks[n - 1]).filter(Boolean);
                        return { line, blanks };
                    })
                    .filter(Boolean);
            }, [dialogue]);

            const currentQuestion = questions[currentQuestionIndex];
            const currentBlanks = currentQuestion ? currentQuestion.blanks : [];

            // All blanks in this question answered?
            const allAnswered = currentBlanks.length > 0 && currentBlanks.every(b => selectedAnswers[b.id] !== undefined);
            const isLastQuestion = currentQuestionIndex === questions.length - 1;

            // Generate 3 distractor answers for a single blank (excluding its own correct answer)
            const getDistractors = React.useCallback((blank, count) => {
                const others = dialogue.blanks.filter(b => b.id !== blank.id);
                const pool = [...others].sort(() => Math.random() - 0.5);
                const result = [];
                const seen = new Set([normalizeVietnamese(blank.answer)]);
                for (const b of pool) {
                    if (result.length >= count) break;
                    const norm = normalizeVietnamese(b.answer);
                    if (!seen.has(norm)) { seen.add(norm); result.push(b.answer); }
                }
                return result;
            }, [dialogue]);

            // Build 3 combined option objects for the current question.
            // Each option is an array of { blankId, answer } â€” one entry per blank in the question.
            // Option 0 is always the fully-correct combo; options 1 & 2 are wrong combos.
            const combinedOptions = React.useMemo(() => {
                if (!currentQuestion) return [];
                const blanks = currentQuestion.blanks;
                // Correct option: correct answer for every blank
                const correctOption = blanks.map(b => ({ blankId: b.id, answer: b.answer }));
                // For each wrong option: swap one blank's answer to a distractor
                const wrongOptions = [];
                for (let wi = 0; wi < 2; wi++) {
                    const opt = blanks.map((b, bi) => {
                        // Alternate which blank gets the wrong answer so options differ
                        const swapBlank = blanks[(wi + bi) % blanks.length];
                        const distractors = getDistractors(swapBlank, 3);
                        const distractor = distractors[wi] || distractors[0] || b.answer + " (alt)";
                        return { blankId: b.id, answer: bi === (wi % blanks.length) ? distractor : b.answer };
                    });
                    wrongOptions.push(opt);
                }
                return [correctOption, ...wrongOptions].sort(() => Math.random() - 0.5);
            }, [currentQuestionIndex]);

            // Which combined option index was selected (null = none yet)
            const selectedOptionIndex = React.useMemo(() => {
                if (!currentQuestion || !allAnswered) return null;
                const firstBlankId = currentQuestion.blanks[0].id;
                const firstAnswer = selectedAnswers[firstBlankId];
                if (firstAnswer === undefined) return null;
                return combinedOptions.findIndex(opt => opt[0].answer === firstAnswer);
            }, [selectedAnswers, allAnswered]);

            const handleSelectOption = (optionIndex) => {
                if (allAnswered) return; // locked
                const option = combinedOptions[optionIndex];
                let newCorrect = 0, newIncorrect = 0;
                const updates = {};
                option.forEach(({ blankId, answer }) => {
                    const blank = dialogue.blanks.find(b => b.id === blankId);
                    const correct = normalizeVietnamese(answer) === normalizeVietnamese(blank.answer);
                    updates[blankId] = answer;
                    if (correct) newCorrect++; else newIncorrect++;
                });
                setSelectedAnswers(prev => ({ ...prev, ...updates }));
                setCorrectCount(prev => prev + newCorrect);
                setIncorrectCount(prev => prev + newIncorrect);
            };

            const handleNext = () => {
                if (isLastQuestion) {
                    setShowSummary(true);
                } else {
                    setCurrentQuestionIndex(prev => prev + 1);
                }
            };

            const handleRetry = () => {
                setCurrentQuestionIndex(0);
                setSelectedAnswers({});
                setCorrectCount(0);
                setIncorrectCount(0);
                setShowSummary(false);
            };

            // Build sentence parts for rendering
            const buildSentenceParts = (line) => {
                return line.text.split(/(\[BLANK\d+\])/).filter(p => p !== '').map(part => {
                    const match = part.match(/^\[BLANK(\d+)\]$/);
                    if (match) {
                        const bNum = parseInt(match[1], 10);
                        const blank = dialogue.blanks[bNum - 1];
                        const answer = blank ? selectedAnswers[blank.id] : undefined;
                        const answered = answer !== undefined;
                        const correct = answered && blank && normalizeVietnamese(answer) === normalizeVietnamese(blank.answer);
                        return { type: 'blank', blank, answered, answer, correct };
                    }
                    return { type: 'text', value: part };
                });
            };

            const totalBlanks = dialogue.blanks.length;
            const answeredBlanks = Object.keys(selectedAnswers).length;
            const percentScore = totalBlanks > 0 ? Math.round((correctCount / totalBlanks) * 100) : 0;

            // ---- SUMMARY SCREEN ----
            if (showSummary) {
                return (
                    <div>
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h3 className="text-2xl font-bold text-gray-900">âœï¸ Stage 2: Practice</h3>
                                    <p className="text-gray-600">Practice complete!</p>
                                </div>
                                <div className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold">Step 2 of 5</div>
                            </div>
                        </div>
                        <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6 animate-slide-in">
                            <h4 className="text-2xl font-bold text-gray-900 mb-6 text-center">ðŸ“Š Practice Summary</h4>
                            <div className="flex justify-center mb-8">
                                <div className="w-32 h-32 rounded-full flex items-center justify-center border-8" style={{ borderColor: percentScore >= 70 ? '#10b981' : percentScore >= 40 ? '#f59e0b' : '#ef4444' }}>
                                    <span className="text-3xl font-bold text-gray-900">{percentScore}%</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-3 gap-4 mb-8">
                                <div className="bg-gray-50 rounded-xl p-4 text-center">
                                    <p className="text-3xl font-bold text-gray-900">{totalBlanks}</p>
                                    <p className="text-sm text-gray-600 mt-1">Total Blanks</p>
                                </div>
                                <div className="bg-green-50 rounded-xl p-4 text-center">
                                    <p className="text-3xl font-bold text-green-700">{correctCount}</p>
                                    <p className="text-sm text-green-600 mt-1">Correct âœ…</p>
                                </div>
                                <div className="bg-red-50 rounded-xl p-4 text-center">
                                    <p className="text-3xl font-bold text-red-700">{incorrectCount}</p>
                                    <p className="text-sm text-red-600 mt-1">Incorrect âŒ</p>
                                </div>
                            </div>
                            <div className={`p-4 rounded-xl border-2 mb-6 text-center ${percentScore >= 70 ? 'bg-green-50 border-green-300' : percentScore >= 40 ? 'bg-yellow-50 border-yellow-300' : 'bg-red-50 border-red-300'}`}>
                                <p className={`font-bold text-lg ${percentScore >= 70 ? 'text-green-800' : percentScore >= 40 ? 'text-yellow-800' : 'text-red-800'}`}>
                                    {percentScore >= 70 ? 'ðŸŽ‰ Great job! You\'re ready for the test.' : percentScore >= 40 ? 'ðŸ‘ Good effort! Consider retrying to improve.' : 'ðŸ“š Keep practicing! Try again to strengthen your skills.'}
                                </p>
                            </div>
                        </div>
                        <div className="flex justify-between">
                            <button onClick={handleRetry} className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                                ðŸ” Retry Practice
                            </button>
                            <button onClick={() => onGoToStage('test')} className="px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                                Ready for the Test â†’
                            </button>
                        </div>
                    </div>
                );
            }

            if (!currentQuestion) return null;
            const sentenceParts = buildSentenceParts(currentQuestion.line);

            // ---- QUESTION SCREEN ----
            return (
                <div>
                    {/* Header */}
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">âœï¸ Stage 2: Practice</h3>
                                <p className="text-gray-600">Choose the correct Vietnamese phrase for each blank</p>
                            </div>
                            <div className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold">Step 2 of 5</div>
                        </div>
                        <div className="flex items-center space-x-2">
                            <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-green-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${((currentQuestionIndex + (allAnswered ? 1 : 0)) / questions.length) * 100}%` }}
                                />
                            </div>
                            <span className="text-sm font-medium text-gray-600">{currentQuestionIndex + 1} / {questions.length}</span>
                        </div>
                    </div>

                    {/* Question card */}
                    <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6">
                        {/* Tags */}
                        <div className="flex items-center flex-wrap gap-2 mb-5">
                            {currentBlanks.map((b, i) => (
                                <span key={i} className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">{b.category}</span>
                            ))}
                            <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">{currentQuestion.line.speaker}</span>
                        </div>

                        {/* Sentence display */}
                        <p className="text-gray-500 text-sm font-medium mb-3">{currentBlanks.length > 1 ? 'Fill in the blanks:' : 'Fill in the blank:'}</p>
                        <div className="bg-gradient-to-r from-indigo-50 to-blue-50 border-2 border-indigo-200 rounded-xl px-6 py-5 mb-6">
                            <p className="text-xl leading-relaxed text-gray-800 font-medium">
                                {sentenceParts.map((part, i) => (
                                    <React.Fragment key={i}>
                                        {part.type === 'text' ? part.value : (
                                            <span className={`inline-block mx-1 px-3 py-0.5 rounded font-bold text-xl border-b-2 min-w-[80px] text-center transition-colors ${
                                                part.answered
                                                    ? part.correct
                                                        ? 'text-green-700 border-green-500 bg-green-100'
                                                        : 'text-red-700 border-red-500 bg-red-100'
                                                    : 'text-indigo-400 border-indigo-400 bg-white'
                                            }`}>
                                                {part.answered ? part.answer : '?'}
                                            </span>
                                        )}
                                    </React.Fragment>
                                ))}
                            </p>
                        </div>

                        {/* Combined options â€” 3 choices, each containing one answer per blank */}
                        <div className="space-y-3">
                            {combinedOptions.map((option, optIdx) => {
                                const isSelected = selectedOptionIndex === optIdx;
                                const isCorrectOption = option.every(({ blankId, answer }) => {
                                    const blank = dialogue.blanks.find(b => b.id === blankId);
                                    return normalizeVietnamese(answer) === normalizeVietnamese(blank.answer);
                                });
                                let cls = 'w-full p-4 rounded-xl text-left transition-all border-2 ';
                                if (!allAnswered) {
                                    cls += 'bg-gray-50 border-gray-300 hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer';
                                } else if (isCorrectOption) {
                                    cls += 'bg-green-100 border-green-500 cursor-default';
                                } else if (isSelected) {
                                    cls += 'bg-red-100 border-red-500 cursor-default';
                                } else {
                                    cls += 'bg-gray-100 border-gray-200 opacity-50 cursor-default';
                                }
                                return (
                                    <button key={optIdx} onClick={() => handleSelectOption(optIdx)} disabled={allAnswered} className={cls}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center space-x-3">
                                                <span className={`w-7 h-7 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0 flex-shrink-0 ${!allAnswered ? 'bg-indigo-100 text-indigo-700' : isCorrectOption ? 'bg-green-500 text-white' : isSelected ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-500'}`}>
                                                    {String.fromCharCode(65 + optIdx)}
                                                </span>
                                                <div className="flex items-center gap-3 flex-wrap">
                                                    {option.map(({ blankId, answer }, ai) => (
                                                        <React.Fragment key={blankId}>
                                                            {ai > 0 && <span className="text-gray-400 font-bold">+</span>}
                                                            <span className="text-lg font-semibold text-gray-900">{answer}</span>
                                                        </React.Fragment>
                                                    ))}
                                                </div>
                                            </div>
                                            {allAnswered && isCorrectOption && <span className="text-2xl">âœ…</span>}
                                            {allAnswered && isSelected && !isCorrectOption && <span className="text-2xl">âŒ</span>}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>

                        {/* Feedback after answering */}
                        {allAnswered && (
                            <div className={`mt-5 p-4 rounded-xl border-2 animate-slide-in ${
                                currentBlanks.every(b => normalizeVietnamese(selectedAnswers[b.id]) === normalizeVietnamese(b.answer))
                                    ? 'bg-green-50 border-green-300' : 'bg-orange-50 border-orange-300'
                            }`}>
                                {currentBlanks.every(b => normalizeVietnamese(selectedAnswers[b.id]) === normalizeVietnamese(b.answer)) ? (
                                    <p className="font-bold text-green-800 mb-2">ðŸŽ‰ Correct!</p>
                                ) : (
                                    <p className="font-bold text-orange-800 mb-2">
                                        âŒ Correct: {currentBlanks.map(b => b.answer).join(' + ')}
                                    </p>
                                )}
                                {currentBlanks.map(b => (
                                    <p key={b.id} className="text-gray-700 text-sm">{b.notes}</p>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Next button */}
                    <div className="flex justify-end">
                        <button
                            onClick={handleNext}
                            disabled={!allAnswered}
                            className={`px-6 py-3 rounded-lg font-semibold transition ${allAnswered ? 'bg-indigo-600 text-white hover:bg-indigo-700 cursor-pointer' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
                        >
                            {isLastQuestion ? 'Finish â†’' : 'Next â†’'}
                        </button>
                    </div>
                </div>
            );
        }

                // ==================== STAGE 3: TEST ====================

        function TestStage({ scenario, dialogue, onComplete, onGoToStage }) {
            const [userAnswers, setUserAnswers] = useState({});
            const [submitted, setSubmitted] = useState(false);
            const [startTime] = useState(Date.now());
            const [responseTimes, setResponseTimes] = useState({});
            const inputRefs = useRef({});

            const normalizeVietnamese = (text) => text.toLowerCase().trim().replace(/\s+/g, ' ');

            const calculateSimilarity = (answer, correct) => {
                const a = normalizeVietnamese(answer);
                const c = normalizeVietnamese(correct);
                if (a === c) return 1.0;
                const aWords = a.split(' ');
                const cWords = c.split(' ');
                const matches = aWords.filter(w => cWords.includes(w)).length;
                return matches / Math.max(aWords.length, cWords.length);
            };

            const handleAnswerChange = (blankId, value) => {
                if (!responseTimes[blankId]) {
                    setResponseTimes(prev => ({ ...prev, [blankId]: Date.now() - startTime }));
                }
                setUserAnswers(prev => ({ ...prev, [blankId]: value }));
            };

            const handleSubmit = () => {
                let totalCorrect = 0, totalPolite = 0, politeCorrect = 0;
                const blankResults = [];

                dialogue.blanks.forEach(blank => {
                    const userAnswer = userAnswers[blank.id] || '';
                    const similarity = calculateSimilarity(userAnswer, blank.answer);
                    const correct = similarity >= 0.8;
                    if (correct) totalCorrect++;
                    if (blank.politeness === 'polite') { totalPolite++; if (correct) politeCorrect++; }
                    blankResults.push({ blankId: blank.id, correct, similarity, responseTime: responseTimes[blank.id] || 0 });
                    StorageManager.savePhraseProgress(`${scenario.id}_${blank.id}`, {
                        correct, similarity,
                        phrase: blank.answer,
                        translation: blank.translation,
                        scenario: scenario.id
                    });
                });

                const rt = Object.values(responseTimes);
                const avgResponseTime = rt.length ? rt.reduce((a, b) => a + b, 0) / rt.length : 0;
                const results = {
                    accuracy: (totalCorrect / dialogue.blanks.length) * 100,
                    avgResponseTime: Math.round(avgResponseTime / 1000),
                    politenessAccuracy: totalPolite > 0 ? Math.round((politeCorrect / totalPolite) * 100) : 0,
                    blanks: blankResults
                };

                const currentStats = StorageManager.getWeeklyStats();
                StorageManager.updateWeeklyStats({
                    scenariosCompleted: currentStats.scenariosCompleted + 1,
                    avgResponseTime: Math.round((currentStats.avgResponseTime + results.avgResponseTime) / 2),
                    politenessAccuracy: Math.round((currentStats.politenessAccuracy + results.politenessAccuracy) / 2)
                });

                setSubmitted(true);
                onComplete(results);
            };

            const allFilled = dialogue.blanks.every(blank => userAnswers[blank.id]?.trim());

            const renderDialogueLine = (line, index) => {
                const parts = line.text.split(/(\[BLANK\d+\])/g);
                return (
                    <div key={index} className="mb-4 animate-slide-in">
                        <div className="flex items-start space-x-3">
                            <div className="flex-shrink-0 w-28">
                                <span className="text-sm font-semibold text-gray-700">{line.speaker}:</span>
                            </div>
                            <div className="flex-1">
                                <p className="text-lg leading-relaxed">
                                    {parts.map((part, i) => {
                                        const blankMatch = part.match(/\[BLANK(\d+)\]/);
                                        if (blankMatch) {
                                            const blankId = `blank${blankMatch[1]}`;
                                            const blank = dialogue.blanks.find(b => b.id === blankId);
                                            if (!blank) return null;
                                            const userAnswer = userAnswers[blankId] || '';
                                            const similarity = submitted ? calculateSimilarity(userAnswer, blank.answer) : 0;
                                            const isCorrect = similarity >= 0.8;
                                            return (
                                                <span key={i} className="inline-block mx-1">
                                                    <input
                                                        ref={el => inputRefs.current[blankId] = el}
                                                        type="text"
                                                        value={userAnswer}
                                                        onChange={e => handleAnswerChange(blankId, e.target.value)}
                                                        disabled={submitted}
                                                        className={`blank-input px-3 py-1 min-w-[200px] rounded ${
                                                            submitted ? (isCorrect ? 'correct' : 'incorrect') : ''
                                                        }`}
                                                        placeholder="..."
                                                    />
                                                    {submitted && !isCorrect && (
                                                        <span className="ml-2 text-green-600 font-medium">âœ“ {blank.answer}</span>
                                                    )}
                                                </span>
                                            );
                                        }
                                        return <span key={i}>{part}</span>;
                                    })}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div>
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">ðŸŽ¯ Stage 3: Test</h3>
                                <p className="text-gray-600">Fill in the blanks from memory â€” you've got this!</p>
                            </div>
                            <div className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold">
                                Step 3 of 5
                            </div>
                        </div>
                    </div>

                    <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-6 mb-6">
                        <p className="text-lg text-gray-700 mb-2">
                            <strong>Context:</strong> {dialogue.context}
                        </p>
                        <p className="text-sm text-gray-600">
                            ðŸ’¡ Type the Vietnamese phrases you learned. Don't worry about perfect spelling â€” we check for meaning!
                        </p>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-8 mb-6">
                        <div className="space-y-2">
                            {dialogue.dialogue.map((line, index) => renderDialogueLine(line, index))}
                        </div>
                    </div>

                    <div className="flex items-center justify-between border-t pt-6">
                        <button
                            onClick={() => onGoToStage('practice')}
                            className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                        >
                            â† Review Practice
                        </button>
                        <div className="flex items-center space-x-3">
                            {submitted && (
                                <p className="text-sm text-green-600 font-medium">âœ“ Saved for spaced repetition!</p>
                            )}
                            {!submitted ? (
                                <button
                                    onClick={handleSubmit}
                                    disabled={!allFilled}
                                    className={`px-8 py-3 rounded-lg font-semibold transition ${
                                        allFilled ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Submit Test
                                </button>
                            ) : (
                                <button
                                    onClick={() => onGoToStage('rebuild')}
                                    className="px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                                >
                                    Next: Rebuild â†’
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }


        // ==================== REBUILD STAGE ====================

        function RebuildStage({ dialogue, onBack, onRestart, onNextStage }) {
            // Build sentence pool: fill in blank placeholders with correct answers so all words are present
            const sentences = React.useMemo(() => {
                // Build a lookup map: blankId -> answer (e.g. 'blank1' -> 'trÃ¡ch nhiá»‡m')
                const answerMap = {};
                (dialogue.blanks || []).forEach(b => { answerMap[b.id] = b.answer; });
                return dialogue.dialogue
                    .map(line => {
                        // Replace [BLANK1] with the correct answer for blank1, etc.
                        const filled = line.text.replace(/\[BLANK(\d+)\]/g, (_, n) => {
                            const key = 'blank' + n;
                            return answerMap[key] || '';
                        }).replace(/\s+/g, ' ').trim();
                        return { speaker: line.speaker, text: filled };
                    })
                    .filter(line => line.text.length > 8);
            }, [dialogue]);

            const [currentIndex, setCurrentIndex] = useState(0);
            const [selectedWords, setSelectedWords] = useState([]);
            const [availableWords, setAvailableWords] = useState([]);
            const [result, setResult] = useState(null); // null | 'correct' | 'incorrect'
            const [completed, setCompleted] = useState(0);

            const shuffleArray = (arr) => {
                const a = [...arr];
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            };

            const loadSentence = (index) => {
                const sentence = sentences[index];
                if (!sentence) return;
                // Split on spaces, keep punctuation attached to word
                const words = sentence.text.split(' ').filter(w => w.length > 0);
                // Tag each word with a unique id to handle duplicates
                const tagged = words.map((w, i) => ({ id: `w${i}`, word: w }));
                setAvailableWords(shuffleArray(tagged));
                setSelectedWords([]);
                setResult(null);
            };

            useEffect(() => {
                loadSentence(currentIndex);
            }, [currentIndex]);

            const handlePickWord = (item) => {
                setAvailableWords(prev => prev.filter(w => w.id !== item.id));
                setSelectedWords(prev => [...prev, item]);
                setResult(null);
            };

            const handleRemoveWord = (item) => {
                setSelectedWords(prev => prev.filter(w => w.id !== item.id));
                setAvailableWords(prev => [...prev, item]);
                setResult(null);
            };

            const handleCheck = () => {
                const answer = selectedWords.map(w => w.word).join(' ');
                const correct = sentences[currentIndex].text;
                if (answer === correct) {
                    setResult('correct');
                    setCompleted(prev => prev + 1);
                } else {
                    setResult('incorrect');
                }
            };

            const handleNext = () => {
                if (currentIndex < sentences.length - 1) {
                    setCurrentIndex(prev => prev + 1);
                }
            };

            const handleTryAgain = () => {
                loadSentence(currentIndex);
            };

            const isLastSentence = currentIndex === sentences.length - 1;
            const allDone = isLastSentence && result === 'correct';
            const current = sentences[currentIndex];

            return (
                <div>
                    {/* Header */}
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">ðŸ§© Stage 4: Rebuild the Sentence</h3>
                                <p className="text-gray-600">Arrange the words in the correct order to rebuild each sentence</p>
                            </div>
                            <div className="px-4 py-2 bg-teal-100 text-teal-700 rounded-lg font-semibold">
                                Step 4 of 5
                            </div>
                        </div>
                        {/* Progress bar */}
                        <div className="flex items-center space-x-3">
                            <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-teal-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${((currentIndex + (result === 'correct' ? 1 : 0)) / sentences.length) * 100}%` }}
                                />
                            </div>
                            <span className="text-sm font-medium text-gray-600 whitespace-nowrap">
                                {currentIndex + 1} / {sentences.length}
                            </span>
                        </div>
                    </div>

                    {/* Card */}
                    <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6">
                        {/* Speaker badge */}
                        <div className="mb-5">
                            <span className="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm font-semibold">
                                {current.speaker}
                            </span>
                        </div>

                        {/* Answer area */}
                        <div className="mb-6">
                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Your sentence</p>
                            <div
                                className={`min-h-[60px] flex flex-wrap gap-2 p-4 rounded-xl border-2 transition-colors ${
                                    result === 'correct' ? 'border-green-400 bg-green-50' :
                                    result === 'incorrect' ? 'border-red-400 bg-red-50' :
                                    'border-dashed border-gray-300 bg-gray-50'
                                }`}
                            >
                                {selectedWords.length === 0 && (
                                    <span className="text-gray-400 text-sm italic self-center">Click words below to build the sentenceâ€¦</span>
                                )}
                                {selectedWords.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => result === null && handleRemoveWord(item)}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                            result === 'correct' ? 'bg-green-200 text-green-900 cursor-default' :
                                            result === 'incorrect' ? 'bg-red-200 text-red-900 cursor-default' :
                                            'bg-indigo-600 text-white hover:bg-red-500 hover:scale-95'
                                        }`}
                                        title={result === null ? 'Click to remove' : ''}
                                    >
                                        {item.word}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Word bank */}
                        <div className="mb-6">
                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Word bank</p>
                            <div className="flex flex-wrap gap-2 min-h-[44px]">
                                {availableWords.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => result === null && handlePickWord(item)}
                                        disabled={result !== null}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium border-2 transition-all ${
                                            result !== null
                                                ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-default'
                                                : 'bg-white border-indigo-300 text-indigo-700 hover:bg-indigo-50 hover:border-indigo-500 hover:scale-105 active:scale-95'
                                        }`}
                                    >
                                        {item.word}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Result feedback */}
                        {result === 'correct' && (
                            <div className="flex items-center space-x-3 p-4 bg-green-50 border-2 border-green-300 rounded-xl animate-slide-in">
                                <span className="text-2xl">âœ…</span>
                                <div>
                                    <p className="font-bold text-green-800">Correct!</p>
                                    <p className="text-green-700 text-sm">Perfect â€” the sentence matches exactly.</p>
                                </div>
                            </div>
                        )}
                        {result === 'incorrect' && (
                            <div className="flex items-center space-x-3 p-4 bg-red-50 border-2 border-red-300 rounded-xl animate-slide-in">
                                <span className="text-2xl">âŒ</span>
                                <div>
                                    <p className="font-bold text-red-800">Try again!</p>
                                    <p className="text-red-700 text-sm">The word order isn't quite right. Remove words and try a different order.</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* All done screen */}
                    {allDone && (
                        <div className="bg-gradient-to-r from-teal-500 to-green-500 rounded-xl p-8 text-white text-center mb-6 animate-slide-in">
                            <div className="text-5xl mb-3">ðŸŽ‰</div>
                            <h4 className="text-2xl font-bold mb-2">All sentences rebuilt!</h4>
                            <p className="text-teal-100 mb-1">You've completed all 5 stages of this scenario.</p>
                            <p className="text-teal-100">You scored {completed} / {sentences.length} on the rebuild exercises.</p>
                        </div>
                    )}

                    {/* Action buttons */}
                    <div className="flex items-center justify-between border-t pt-6">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                        >
                            â† Back to Test
                        </button>
                        <div className="flex space-x-3">
                            {result === 'incorrect' && (
                                <button
                                    onClick={handleTryAgain}
                                    className="px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition"
                                >
                                    Reset Words
                                </button>
                            )}
                            {result === 'correct' && !isLastSentence && (
                                <button
                                    onClick={handleNext}
                                    className="px-8 py-3 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700 transition"
                                >
                                    Next Sentence â†’
                                </button>
                            )}
                            {allDone && (
                                <>
                                    <button
                                        onClick={onRestart}
                                        className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                                    >
                                        Start Over ðŸ”„
                                    </button>
                                    <button
                                        onClick={onNextStage}
                                        className="px-8 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition"
                                    >
                                        Next: Listening ðŸŽ§
                                    </button>
                                </>
                            )}
                            {result === null && (
                                <button
                                    onClick={handleCheck}
                                    disabled={selectedWords.length === 0}
                                    className={`px-8 py-3 rounded-lg font-semibold transition ${
                                        selectedWords.length > 0
                                            ? 'bg-teal-600 text-white hover:bg-teal-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check âœ“
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }


        // ==================== LISTENING STAGE ====================

        function ListeningStage({ dialogue, onBack, onRestart }) {
            const { useState, useEffect, useRef, useMemo } = React;

            // Build sentence list from dialogue, filling in blank answers
            const sentences = useMemo(() => {
                const answerMap = {};
                (dialogue.blanks || []).forEach(b => { answerMap[b.id] = b.answer; });
                return dialogue.dialogue
                    .map(line => {
                        const filled = line.text.replace(/\[BLANK(\d+)\]/g, (_, n) => {
                            const key = 'blank' + n;
                            return answerMap[key] || '';
                        }).replace(/\s+/g, ' ').trim();
                        return { speaker: line.speaker, text: filled };
                    })
                    .filter(line => line.text.length > 8);
            }, [dialogue]);

            const [currentIndex, setCurrentIndex] = useState(0);
            const [hasPlayed, setHasPlayed] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [typedAnswer, setTypedAnswer] = useState('');
            const [result, setResult] = useState(null); // null | 'correct' | 'incorrect'
            const [correctCount, setCorrectCount] = useState(0);
            const [incorrectCount, setIncorrectCount] = useState(0);
            const [showSummary, setShowSummary] = useState(false);
            const [ttsSupported, setTtsSupported] = useState(true);
            const utteranceRef = useRef(null);
            const inputRef = useRef(null);

            const isLastSentence = currentIndex === sentences.length - 1;
            const current = sentences[currentIndex];

            useEffect(() => {
                if (!window.speechSynthesis) setTtsSupported(false);
                return () => { if (window.speechSynthesis) window.speechSynthesis.cancel(); };
            }, []);

            // Reset state when moving to new sentence
            useEffect(() => {
                setTypedAnswer('');
                setResult(null);
                setHasPlayed(false);
                setIsPlaying(false);
                if (window.speechSynthesis) window.speechSynthesis.cancel();
                setTimeout(() => inputRef.current && inputRef.current.focus(), 50);
            }, [currentIndex]);

            const playAudio = () => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const text = sentences[currentIndex].text;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.rate = 0.85;
                utterance.pitch = 1;
                const voices = window.speechSynthesis.getVoices();
                const viVoice = voices.find(v => v.lang === 'vi-VN' || v.lang.startsWith('vi'));
                if (viVoice) utterance.voice = viVoice;
                utterance.onstart = () => setIsPlaying(true);
                utterance.onend = () => { setIsPlaying(false); setHasPlayed(true); };
                utterance.onerror = () => { setIsPlaying(false); setHasPlayed(true); };
                utteranceRef.current = utterance;
                window.speechSynthesis.speak(utterance);
            };

            const handlePlayClick = () => {
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        window.speechSynthesis.onvoiceschanged = null;
                        playAudio();
                    };
                    setTimeout(() => playAudio(), 300);
                } else {
                    playAudio();
                }
            };

            const normalize = (s) => s.trim().toLowerCase().replace(/[\p{P}\p{S}]/gu, '').replace(/\s+/g, ' ');

            // Diff: return array of { char, type: 'match'|'wrong'|'missing' } for highlighting
            const diffChars = (typed, correct) => {
                const t = typed.trim();
                const c = correct.trim();
                const result = [];
                const maxLen = Math.max(t.length, c.length);
                for (let i = 0; i < maxLen; i++) {
                    if (i >= t.length) {
                        result.push({ char: c[i], type: 'missing' });
                    } else if (i >= c.length) {
                        result.push({ char: t[i], type: 'extra' });
                    } else if (t[i].toLowerCase() === c[i].toLowerCase()) {
                        result.push({ char: c[i], type: 'match' });
                    } else {
                        result.push({ char: c[i], type: 'wrong' });
                    }
                }
                return result;
            };

            const handleCheck = () => {
                if (!typedAnswer.trim()) return;
                const correct = normalize(typedAnswer) === normalize(current.text);
                setResult(correct ? 'correct' : 'incorrect');
                if (correct) setCorrectCount(prev => prev + 1);
                else setIncorrectCount(prev => prev + 1);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && result === null && typedAnswer.trim()) handleCheck();
            };

            const handleNext = () => {
                if (isLastSentence) {
                    setShowSummary(true);
                } else {
                    setCurrentIndex(prev => prev + 1);
                }
            };

            const handleRetry = () => {
                setCurrentIndex(0);
                setTypedAnswer('');
                setResult(null);
                setCorrectCount(0);
                setIncorrectCount(0);
                setShowSummary(false);
                setHasPlayed(false);
            };

            const totalSentences = sentences.length;
            const percentScore = totalSentences > 0 ? Math.round((correctCount / totalSentences) * 100) : 0;

            // ---- SUMMARY SCREEN ----
            if (showSummary) {
                return (
                    <div>
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h3 className="text-2xl font-bold text-gray-900">ðŸŽ§ Stage 5: Listening Mode</h3>
                                    <p className="text-gray-600">Listening practice complete!</p>
                                </div>
                                <div className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold">Final Step</div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6 animate-slide-in">
                            <h4 className="text-2xl font-bold text-gray-900 mb-6 text-center">ðŸ“Š Listening Summary</h4>

                            <div className="flex justify-center mb-8">
                                <div className="w-32 h-32 rounded-full flex items-center justify-center border-8" style={{ borderColor: percentScore >= 70 ? '#10b981' : percentScore >= 40 ? '#f59e0b' : '#ef4444' }}>
                                    <span className="text-3xl font-bold text-gray-900">{percentScore}%</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-3 gap-4 mb-8">
                                <div className="bg-gray-50 rounded-xl p-4 text-center">
                                    <p className="text-3xl font-bold text-gray-900">{totalSentences}</p>
                                    <p className="text-sm text-gray-600 mt-1">Total Sentences</p>
                                </div>
                                <div className="bg-green-50 rounded-xl p-4 text-center">
                                    <p className="text-3xl font-bold text-green-700">{correctCount}</p>
                                    <p className="text-sm text-green-600 mt-1">Correct âœ…</p>
                                </div>
                                <div className="bg-red-50 rounded-xl p-4 text-center">
                                    <p className="text-3xl font-bold text-red-700">{incorrectCount}</p>
                                    <p className="text-sm text-red-600 mt-1">Incorrect âŒ</p>
                                </div>
                            </div>

                            <div className={`p-4 rounded-xl border-2 text-center ${percentScore >= 70 ? 'bg-green-50 border-green-300' : percentScore >= 40 ? 'bg-yellow-50 border-yellow-300' : 'bg-red-50 border-red-300'}`}>
                                <p className={`font-bold text-lg ${percentScore >= 70 ? 'text-green-800' : percentScore >= 40 ? 'text-yellow-800' : 'text-red-800'}`}>
                                    {percentScore >= 70 ? "ðŸŽ‰ Excellent listening! You've mastered these sentences." : percentScore >= 40 ? "ðŸ‘ Good effort! Try again to sharpen your ear." : "ðŸ“š Keep listening! Replay and practice more."}
                                </p>
                            </div>
                        </div>

                        <div className="flex items-center justify-between border-t pt-6">
                            <button onClick={onBack} className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                                â† Back
                            </button>
                            <div className="flex space-x-3">
                                <button onClick={handleRetry} className="px-6 py-3 bg-purple-100 text-purple-700 rounded-lg font-semibold hover:bg-purple-200 transition">
                                    ðŸ” Retry Listening
                                </button>
                                <button onClick={onRestart} className="px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">
                                    Start Over ðŸ”„
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // ---- QUESTION SCREEN ----
            const diffResult = result === 'incorrect' ? diffChars(typedAnswer, current.text) : null;

            return (
                <div>
                    {/* Header */}
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">ðŸŽ§ Stage 5: Listening Mode</h3>
                                <p className="text-gray-600">Listen to the sentence, then type exactly what you hear</p>
                            </div>
                            <div className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold">Final Step</div>
                        </div>
                        <div className="flex items-center space-x-3">
                            <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-purple-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${((currentIndex + (result !== null ? 1 : 0)) / sentences.length) * 100}%` }}
                                />
                            </div>
                            <span className="text-sm font-medium text-gray-600 whitespace-nowrap">{currentIndex + 1} / {sentences.length}</span>
                        </div>
                    </div>

                    {!ttsSupported && (
                        <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6 flex items-center space-x-3">
                            <span className="text-2xl">âš ï¸</span>
                            <p className="text-yellow-800 text-sm">Your browser doesn't support Text-to-Speech. The sentence is shown below so you can still practice.</p>
                        </div>
                    )}

                    {/* Card */}
                    <div className="bg-white rounded-xl shadow-xl border-2 border-gray-200 p-8 mb-6">
                        {/* Speaker badge */}
                        <div className="flex items-center justify-between mb-6">
                            <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">{current.speaker}</span>
                            <span className="text-xs text-gray-400 italic">Sentence {currentIndex + 1} of {sentences.length}</span>
                        </div>

                        {/* Audio play zone */}
                        <div className="flex flex-col items-center justify-center py-8 mb-6 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl border-2 border-purple-200">
                            <button
                                onClick={handlePlayClick}
                                disabled={isPlaying}
                                className={`w-20 h-20 rounded-full flex items-center justify-center text-3xl shadow-lg transition-all mb-4 ${
                                    isPlaying ? 'bg-purple-300 cursor-not-allowed scale-95' : 'bg-purple-600 hover:bg-purple-700 hover:scale-110 active:scale-95 text-white'
                                }`}
                                title="Play audio"
                            >
                                {isPlaying ? 'â¸' : 'â–¶'}
                            </button>
                            <p className="text-purple-700 font-semibold text-sm mb-1">
                                {isPlaying ? 'Playingâ€¦' : hasPlayed ? 'Play again' : 'Play Audio'}
                            </p>
                            <p className="text-purple-400 text-xs">Vietnamese (vi-VN) Â· click to replay anytime</p>

                            {/* Fallback: show sentence text if TTS unsupported */}
                            {!ttsSupported && (
                                <p className="mt-4 text-gray-800 text-lg font-medium text-center px-4">{current.text}</p>
                            )}

                            {/* Reveal sentence after answering */}
                            {result !== null && ttsSupported && (
                                <p className="mt-4 text-gray-700 text-base font-medium text-center px-4 opacity-80">{current.text}</p>
                            )}
                        </div>

                        {/* Typed input */}
                        <div className="mb-6">
                            <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Type what you hear</p>
                            <input
                                ref={inputRef}
                                type="text"
                                value={typedAnswer}
                                onChange={e => result === null && setTypedAnswer(e.target.value)}
                                onKeyDown={handleKeyDown}
                                disabled={result !== null}
                                placeholder="Type the Vietnamese sentence hereâ€¦"
                                className={`w-full px-4 py-3 text-lg rounded-xl border-2 outline-none transition-colors font-medium ${
                                    result === 'correct'
                                        ? 'border-green-400 bg-green-50 text-green-900'
                                        : result === 'incorrect'
                                        ? 'border-red-400 bg-red-50 text-red-900'
                                        : 'border-gray-300 bg-white text-gray-900 focus:border-purple-400'
                                }`}
                            />
                            <p className="text-xs text-gray-400 mt-1">Press Enter or click Check to submit</p>
                        </div>

                        {/* Result feedback */}
                        {result === 'correct' && (
                            <div className="animate-slide-in">
                                <div className="flex items-center space-x-3 p-4 bg-green-50 border-2 border-green-300 rounded-xl">
                                    <span className="text-2xl">âœ…</span>
                                    <div>
                                        <p className="font-bold text-green-800">Correct!</p>
                                        <p className="text-green-700 text-sm">You typed the sentence accurately.</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {result === 'incorrect' && (
                            <div className="animate-slide-in space-y-3">
                                <div className="flex items-center space-x-3 p-4 bg-red-50 border-2 border-red-300 rounded-xl">
                                    <span className="text-2xl">âŒ</span>
                                    <div>
                                        <p className="font-bold text-red-800">Not quite right.</p>
                                        <p className="text-red-700 text-sm">See the correct sentence below with differences highlighted.</p>
                                    </div>
                                </div>
                                <div className="p-4 bg-gray-50 border-2 border-gray-200 rounded-xl">
                                    <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Correct sentence</p>
                                    <p className="text-base font-medium leading-relaxed">
                                        {diffResult.map((item, i) => (
                                            <span key={i} className={
                                                item.type === 'match' ? 'text-gray-800' :
                                                item.type === 'wrong' ? 'bg-orange-200 text-orange-900 rounded px-0.5' :
                                                item.type === 'missing' ? 'bg-red-200 text-red-900 rounded px-0.5' :
                                                'bg-gray-200 text-gray-500 line-through rounded px-0.5'
                                            }>{item.char}</span>
                                        ))}
                                    </p>
                                    <p className="text-xs text-gray-400 mt-2">
                                        <span className="inline-block w-3 h-3 bg-orange-200 rounded mr-1"></span>wrong char &nbsp;
                                        <span className="inline-block w-3 h-3 bg-red-200 rounded mr-1"></span>missing
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Action buttons */}
                    <div className="flex items-center justify-between border-t pt-6">
                        <button onClick={onBack} className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                            â† Back to Rebuild
                        </button>
                        <div className="flex space-x-3">
                            {result === null && (
                                <button
                                    onClick={handleCheck}
                                    disabled={!typedAnswer.trim()}
                                    className={`px-8 py-3 rounded-lg font-semibold transition ${
                                        typedAnswer.trim() ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check âœ“
                                </button>
                            )}
                            {result !== null && (
                                <button
                                    onClick={handleNext}
                                    className="px-8 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition"
                                >
                                    {isLastSentence ? 'See Results â†’' : 'Next Sentence â†’'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== ANALYZE TAB ====================
        
        function AnalyzeTab({ scenario, results }) {
            const dialogue = SAMPLE_DIALOGUES[scenario.id] || SAMPLE_DIALOGUES['restaurant_order'];

            const getGrade = (accuracy) => {
                if (accuracy >= 90) return { grade: 'A', color: 'text-green-600', bg: 'bg-green-100' };
                if (accuracy >= 80) return { grade: 'B', color: 'text-blue-600', bg: 'bg-blue-100' };
                if (accuracy >= 70) return { grade: 'C', color: 'text-yellow-600', bg: 'bg-yellow-100' };
                return { grade: 'D', color: 'text-red-600', bg: 'bg-red-100' };
            };

            const accuracyGrade = getGrade(results.accuracy);

            return (
                <div>
                    <h3 className="text-2xl font-bold text-gray-900 mb-6">Performance Analysis</h3>

                    {/* Metrics Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white">
                            <p className="text-green-100 text-sm font-medium mb-2">Overall Accuracy</p>
                            <p className="text-5xl font-bold">{Math.round(results.accuracy)}%</p>
                            <p className={`mt-2 px-3 py-1 inline-block rounded-full text-sm font-bold ${accuracyGrade.bg} ${accuracyGrade.color}`}>
                                Grade: {accuracyGrade.grade}
                            </p>
                        </div>

                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                            <p className="text-blue-100 text-sm font-medium mb-2">Avg Response Time</p>
                            <p className="text-5xl font-bold">{results.avgResponseTime}s</p>
                            <p className="text-blue-100 text-sm mt-2">per phrase</p>
                        </div>

                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                            <p className="text-purple-100 text-sm font-medium mb-2">Politeness Accuracy</p>
                            <p className="text-5xl font-bold">{results.politenessAccuracy}%</p>
                            <p className="text-purple-100 text-sm mt-2">formal expressions</p>
                        </div>
                    </div>

                    {/* Detailed Breakdown */}
                    <div className="bg-white rounded-xl border-2 border-gray-200 p-6">
                        <h4 className="text-xl font-bold text-gray-900 mb-4">Phrase-by-Phrase Breakdown</h4>
                        <div className="space-y-4">
                            {dialogue.blanks.map((blank, index) => {
                                const result = results.blanks.find(b => b.blankId === blank.id);
                                const isCorrect = result?.correct || false;
                                const responseTime = result?.responseTime || 0;

                                return (
                                    <div key={blank.id} className={`p-4 rounded-lg border-2 ${
                                        isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'
                                    }`}>
                                        <div className="flex items-start justify-between mb-2">
                                            <div className="flex-1">
                                                <div className="flex items-center space-x-2 mb-2">
                                                    <span className="text-2xl">{isCorrect ? 'âœ…' : 'âŒ'}</span>
                                                    <span className="font-semibold text-gray-900">Phrase {index + 1}</span>
                                                    <span className="px-2 py-1 bg-gray-200 rounded text-xs font-medium text-gray-700">
                                                        {blank.category}
                                                    </span>
                                                    {blank.politeness === 'polite' && (
                                                        <span className="px-2 py-1 bg-purple-200 rounded text-xs font-medium text-purple-700">
                                                            polite form
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-lg font-medium text-indigo-600 mb-1">{blank.answer}</p>
                                                <p className="text-gray-700 mb-1">
                                                    <span className="font-medium">Translation:</span> {blank.translation}
                                                </p>
                                                <p className="text-sm text-gray-600">{blank.notes}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-sm text-gray-500">Response Time</p>
                                                <p className="text-xl font-bold text-gray-900">{Math.round(responseTime / 1000)}s</p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Recommendations */}
                    <div className="mt-6 bg-indigo-50 border-2 border-indigo-200 rounded-xl p-6">
                        <h4 className="text-lg font-bold text-indigo-900 mb-3">ðŸ’¡ Recommendations</h4>
                        <ul className="space-y-2">
                            {results.accuracy < 80 && (
                                <li className="text-indigo-800">â€¢ Focus on reviewing phrases you missed in the TRAIN tab</li>
                            )}
                            {results.avgResponseTime > 10 && (
                                <li className="text-indigo-800">â€¢ Practice these phrases more to improve fluency and recall speed</li>
                            )}
                            {results.politenessAccuracy < 90 && (
                                <li className="text-indigo-800">â€¢ Pay special attention to polite forms (áº¡, chá»‹, anh) in formal contexts</li>
                            )}
                            <li className="text-indigo-800">â€¢ Try the scenario again to improve your score!</li>
                        </ul>
                    </div>
                </div>
            );
        }

        // ==================== TRAIN TAB ====================
        
        function TrainTab({ scenario }) {
            const dialogue = SAMPLE_DIALOGUES[scenario.id] || SAMPLE_DIALOGUES['restaurant_order'];
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswer, setUserAnswer] = useState('');
            const [showAnswer, setShowAnswer] = useState(false);
            const [queue, setQueue] = useState([]);

            useEffect(() => {
                // Build SRS queue for this scenario
                const scenarioPhrases = dialogue.blanks.map(blank => ({
                    ...blank,
                    phraseId: `${scenario.id}_${blank.id}`
                }));
                
                // Prioritize phrases user has struggled with
                const phraseProgress = StorageManager.getPhrases();
                const sortedQueue = scenarioPhrases.sort((a, b) => {
                    const progressA = phraseProgress[a.phraseId];
                    const progressB = phraseProgress[b.phraseId];
                    
                    const accuracyA = progressA ? (progressA.correct / progressA.attempts) : 0;
                    const accuracyB = progressB ? (progressB.correct / progressB.attempts) : 0;
                    
                    return accuracyA - accuracyB;
                });

                setQueue(sortedQueue);
            }, [scenario.id]);

            const handleCheckAnswer = () => {
                setShowAnswer(true);
            };

            const handleNext = (quality) => {
                const currentPhrase = queue[currentIndex];
                const similarity = calculateSimilarity(userAnswer, currentPhrase.answer);
                const correct = similarity >= 0.8;

                StorageManager.savePhraseProgress(currentPhrase.phraseId, {
                    correct,
                    similarity,
                    phrase: currentPhrase.answer,
                    translation: currentPhrase.translation,
                    scenario: scenario.id
                });

                setUserAnswer('');
                setShowAnswer(false);
                setCurrentIndex((prev) => (prev + 1) % queue.length);
            };

            const calculateSimilarity = (answer, correct) => {
                const a = answer.toLowerCase().trim().replace(/\s+/g, ' ');
                const c = correct.toLowerCase().trim().replace(/\s+/g, ' ');
                
                if (a === c) return 1.0;
                
                const aWords = a.split(' ');
                const cWords = c.split(' ');
                const matches = aWords.filter(word => cWords.includes(word)).length;
                
                return matches / Math.max(aWords.length, cWords.length);
            };

            if (queue.length === 0) {
                return <div className="text-center py-12">Loading training queue...</div>;
            }

            const currentPhrase = queue[currentIndex];
            const phraseProgress = StorageManager.getPhrases()[currentPhrase.phraseId];
            const accuracy = phraseProgress ? (phraseProgress.correct / phraseProgress.attempts * 100) : 0;

            return (
                <div>
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-2xl font-bold text-gray-900">Spaced Repetition Training</h3>
                            <div className="text-sm text-gray-600">
                                Card {currentIndex + 1} of {queue.length}
                            </div>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                                className="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                                style={{ width: `${((currentIndex + 1) / queue.length) * 100}%` }}
                            />
                        </div>
                    </div>

                    {/* Flashcard */}
                    <div className="bg-white rounded-xl shadow-xl p-8 mb-6 border-2 border-gray-200">
                        {/* Progress Badge */}
                        {phraseProgress && (
                            <div className="mb-4">
                                <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                    accuracy >= 80 ? 'bg-green-100 text-green-700' :
                                    accuracy >= 60 ? 'bg-yellow-100 text-yellow-700' :
                                    'bg-red-100 text-red-700'
                                }`}>
                                    Accuracy: {Math.round(accuracy)}% ({phraseProgress.correct}/{phraseProgress.attempts})
                                </span>
                            </div>
                        )}

                        {/* Translation (Question) */}
                        <div className="mb-6">
                            <p className="text-gray-500 text-sm font-medium mb-2">Translate to Vietnamese:</p>
                            <p className="text-3xl font-bold text-gray-900 mb-2">{currentPhrase.translation}</p>
                            <div className="flex items-center space-x-2 mt-3">
                                <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                    {currentPhrase.category}
                                </span>
                                {currentPhrase.politeness === 'polite' && (
                                    <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                        polite form required
                                    </span>
                                )}
                            </div>
                        </div>

                        {/* Answer Input */}
                        <div className="mb-6">
                            <input
                                type="text"
                                value={userAnswer}
                                onChange={(e) => setUserAnswer(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter' && !showAnswer && userAnswer.trim()) {
                                        handleCheckAnswer();
                                    }
                                }}
                                disabled={showAnswer}
                                placeholder="Type your answer in Vietnamese..."
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                            />
                        </div>

                        {/* Answer Reveal */}
                        {showAnswer && (
                            <div className="bg-indigo-50 rounded-lg p-6 mb-6 animate-slide-in">
                                <p className="text-sm text-indigo-600 font-medium mb-2">Correct Answer:</p>
                                <p className="text-2xl font-bold text-indigo-900 mb-3">{currentPhrase.answer}</p>
                                <p className="text-gray-700 mb-2">
                                    <span className="font-medium">Notes:</span> {currentPhrase.notes}
                                </p>
                                {userAnswer && (
                                    <div className="mt-3 pt-3 border-t border-indigo-200">
                                        <p className="text-sm text-gray-600 mb-1">Your answer:</p>
                                        <p className="text-lg text-gray-900">{userAnswer}</p>
                                        {calculateSimilarity(userAnswer, currentPhrase.answer) >= 0.8 ? (
                                            <p className="text-green-600 font-medium mt-2">âœ… Excellent!</p>
                                        ) : (
                                            <p className="text-orange-600 font-medium mt-2">ðŸ“ Keep practicing!</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Action Buttons */}
                        <div className="flex space-x-3">
                            {!showAnswer ? (
                                <button
                                    onClick={handleCheckAnswer}
                                    disabled={!userAnswer.trim()}
                                    className={`flex-1 px-6 py-3 rounded-lg font-semibold transition ${
                                        userAnswer.trim()
                                            ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleNext}
                                    className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                                >
                                    Next Card â†’
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Queue Overview */}
                    <div className="bg-gray-100 rounded-lg p-4">
                        <p className="text-sm text-gray-600 mb-2">
                            <strong>Training Queue:</strong> This queue prioritizes phrases you've struggled with most.
                        </p>
                        <div className="flex flex-wrap gap-2">
                            {queue.map((phrase, idx) => {
                                const progress = StorageManager.getPhrases()[phrase.phraseId];
                                const acc = progress ? (progress.correct / progress.attempts * 100) : 0;
                                
                                return (
                                    <div
                                        key={phrase.phraseId}
                                        className={`px-3 py-1 rounded text-xs font-medium ${
                                            idx === currentIndex ? 'bg-indigo-600 text-white' :
                                            acc >= 80 ? 'bg-green-200 text-green-800' :
                                            acc >= 60 ? 'bg-yellow-200 text-yellow-800' :
                                            'bg-red-200 text-red-800'
                                        }`}
                                    >
                                        {idx + 1}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== REVIEW PAGE ====================
        
        function ReviewPage({ onBack }) {
            const weakPhrases = StorageManager.getWeakPhrases(15);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswer, setUserAnswer] = useState('');
            const [showAnswer, setShowAnswer] = useState(false);

            if (weakPhrases.length === 0) {
                return (
                    <div className="text-center py-12">
                        <div className="text-6xl mb-4">ðŸŽ‰</div>
                        <h3 className="text-2xl font-bold text-gray-900 mb-2">
                            No phrases need review!
                        </h3>
                        <p className="text-gray-600 mb-6">
                            You're doing great! Complete more scenarios to build your vocabulary.
                        </p>
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700"
                        >
                            Back to Home
                        </button>
                    </div>
                );
            }

            const currentPhrase = weakPhrases[currentIndex];
            const accuracy = currentPhrase.attempts > 0 ? (currentPhrase.correct / currentPhrase.attempts * 100) : 0;

            const handleCheckAnswer = () => {
                setShowAnswer(true);
            };

            const handleNext = () => {
                const similarity = calculateSimilarity(userAnswer, currentPhrase.phrase);
                const correct = similarity >= 0.8;

                StorageManager.savePhraseProgress(currentPhrase.id, {
                    correct,
                    similarity,
                    phrase: currentPhrase.phrase,
                    translation: currentPhrase.translation,
                    scenario: currentPhrase.scenario
                });

                setUserAnswer('');
                setShowAnswer(false);
                setCurrentIndex((prev) => (prev + 1) % weakPhrases.length);
            };

            const calculateSimilarity = (answer, correct) => {
                const a = answer.toLowerCase().trim().replace(/\s+/g, ' ');
                const c = correct.toLowerCase().trim().replace(/\s+/g, ' ');
                
                if (a === c) return 1.0;
                
                const aWords = a.split(' ');
                const cWords = c.split(' ');
                const matches = aWords.filter(word => cWords.includes(word)).length;
                
                return matches / Math.max(aWords.length, cWords.length);
            };

            return (
                <div>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-900">Micro-Drills Review</h2>
                                <p className="text-gray-600">Practice your weak points from all scenarios</p>
                            </div>
                            <button
                                onClick={onBack}
                                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                            >
                                â† Back
                            </button>
                        </div>
                    </div>

                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-semibold text-gray-900">
                                Randomized Weak Points ({weakPhrases.length} phrases)
                            </h3>
                            <div className="text-sm text-gray-600">
                                Card {currentIndex + 1} of {weakPhrases.length}
                            </div>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                                className="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                                style={{ width: `${((currentIndex + 1) / weakPhrases.length) * 100}%` }}
                            />
                        </div>
                    </div>

                    {/* Flashcard */}
                    <div className="bg-white rounded-xl shadow-xl p-8 border-2 border-orange-200">
                        {/* Metadata */}
                        <div className="mb-4 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold">
                                    Needs Practice
                                </span>
                                <span className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">
                                    from {currentPhrase.scenario}
                                </span>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                accuracy >= 70 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                            }`}>
                                {Math.round(accuracy)}% accuracy
                            </span>
                        </div>

                        {/* Question */}
                        <div className="mb-6">
                            <p className="text-gray-500 text-sm font-medium mb-2">Translate to Vietnamese:</p>
                            <p className="text-3xl font-bold text-gray-900">{currentPhrase.translation}</p>
                        </div>

                        {/* Answer Input */}
                        <div className="mb-6">
                            <input
                                type="text"
                                value={userAnswer}
                                onChange={(e) => setUserAnswer(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter' && !showAnswer && userAnswer.trim()) {
                                        handleCheckAnswer();
                                    }
                                }}
                                disabled={showAnswer}
                                placeholder="Type your answer..."
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                            />
                        </div>

                        {/* Answer Reveal */}
                        {showAnswer && (
                            <div className="bg-green-50 rounded-lg p-6 mb-6 animate-slide-in">
                                <p className="text-sm text-green-600 font-medium mb-2">Correct Answer:</p>
                                <p className="text-2xl font-bold text-green-900 mb-3">{currentPhrase.phrase}</p>
                                {userAnswer && (
                                    <div className="mt-3 pt-3 border-t border-green-200">
                                        <p className="text-sm text-gray-600 mb-1">Your answer:</p>
                                        <p className="text-lg text-gray-900">{userAnswer}</p>
                                        {calculateSimilarity(userAnswer, currentPhrase.phrase) >= 0.8 ? (
                                            <p className="text-green-600 font-medium mt-2">âœ… Great job!</p>
                                        ) : (
                                            <p className="text-orange-600 font-medium mt-2">ðŸ“ Review and try again!</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Actions */}
                        <div className="flex space-x-3">
                            {!showAnswer ? (
                                <button
                                    onClick={handleCheckAnswer}
                                    disabled={!userAnswer.trim()}
                                    className={`flex-1 px-6 py-3 rounded-lg font-semibold transition ${
                                        userAnswer.trim()
                                            ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Check Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleNext}
                                    className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
                                >
                                    Next Card â†’
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== DASHBOARD PAGE ====================
        
        function DashboardPage({ stats, onBack }) {
            const phrases = StorageManager.getPhrases();
            const totalPhrases = Object.keys(phrases).length;
            const mastered = Object.values(phrases).filter(p => p.repetitions >= 3).length;
            const learning = totalPhrases - mastered;

            return (
                <div>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-900">Weekly Dashboard</h2>
                                <p className="text-gray-600">Your learning progress this week</p>
                            </div>
                            <button
                                onClick={onBack}
                                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                            >
                                â† Back
                            </button>
                        </div>
                    </div>

                    {/* Key Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-blue-100 text-sm font-medium mb-2">Scenarios Completed</p>
                            <p className="text-5xl font-bold mb-2">{stats.scenariosCompleted}</p>
                            <p className="text-blue-100 text-sm">this week</p>
                        </div>

                        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-green-100 text-sm font-medium mb-2">Avg Response Time</p>
                            <p className="text-5xl font-bold mb-2">{stats.avgResponseTime}s</p>
                            <p className="text-green-100 text-sm">per phrase</p>
                        </div>

                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-purple-100 text-sm font-medium mb-2">Politeness Accuracy</p>
                            <p className="text-5xl font-bold mb-2">{stats.politenessAccuracy}%</p>
                            <p className="text-purple-100 text-sm">formal expressions</p>
                        </div>

                        <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                            <p className="text-orange-100 text-sm font-medium mb-2">Recovery Score</p>
                            <p className="text-5xl font-bold mb-2">{stats.recoveryScore || 0}</p>
                            <p className="text-orange-100 text-sm">from mistakes</p>
                        </div>
                    </div>

                    {/* Progress Overview */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold text-gray-900 mb-4">Learning Progress</h3>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-gray-700">Mastered</span>
                                        <span className="text-sm font-bold text-green-600">{mastered} phrases</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                            className="bg-green-500 h-3 rounded-full transition-all duration-500"
                                            style={{ width: `${totalPhrases > 0 ? (mastered / totalPhrases * 100) : 0}%` }}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-gray-700">Learning</span>
                                        <span className="text-sm font-bold text-orange-600">{learning} phrases</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                            className="bg-orange-500 h-3 rounded-full transition-all duration-500"
                                            style={{ width: `${totalPhrases > 0 ? (learning / totalPhrases * 100) : 0}%` }}
                                        />
                                    </div>
                                </div>

                                <div className="pt-4 border-t border-gray-200">
                                    <div className="flex items-center justify-between">
                                        <span className="text-sm font-medium text-gray-700">Total Vocabulary</span>
                                        <span className="text-2xl font-bold text-indigo-600">{totalPhrases}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold text-gray-900 mb-4">Weekly Goals</h3>
                            <div className="space-y-4">
                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        stats.scenariosCompleted >= 5 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {stats.scenariosCompleted >= 5 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">Complete 5 scenarios</p>
                                        <p className="text-sm text-gray-600">{stats.scenariosCompleted}/5 done</p>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        stats.politenessAccuracy >= 90 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {stats.politenessAccuracy >= 90 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">90% politeness accuracy</p>
                                        <p className="text-sm text-gray-600">{stats.politenessAccuracy}% achieved</p>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        stats.avgResponseTime <= 8 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {stats.avgResponseTime <= 8 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">Response time under 8s</p>
                                        <p className="text-sm text-gray-600">{stats.avgResponseTime}s average</p>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                        mastered >= 20 ? 'bg-green-500' : 'bg-gray-300'
                                    }`}>
                                        {mastered >= 20 ? 'âœ“' : 'â—‹'}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-medium text-gray-900">Master 20 phrases</p>
                                        <p className="text-sm text-gray-600">{mastered}/20 mastered</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Insights */}
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-xl p-8 text-white">
                        <h3 className="text-2xl font-bold mb-4">ðŸ’¡ Weekly Insights</h3>
                        <div className="space-y-3">
                            {stats.scenariosCompleted >= 5 && (
                                <p className="text-indigo-100">
                                    ðŸŽ‰ Great work this week! You've completed {stats.scenariosCompleted} scenarios.
                                </p>
                            )}
                            {stats.politenessAccuracy >= 85 && (
                                <p className="text-indigo-100">
                                    ðŸ‘” Excellent politeness awareness! You're using formal Vietnamese naturally.
                                </p>
                            )}
                            {stats.avgResponseTime <= 10 && (
                                <p className="text-indigo-100">
                                    âš¡ Your response time is improving! Phrases are becoming more automatic.
                                </p>
                            )}
                            {mastered >= 15 && (
                                <p className="text-indigo-100">
                                    ðŸ† You've mastered {mastered} phrases! Keep up the momentum.
                                </p>
                            )}
                            {stats.scenariosCompleted < 3 && (
                                <p className="text-indigo-100">
                                    ðŸ“š Try to complete at least 3 scenarios this week for better progress.
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== RENDER APP ====================
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
